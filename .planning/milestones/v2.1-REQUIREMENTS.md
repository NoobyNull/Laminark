# Requirements Archive: v2.1 Agent SDK Migration

**Archived:** 2026-02-14
**Status:** SHIPPED

For current requirements, see `.planning/REQUIREMENTS.md`.

---

# Requirements

**Project:** Laminark — Claude Code Persistent Adaptive Memory & Tool Intelligence Plugin
**Core Value:** You never lose context. Every thread is recoverable, every thought is findable. Claude always knows which tools are available and when to use them.

## v1.0 Requirements (Complete)

### Memory Core

- [x] **MEM-01**: User's observations persist across Claude Code sessions in a single SQLite database file with WAL mode
- [x] **MEM-02**: Observations are automatically captured via PostToolUse hook without user intervention
- [x] **MEM-03**: Session lifecycle is tracked via SessionStart and SessionEnd hooks with unique session IDs
- [x] **MEM-04**: User can manually save a memory with explicit text via MCP save_memory tool
- [x] **MEM-05**: User can delete specific memories via MCP forget tool (soft delete with recovery option)
- [x] **MEM-06**: All observations are scoped to the project directory — no cross-project contamination
- [x] **MEM-07**: Multiple concurrent Claude Code sessions can read/write safely without corruption or data loss
- [x] **MEM-08**: Database uses write-ahead journaling for crash recovery — incomplete writes never corrupt data
- [x] **MEM-09**: Schema stores original text alongside embeddings with model version metadata for future migration
- [x] **MEM-10**: Observation admission filters prevent storing low-signal noise (build logs, large file reads) — only meaningful content is retained

### Search

- [x] **SRC-01**: User can search memories by keyword via FTS5 full-text search returning ranked results
- [x] **SRC-02**: User can search memories by semantic meaning via vector similarity using sqlite-vec
- [x] **SRC-03**: Hybrid search combines FTS5 keyword and vector semantic scores using reciprocal rank fusion
- [x] **SRC-04**: Search uses 3-layer progressive disclosure: compact index (~50-100 tokens/result) -> timeline context -> full observation details
- [x] **SRC-05**: Search results respect project scoping and never leak observations from other projects
- [x] **SRC-06**: MCP search tool response stays under 2000 tokens to prevent context window poisoning

### Context Management

- [x] **CTX-01**: On SessionStart, Claude receives a progressive disclosure index of recent context (last session summary + high-value observations) within 2 seconds
- [x] **CTX-02**: Session summaries are generated at Stop hook by compressing session observations into concise summaries
- [x] **CTX-03**: When adaptive topic shift is detected, current context thread is silently stashed (snapshot of topic observations + summary)
- [x] **CTX-04**: User is notified when context has been stashed with a message indicating they can return to it
- [x] **CTX-05**: User can resume a stashed context thread via /laminark:resume slash command, re-injecting the saved context
- [x] **CTX-06**: User can query "where was I?" to surface recently abandoned context threads ranked by recency and relevance

### Intelligence

- [x] **INT-01**: Embeddings are generated using pluggable strategy interface with local ONNX as default (all-MiniLM-L6-v2 or BGE Small EN v1.5)
- [x] **INT-02**: Claude piggyback embedding strategy extracts semantic features during Claude's response generation window at zero added latency
- [x] **INT-03**: Hybrid embedding strategy uses local ONNX for speed with Claude piggyback for quality, selectable at startup
- [x] **INT-04**: All embedding computation and analysis runs in a worker thread — never blocks MCP tool responses or Claude's output
- [x] **INT-05**: Topic shift detection uses cosine distance between consecutive observation embeddings with a static threshold as baseline
- [x] **INT-06**: Adaptive threshold learning via EWMA adjusts per-user, per-session based on the user's natural topic variance
- [x] **INT-07**: Adaptive threshold seeds new sessions with historical averages from previous sessions to handle cold start
- [x] **INT-08**: Sensitivity multiplier is user-configurable as a dial between "sensitive" and "relaxed" with manual override always available
- [x] **INT-09**: Entity extraction identifies typed entities from observations: Project, File, Decision, Problem, Solution, Tool, Person
- [x] **INT-10**: Relationship detection identifies typed relations between entities: uses, depends_on, decided_by, related_to, part_of, caused_by, solved_by
- [x] **INT-11**: Knowledge graph stores entities as nodes and relationships as edges in SQLite with graph traversal query support
- [x] **INT-12**: Knowledge graph enforces entity type taxonomy and max node degree (50 edges) to prevent unqueryable hairball growth
- [x] **INT-13**: Temporal awareness tracks when observations were created and detects staleness when newer observations contradict older ones

### Visualization

- [x] **VIS-01**: Local web server on localhost serves the visualization UI accessible from any browser
- [x] **VIS-02**: Interactive knowledge graph view renders entities as nodes and relationships as edges using force-directed layout (Cytoscape)
- [x] **VIS-03**: User can click graph nodes to see associated observations, filter by entity type, and zoom to time ranges
- [x] **VIS-04**: Timeline view shows chronological flow of sessions, observations, and topic shift points
- [x] **VIS-05**: Web UI receives live updates via Server-Sent Events as new observations are processed
- [x] **VIS-06**: Graph visualization handles up to 500+ nodes with viewport culling for performance

### User Interface

- [x] **UI-01**: 5-7 MCP tools exposed to Claude: search, timeline, get_observations, save_memory, forget, graph_query, topic_context
- [x] **UI-02**: /laminark:remember slash command allows user to explicitly save a memory with context
- [x] **UI-03**: /laminark:recall slash command allows user to search memories by description
- [x] **UI-04**: /laminark:stash slash command allows user to manually stash current context thread
- [x] **UI-05**: /laminark:resume slash command allows user to resume a previously stashed context thread

### Data Quality

- [x] **DQ-01**: Curation agent runs during quiet periods (session end, long pauses) to merge similar observations and generate consolidated summaries
- [x] **DQ-02**: Privacy controls allow excluding sensitive content patterns (like .env file contents) from observation capture
- [x] **DQ-03**: Embedding engine gracefully degrades — if ONNX model unavailable, system falls back to FTS5 keyword-only search
- [x] **DQ-04**: Plugin startup adds zero perceptible latency — ONNX model loads lazily on first observation, not at process start
- [x] **DQ-05**: All topic shift decisions are logged with inputs for debugging and threshold tuning

## v2.0 Requirements

Requirements for Global Tool Intelligence milestone. Each maps to roadmap phases starting at Phase 9.

### Global Installation

- [ ] **GLOB-01**: Laminark is available in every Claude Code session without per-project configuration
- [ ] **GLOB-02**: Laminark detects and registers the current project automatically on session start
- [ ] **GLOB-03**: Plugin manifest (plugin.json) with correct MCP server, hooks, and skills configuration
- [ ] **GLOB-04**: Self-referential filter handles both project-scoped and plugin-scoped MCP prefixes
- [ ] **GLOB-05**: Installation works via `claude plugin install` from npm package

### Tool Discovery

- [ ] **DISC-01**: Laminark discovers MCP servers from project `.mcp.json` and user `~/.claude.json` on session start
- [ ] **DISC-02**: Laminark discovers slash commands from `.claude/commands/` and `~/.claude/commands/`
- [ ] **DISC-03**: Laminark discovers skills from `.claude/skills/` and `~/.claude/skills/`
- [ ] **DISC-04**: Laminark discovers installed plugins from `~/.claude/plugins/installed_plugins.json`
- [ ] **DISC-05**: Laminark records tool usage organically from PostToolUse hook events
- [ ] **DISC-06**: Discovery results are stored in a `tool_registry` table with scope metadata

### Scope Resolution

- [ ] **SCOP-01**: Tool registry distinguishes global, project, and plugin scopes
- [ ] **SCOP-02**: Session start context only surfaces tools available in the current scope
- [ ] **SCOP-03**: Project-scoped tools from project A are never suggested in project B
- [ ] **SCOP-04**: Scope resolution uses tool_name prefix parsing (bare = built-in, `mcp__` = MCP, `mcp__plugin_` = plugin)

### Usage Tracking

- [ ] **UTRK-01**: PostToolUse handler increments usage count and last_used_at in tool registry
- [ ] **UTRK-02**: Tool usage context is recorded with session and project association
- [ ] **UTRK-03**: Usage data persists across sessions for routing intelligence

### Context Enhancement

- [ ] **CTXT-01**: Session start injection includes an "Available Tools" section with top relevant tools
- [ ] **CTXT-02**: Tool suggestions fit within a 500-character sub-budget of the existing 6000-char context limit
- [ ] **CTXT-03**: Tool suggestions are ranked by relevance (usage frequency + recency)

### Conversation Routing

- [ ] **ROUT-01**: Laminark detects conversation intent patterns that match historical tool usage contexts
- [ ] **ROUT-02**: Tool suggestions are delivered via existing notification mechanism (not auto-invocation)
- [ ] **ROUT-03**: Routing includes confidence threshold — no suggestion when uncertain
- [ ] **ROUT-04**: Heuristic fallback routing works without accumulated usage data (cold start)

### Tool Search

- [ ] **SRCH-01**: New `discover_tools` MCP tool allows querying the registry by keyword and scope
- [ ] **SRCH-02**: Tool descriptions are indexed for semantic search using existing hybrid search infrastructure
- [ ] **SRCH-03**: Search results include scope, usage count, and last used timestamp

### Staleness Management

- [ ] **STAL-01**: Config rescan on session start detects removed tools and marks them stale
- [ ] **STAL-02**: Tools not seen in 30+ days are deprioritized in suggestions
- [ ] **STAL-03**: PostToolUseFailure events deprioritize failing tools

## Future Requirements (v3.0+)

Deferred. Tracked but not in current roadmap.

### Cross-Project Intelligence

- **XPRJ-01**: Surface tool usage patterns from similar projects to new projects
- **XPRJ-02**: Recommend tools for new projects based on project similarity (dependencies, language)
- **XPRJ-03**: Cross-project intelligence surfaces tool names and patterns only — never observation content

### Tool Workflow Chains

- **WKFL-01**: Observe and store tool invocation sequences within sessions
- **WKFL-02**: Identify common tool sequences (plan -> implement -> test) via pattern mining
- **WKFL-03**: Suggest next step in a workflow after completing a step

### v1.0 Deferred (Still Deferred)

- Proactive context re-surfacing — notify user when current discussion is semantically similar to a stashed topic
- Conflict detection and flagging — surface contradictions between observations
- Export/import for migration — allow moving memory database between machines
- Advanced graph maintenance — automated deduplication, synonym merging, background pruning
- Multi-strategy curation — use Claude API for high-quality summarization when configured

## Out of Scope

Explicitly excluded. Documented to prevent scope creep.

| Feature | Reason |
|---------|--------|
| Automatic tool installation | Security risk — user must explicitly approve MCP server additions |
| Tool execution proxy | Laminark is intelligence layer, not execution engine — MCP tools have own execution paths |
| Real-time MCP server health monitoring | MCP servers can't communicate with each other — track failures reactively |
| Natural language tool creation | Code generation is Claude's job — Laminark detects gaps and suggests creation |
| Multi-user tool sharing | Claude Code already handles team sharing via project-scoped .mcp.json in git |
| Universal tool abstraction layer | Different tool types have fundamentally different invocation patterns |
| Enterprise managed-MCP handling | Complex enterprise config deferred — focus on developer workflow first |
| Cloud sync / multi-device | Local-first, single machine |
| Mobile app | Web UI on localhost is sufficient |
| Integration with non-Claude AI tools | Optimized for Claude Code plugin lifecycle |

## Traceability

### v1.0 (Complete)

| REQ-ID | Phase | Status |
|--------|-------|--------|
| MEM-01 through MEM-10 | Phases 1-3 | Done |
| SRC-01 through SRC-06 | Phases 2, 4 | Done |
| CTX-01 through CTX-06 | Phases 5-6 | Done |
| INT-01 through INT-13 | Phases 4, 6-7 | Done |
| VIS-01 through VIS-06 | Phase 8 | Done |
| UI-01 through UI-05 | Phases 2, 5-6 | Done |
| DQ-01 through DQ-05 | Phases 3-4, 6-7 | Done |

### v2.0

| REQ-ID | Phase | Status |
|--------|-------|--------|
| GLOB-01 | Phase 9 | Pending |
| GLOB-02 | Phase 9 | Pending |
| GLOB-03 | Phase 9 | Pending |
| GLOB-04 | Phase 9 | Pending |
| GLOB-05 | Phase 9 | Pending |
| DISC-01 | Phase 10 | Pending |
| DISC-02 | Phase 10 | Pending |
| DISC-03 | Phase 10 | Pending |
| DISC-04 | Phase 10 | Pending |
| DISC-05 | Phase 10 | Pending |
| DISC-06 | Phase 10 | Pending |
| SCOP-01 | Phase 11 | Pending |
| SCOP-02 | Phase 11 | Pending |
| SCOP-03 | Phase 11 | Pending |
| SCOP-04 | Phase 11 | Pending |
| UTRK-01 | Phase 12 | Pending |
| UTRK-02 | Phase 12 | Pending |
| UTRK-03 | Phase 12 | Pending |
| CTXT-01 | Phase 13 | Pending |
| CTXT-02 | Phase 13 | Pending |
| CTXT-03 | Phase 13 | Pending |
| ROUT-01 | Phase 14 | Pending |
| ROUT-02 | Phase 14 | Pending |
| ROUT-03 | Phase 14 | Pending |
| ROUT-04 | Phase 14 | Pending |
| SRCH-01 | Phase 15 | Pending |
| SRCH-02 | Phase 15 | Pending |
| SRCH-03 | Phase 15 | Pending |
| STAL-01 | Phase 16 | Pending |
| STAL-02 | Phase 16 | Pending |
| STAL-03 | Phase 16 | Pending |

**Coverage:**
- v1.0 requirements: 49 total -- all Done
- v2.0 requirements: 31 total
- Mapped to phases: 31/31
- Unmapped: 0

---
*Requirements defined: 2026-02-08 (v1.0), 2026-02-10 (v2.0)*
*Last updated: 2026-02-10 after v2.0 roadmap creation*
