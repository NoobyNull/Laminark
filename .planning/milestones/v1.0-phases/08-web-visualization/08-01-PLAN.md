---
phase: 08-web-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/web/server.ts
  - src/web/routes/api.ts
  - src/web/routes/sse.ts
  - ui/index.html
  - ui/styles.css
  - ui/app.js
autonomous: true

must_haves:
  truths:
    - "User opens http://localhost:37820 in a browser and sees the Laminark visualization shell"
    - "REST API returns graph data (nodes + edges) and timeline data (sessions + observations) as JSON"
    - "SSE endpoint at /api/sse accepts connections and keeps them alive with heartbeat"
  artifacts:
    - path: "src/web/server.ts"
      provides: "Hono web server with static serving and route registration"
      exports: ["createWebServer", "startWebServer"]
    - path: "src/web/routes/api.ts"
      provides: "REST endpoints for graph and timeline data"
      exports: ["apiRoutes"]
    - path: "src/web/routes/sse.ts"
      provides: "SSE endpoint with client management and broadcast"
      exports: ["sseRoutes", "broadcast"]
    - path: "ui/index.html"
      provides: "SPA shell with navigation between graph and timeline views"
      min_lines: 40
    - path: "ui/styles.css"
      provides: "Base styles for layout, navigation, panels"
      min_lines: 50
    - path: "ui/app.js"
      provides: "Client-side routing and SSE connection"
      min_lines: 30
  key_links:
    - from: "src/web/server.ts"
      to: "src/web/routes/api.ts"
      via: "Hono route mounting"
      pattern: "app\\.route.*api"
    - from: "src/web/server.ts"
      to: "ui/"
      via: "Hono serveStatic middleware"
      pattern: "serveStatic"
    - from: "ui/app.js"
      to: "/api/sse"
      via: "EventSource connection"
      pattern: "new EventSource"
---

<objective>
Set up the Hono web server that serves the visualization SPA and provides REST API endpoints for graph/timeline data plus an SSE endpoint for live updates.

Purpose: This is the foundation for all visualization. Without a working web server serving static assets and providing data APIs, no UI can render. The SSE infrastructure enables live updates in later plans.
Output: A running localhost web server at port 37820 that serves an HTML shell with navigation, provides JSON data endpoints, and maintains SSE connections.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK.md
@.planning/research/ARCHITECTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Hono web server with static asset serving</name>
  <files>src/web/server.ts, ui/index.html, ui/styles.css</files>
  <action>
Create the Hono web server in src/web/server.ts:
- Import hono ^4.11 and @hono/node-server
- Create a Hono app instance
- Configure static file serving from the ui/ directory using hono/serve-static (NOT the @hono/node-server serve-static -- use the serveStatic from 'hono/serve-static' with a getContent handler that reads from filesystem using Node.js fs)
- Note: For Node.js, use `import { serveStatic } from '@hono/node-server/serve-static'` which handles filesystem reads automatically
- Export `createWebServer(db: Database)` that accepts a better-sqlite3 Database instance and returns the configured Hono app
- Export `startWebServer(app: Hono, port?: number)` that starts the server on the given port (default 37820) using @hono/node-server's `serve()` function
- Add CORS middleware allowing localhost origins (for development)
- Add a health check endpoint at GET /api/health returning `{ status: "ok", timestamp: Date.now() }`

Create ui/index.html as the SPA shell:
- Single HTML5 page with a nav bar containing two tabs: "Knowledge Graph" and "Timeline"
- Main content area with two div containers: `#graph-view` (visible by default) and `#timeline-view` (hidden)
- Include Cytoscape.js via a local script tag (will be installed as dependency and served from node_modules or bundled into ui/)
- For now, use CDN fallback: `<script src="https://unpkg.com/cytoscape@3.33/dist/cytoscape.min.js"></script>` with a local path as primary
- Include `<script src="/styles.css">` -- no, include `<link rel="stylesheet" href="/styles.css">` and `<script src="/app.js"></script>`
- Add a side panel div `#detail-panel` (initially hidden) for showing node details when clicked
- Add a filter bar div `#filter-bar` above the graph view for entity type filters

Create ui/styles.css with base layout:
- CSS custom properties for colors: --bg: #0d1117, --surface: #161b22, --border: #30363d, --text: #c9d1d9, --accent: #58a6ff (GitHub-dark inspired palette)
- Full viewport layout using CSS Grid: nav on top, main content fills remaining space
- Nav bar: horizontal tab layout, active tab indicator
- Graph view: fills entire main area
- Timeline view: fills entire main area, scrollable vertically
- Detail panel: fixed right sidebar (300px wide), slides in from right when visible
- Filter bar: horizontal bar above graph with pill-shaped filter buttons
- Responsive: on viewports under 768px, detail panel becomes bottom sheet
  </action>
  <verify>
Run `npx tsx src/web/server.ts` (or a small test script that imports and starts the server). Open http://localhost:37820 in a browser. Verify:
1. HTML page loads with nav bar showing "Knowledge Graph" and "Timeline" tabs
2. CSS styles applied (dark theme background visible)
3. GET /api/health returns JSON with status "ok"
  </verify>
  <done>Hono server starts on port 37820, serves the HTML shell with navigation and dark theme styling, and /api/health returns 200.</done>
</task>

<task type="auto">
  <name>Task 2: Create REST API routes and SSE endpoint</name>
  <files>src/web/routes/api.ts, src/web/routes/sse.ts, ui/app.js</files>
  <action>
Create src/web/routes/api.ts with REST data endpoints:
- GET /api/graph -- returns the knowledge graph as JSON: `{ nodes: Array<{ id, label, type, observationCount, createdAt }>, edges: Array<{ id, source, target, type, label }> }`. Query the entities and relationships tables from the database. Accept optional query params: `?type=File,Decision` to filter by entity type, `?since=ISO8601` to filter by time range. If no data exists yet, return empty arrays (not an error).
- GET /api/timeline -- returns timeline data as JSON: `{ sessions: Array<{ id, startedAt, endedAt, observationCount, summary }>, observations: Array<{ id, text, createdAt, sessionId, type }>, topicShifts: Array<{ id, fromTopic, toTopic, timestamp, confidence }> }`. Accept `?from=ISO8601&to=ISO8601` for time range filtering. Limit to 500 most recent observations by default, accept `?limit=N`.
- GET /api/node/:id -- returns details for a single entity node: `{ entity: { id, label, type, createdAt }, observations: Array<{ id, text, createdAt }>, relationships: Array<{ id, targetId, targetLabel, type }> }`. This powers the detail panel when a user clicks a graph node.
- All endpoints receive the `db` instance via Hono's context (set it in server.ts middleware using `c.set('db', db)`)

Create src/web/routes/sse.ts with SSE endpoint:
- GET /api/sse -- Server-Sent Events endpoint
- Maintain a Set of active SSE clients (writable streams)
- On connection: add client to set, send an initial `event: connected` with `data: { timestamp }`, set up heartbeat ping every 30 seconds with `event: heartbeat`
- On disconnect: remove client from set, clear heartbeat interval
- Export `broadcast(event: string, data: object)` function that serializes data as JSON and writes to all connected clients as `event: {event}\ndata: {json}\n\n`
- Event types to support: `new_observation`, `topic_shift`, `entity_updated`, `session_start`, `session_end`
- Set appropriate headers: Content-Type: text/event-stream, Cache-Control: no-cache, Connection: keep-alive

Create ui/app.js with client-side application logic:
- Tab switching: clicking nav tabs toggles visibility of #graph-view and #timeline-view, updates active tab styling
- SSE connection: create EventSource to /api/sse on page load. Handle events: connected (log), heartbeat (update last-seen timestamp), new_observation/entity_updated (dispatch custom DOM events that graph and timeline modules will listen to)
- Auto-reconnect: if EventSource closes, retry after 3 seconds with exponential backoff (max 30s)
- Export helper functions: `fetchGraphData(filters?)`, `fetchTimelineData(range?)`, `fetchNodeDetails(id)` that wrap fetch() calls to the REST API with error handling
- On page load: fetch initial graph and timeline data, store in a global state object `window.laminarkState = { graph: null, timeline: null }`
  </action>
  <verify>
1. Start the server and run `curl http://localhost:37820/api/graph` -- should return JSON with nodes and edges arrays (may be empty)
2. Run `curl http://localhost:37820/api/timeline` -- should return JSON with sessions, observations, topicShifts arrays
3. Run `curl -N http://localhost:37820/api/sse` -- should receive `event: connected` message and periodic heartbeats
4. Open http://localhost:37820 in browser, check browser console for "SSE connected" log and no errors. Click tabs to verify navigation works.
  </verify>
  <done>REST API serves graph and timeline data from the database. SSE endpoint accepts connections, sends heartbeats, and has a broadcast function for pushing updates. Client-side app.js handles tab navigation, SSE connection with auto-reconnect, and fetches initial data on load.</done>
</task>

</tasks>

<verification>
- `curl http://localhost:37820/api/health` returns `{"status":"ok",...}`
- `curl http://localhost:37820/api/graph` returns valid JSON with nodes/edges structure
- `curl http://localhost:37820/api/timeline` returns valid JSON with sessions/observations structure
- `curl -N http://localhost:37820/api/sse` streams SSE events (connected + heartbeat)
- Browser loads http://localhost:37820 showing styled dark-theme UI with tab navigation
- Tab switching toggles between graph and timeline views
- Browser console shows SSE connection established
</verification>

<success_criteria>
Hono web server runs on localhost:37820, serves the SPA shell with dark theme and tab navigation, provides REST API endpoints returning graph/timeline data from SQLite, and maintains SSE connections with heartbeat for live update infrastructure.
</success_criteria>

<output>
After completion, create `.planning/phases/08-web-visualization/08-01-SUMMARY.md`
</output>
