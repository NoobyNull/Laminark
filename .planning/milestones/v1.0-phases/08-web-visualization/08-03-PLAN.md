---
phase: 08-web-visualization
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - ui/graph.js
  - ui/app.js
  - ui/styles.css
  - ui/index.html
  - src/web/routes/api.ts
autonomous: false

must_haves:
  truths:
    - "User can click a graph node and see its associated observations in a detail panel"
    - "User can filter nodes by entity type using toggle buttons in the filter bar"
    - "User can select a time range and the graph shows only entities from that period"
  artifacts:
    - path: "ui/graph.js"
      provides: "Click handler dispatching node selection, filter/time-range methods"
      contains: "addEventListener.*click|on.*tap"
    - path: "ui/styles.css"
      provides: "Detail panel slide-in animation, filter pill active states, time range slider styling"
      contains: "detail-panel|filter-bar"
  key_links:
    - from: "ui/graph.js"
      to: "/api/node/"
      via: "fetch on node click to load observation details"
      pattern: "fetch.*api/node"
    - from: "ui/graph.js"
      to: "ui/app.js"
      via: "filter state management and graph re-rendering"
      pattern: "filterByType|filterByTimeRange"
---

<objective>
Add graph interaction: node click to show observation details in a side panel, entity type filtering via toggle buttons, and time range zoom via a date range selector.

Purpose: This delivers VIS-03 -- the graph is not just for looking at but for exploring. Users need to drill into nodes to see the underlying observations, filter noise by hiding entity types they are not interested in, and focus on specific time periods.
Output: A fully interactive graph where clicking shows details, filters narrow the view, and time range controls the visible data window.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/STACK.md
@.planning/phases/08-web-visualization/08-01-SUMMARY.md
@.planning/phases/08-web-visualization/08-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Node click detail panel and entity type filtering</name>
  <files>ui/graph.js, ui/index.html, ui/styles.css, src/web/routes/api.ts</files>
  <action>
**Node click detail panel:**

In ui/graph.js, add a Cytoscape `tap` event handler on nodes:
- `cy.on('tap', 'node', async (evt) => { ... })`
- On tap: get `evt.target.data()` for the clicked node's id, label, type
- Fetch observation details from `/api/node/${nodeId}` (already created in Plan 01)
- Populate the `#detail-panel` with:
  - Header: entity label + type badge (colored pill matching entity type color)
  - Created date in human-readable format
  - "Observations" section: scrollable list of observation texts with timestamps, most recent first
  - "Relationships" section: list of connected entities with type labels, each clickable to navigate to that node
- Show the detail panel by adding class `visible` to `#detail-panel`
- Highlight the selected node in the graph (add 'selected' class via `cy.$(':selected').unselect(); evt.target.select()`)
- When clicking on a relationship link in the detail panel, select and center that node: `cy.getElementById(targetId).select(); cy.animate({ center: { eles: cy.getElementById(targetId) }, duration: 300 })`
- Add close button (X) in detail panel header that hides the panel and deselects nodes

On background tap (`cy.on('tap', (evt) => { if (evt.target === cy) { hideDetailPanel(); } })`), hide detail panel and deselect all.

**Entity type filter bar:**

In ui/index.html, the `#filter-bar` div already exists. Populate it with filter buttons:
- One pill button per entity type: Project, File, Decision, Problem, Solution, Tool, Person
- Each pill shows the entity type color dot + name + count of visible nodes of that type
- All filters start as "active" (all types visible)
- Add an "All" button to reset all filters

In ui/graph.js, implement filtering:
- Maintain a `Set<string>` of active entity types (all 7 initially)
- `filterByType(type)` toggles the type in the active set
- When filter changes: iterate all nodes, hide nodes whose type is not in the active set using `node.hide()`, show nodes whose type is in the active set using `node.show()`
- Also hide edges where both source and target are hidden
- Update pill button styling: active = filled background with type color, inactive = outlined/dimmed
- Update count badges on each pill after filtering
- After filter change, run `cy.fit(cy.elements(':visible'), 50)` to re-fit visible elements

In ui/styles.css:
- #detail-panel: transform translateX(100%) when hidden, translateX(0) when .visible, transition 0.2s ease
- #detail-panel .observation-item: padding 12px, border-bottom 1px solid var(--border), font-size 13px
- #detail-panel .relationship-item: clickable, hover underline, flex row with type badge
- .filter-pill: display inline-flex, align-items center, gap 6px, padding 4px 12px, border-radius 16px, cursor pointer, font-size 12px, border 1px solid var(--border), transition background 0.15s
- .filter-pill.active: background-color set to entity type color at 20% opacity, border-color set to entity type color
- .filter-pill .color-dot: 8px circle, background-color from entity type
- .filter-pill .count: muted color, font-size 11px
  </action>
  <verify>
1. Open graph view, click a node -- detail panel slides in from right showing entity info and observations
2. Click the X button or click background -- detail panel hides
3. Click a relationship in the detail panel -- graph centers on that connected node
4. Toggle a filter pill off (e.g., "File") -- all File nodes disappear from graph
5. Toggle it back on -- File nodes reappear
6. Click "All" -- all types visible again
7. Filter counts update correctly
  </verify>
  <done>Node clicks open a detail panel showing observations and relationships. Entity type pills filter the graph by showing/hiding node types. Detail panel relationship links navigate the graph.</done>
</task>

<task type="auto">
  <name>Task 2: Time range zoom control</name>
  <files>ui/graph.js, ui/index.html, ui/styles.css</files>
  <action>
**Time range selector:**

Add a time range control to the filter bar in ui/index.html:
- A horizontal container with: a "From" date input, a "To" date input, and preset buttons: "Last hour", "Today", "This week", "This month", "All time"
- Use native HTML `<input type="datetime-local">` for the date inputs (no external datepicker library needed)
- Add a "Zoom to range" button that applies the selected range

In ui/graph.js, implement time-range filtering:
- `filterByTimeRange(from?: Date, to?: Date)` method
- When a time range is set: hide nodes whose `createdAt` falls outside the range, show nodes within the range
- Combine with entity type filtering: a node is visible only if its type is active AND its createdAt is within the time range
- The preset buttons calculate from/to dates relative to now:
  - "Last hour": from = now - 1h, to = now
  - "Today": from = start of today, to = now
  - "This week": from = start of this week (Monday), to = now
  - "This month": from = start of this month, to = now
  - "All time": from = null, to = null (no time filter)
- When time range changes, also re-fetch graph data from the API with `?since=` parameter for server-side filtering (more efficient than client-side for large graphs). Call `loadGraphData({ since: from.toISOString(), until: to.toISOString() })` which re-fetches and re-renders.
- Actually, use a hybrid approach: for the preset quick filters, do client-side filtering for instant response. For custom date ranges entered via inputs, re-fetch from API.
- After time range filter, run `cy.fit(cy.elements(':visible'), 50)`

In ui/styles.css:
- .time-range-bar: flex row, gap 8px, align-items center, padding 8px 0, border-top 1px solid var(--border)
- .time-preset: small pill button similar to filter pills but neutral colored
- .time-preset.active: accent color background
- datetime-local inputs: styled to match dark theme (background var(--surface), color var(--text), border var(--border))
  </action>
  <verify>
1. Click "Today" preset -- graph shows only today's entities
2. Click "All time" -- graph shows everything
3. Select custom from/to dates -- graph updates to show only entities in that range
4. Combine with entity type filter: filter to "Decision" type + "This week" -- only Decision nodes from this week visible
5. Node count in stats updates correctly after time range changes
  </verify>
  <done>Time range controls allow filtering the graph by date. Preset buttons provide quick access to common ranges. Custom date inputs allow arbitrary ranges. Time range combines correctly with entity type filters.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify graph interaction works end-to-end</name>
  <files>ui/graph.js, ui/index.html, ui/styles.css</files>
  <action>
This is a human verification checkpoint. All implementation is complete in Tasks 1 and 2. The user verifies the complete graph interaction experience matches VIS-03 requirements.

What was built:
- Node click detail panel with observation list and relationship navigation
- Entity type filter pills (7 types with color coding)
- Time range zoom with presets (Last hour, Today, This week, This month, All time) and custom date inputs
- Combined filtering (type + time range)
  </action>
  <verify>
1. Open http://localhost:37820 in your browser
2. Verify the graph renders with colored/shaped nodes (if data exists; empty state message if not)
3. Click any node -- detail panel should slide in from the right showing the entity name, type badge, observations list, and relationships
4. Click a relationship link in the detail panel -- graph should animate to center on that node
5. Click the X button or background -- detail panel should close
6. Toggle entity type filter pills -- nodes of that type should appear/disappear
7. Click time range presets (Today, This week, etc.) -- graph should filter to that time window
8. Verify filter counts update as filters are applied
9. On a narrow viewport (resize browser to mobile width) -- detail panel should appear as bottom sheet instead of right sidebar
  </verify>
  <done>User confirms graph interaction is working: node click shows details, entity type filtering works, time range zoom works, and the overall experience is smooth. Type "approved" or describe issues to fix.</done>
</task>

</tasks>

<verification>
- Clicking a node opens the detail panel with entity info, observations, and relationships
- Clicking a relationship link in the panel navigates to that node in the graph
- Entity type pills toggle visibility of node types
- Time range presets and custom date inputs filter the graph by time
- Entity type and time range filters combine correctly
- Stats display updates after filtering
- Detail panel closes on background click or X button
- All interactions feel responsive (no visible lag)
</verification>

<success_criteria>
VIS-03 is fully delivered: users can click nodes to see observations, filter by entity type, and zoom to time ranges. The graph is a functional exploration tool, not just a static visualization.
</success_criteria>

<output>
After completion, create `.planning/phases/08-web-visualization/08-03-SUMMARY.md`
</output>
