---
phase: 06-topic-detection-and-context-stashing
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/intelligence/topic-detector.ts
  - src/intelligence/__tests__/topic-detector.test.ts
autonomous: true

must_haves:
  truths:
    - "Cosine distance between two embedding vectors is computed correctly"
    - "A large cosine distance (>0.3 default) between consecutive observations triggers a topic shift"
    - "A small cosine distance (<0.3) between consecutive observations does NOT trigger a shift"
    - "Edge cases handled: first observation (no prior), identical embeddings, zero vectors"
  artifacts:
    - path: "src/intelligence/topic-detector.ts"
      provides: "TopicShiftDetector class with static threshold detection"
      exports: ["TopicShiftDetector", "TopicShiftResult"]
    - path: "src/intelligence/__tests__/topic-detector.test.ts"
      provides: "Comprehensive test suite for topic detection"
      min_lines: 80
  key_links:
    - from: "src/intelligence/topic-detector.ts"
      to: "embedding vectors"
      via: "cosineDistance utility function"
      pattern: "cosineDistance"
---

<objective>
Build the TopicShiftDetector class that computes cosine distance between consecutive observation embeddings and determines whether a topic shift has occurred based on a static threshold.

Purpose: This is the foundation of all topic detection in Phase 6. The static threshold (default 0.3) provides a reliable baseline before adaptive EWMA is layered on in Plan 05. Using TDD because this is pure algorithmic logic with well-defined inputs and outputs.

Output: Tested TopicShiftDetector class with cosineDistance utility, static threshold comparison, and shift result type.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<feature>
  <name>Static Topic Shift Detection</name>
  <files>src/intelligence/topic-detector.ts, src/intelligence/__tests__/topic-detector.test.ts</files>
  <behavior>
    TopicShiftDetector maintains reference to the last embedding seen.
    On each new observation embedding, it computes cosine distance to the previous embedding.
    If distance exceeds the static threshold (default 0.3), it reports a topic shift.

    Cases:
    - cosineDistance([1,0,0], [0,1,0]) = 1.0 -> shifted: true (distance 1.0 > 0.3)
    - cosineDistance([1,0,0], [0.95,0.05,0]) ~= 0.05 -> shifted: false (distance < 0.3)
    - cosineDistance([1,0,0], [1,0,0]) = 0.0 -> shifted: false
    - First observation (no previous) -> shifted: false, confidence: 0
    - Zero vector handling -> shifted: false (graceful, no NaN)
    - Custom threshold (0.5) -> only shifts above 0.5 trigger

    TopicShiftResult type:
    {
      shifted: boolean;
      distance: number;
      threshold: number;
      confidence: number;  // 0-1, how far past threshold (0 if not shifted)
      previousEmbedding: number[] | null;
      currentEmbedding: number[];
    }

    cosineDistance(a, b): number
    - Returns 1 - cosineSimilarity(a, b)
    - Range [0, 2] where 0 = identical, 1 = orthogonal, 2 = opposite
    - Handles zero vectors gracefully (returns 0)
  </behavior>
  <implementation>
    1. Create cosineDistance utility function (dot product / magnitude product, subtracted from 1)
    2. Create TopicShiftResult interface
    3. Create TopicShiftDetector class with:
       - constructor(options?: { threshold?: number }) -- default threshold 0.3
       - private lastEmbedding: number[] | null
       - detect(embedding: number[]): TopicShiftResult
       - reset(): void -- clears last embedding state
       - getThreshold(): number
       - setThreshold(value: number): void -- bounded to [0.05, 0.95]
    4. Confidence calculation: shifted ? Math.min((distance - threshold) / threshold, 1.0) : 0
  </implementation>
</feature>

<verification>
- `npm test -- --testPathPattern=topic-detector` passes all cases
- cosineDistance produces mathematically correct results for known vectors
- TopicShiftDetector correctly identifies shifts above threshold and non-shifts below
- Edge cases (first observation, zero vectors, identical vectors) handled without errors
</verification>

<success_criteria>
- TopicShiftDetector class exported and fully tested
- cosineDistance utility function correct for all edge cases
- At least 8 test cases covering: normal shift, no shift, boundary, first obs, zero vec, custom threshold, reset, confidence calc
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-topic-detection-and-context-stashing/06-01-SUMMARY.md`
</output>
