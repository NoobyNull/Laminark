---
phase: 07-knowledge-graph-and-advanced-intelligence
plan: 06
type: execute
wave: 3
depends_on: ["07-01", "07-03"]
files_modified:
  - src/mcp/tools/query-graph.ts
  - src/mcp/tools/graph-stats.ts
  - tests/mcp/query-graph.test.ts
autonomous: true

must_haves:
  truths:
    - "Claude can call a query_graph MCP tool with a natural language question and receive traversal results"
    - "query_graph accepts entity name/type filter and traversal depth, returning connected subgraph"
    - "Results include entities, their relationships, and linked observation summaries"
    - "graph_stats tool returns node/edge counts, entity type distribution, and graph health metrics"
  artifacts:
    - path: "src/mcp/tools/query-graph.ts"
      provides: "MCP tool handler for knowledge graph queries"
      exports: ["queryGraphTool", "QueryGraphInput", "QueryGraphOutput"]
    - path: "src/mcp/tools/graph-stats.ts"
      provides: "MCP tool handler for graph statistics and health"
      exports: ["graphStatsTool", "GraphStatsOutput"]
    - path: "tests/mcp/query-graph.test.ts"
      provides: "Tests for graph query MCP tool"
  key_links:
    - from: "src/mcp/tools/query-graph.ts"
      to: "src/graph/schema.ts"
      via: "calls traverseFrom, getNodesByType for graph queries"
      pattern: "traverseFrom|getNodesByType|getEdgesForNode"
    - from: "src/mcp/tools/query-graph.ts"
      to: "MCP server tool registration"
      via: "registered as a callable MCP tool"
      pattern: "server\\.tool|tools\\.register|addTool"
    - from: "src/mcp/tools/graph-stats.ts"
      to: "src/graph/constraints.ts"
      via: "calls getGraphHealth for stats"
      pattern: "getGraphHealth"
---

<objective>
Create MCP tools that let Claude query the knowledge graph -- finding entities, traversing relationships, and getting graph health statistics.

Purpose: INT-11 requires Claude to be able to query the knowledge graph via MCP tool. Without this, the graph data exists but Claude cannot access it during conversations. This is the "read" interface to the knowledge graph.
Output: query_graph and graph_stats MCP tool handlers with tests.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-knowledge-graph-and-advanced-intelligence/07-01-SUMMARY.md
@.planning/phases/07-knowledge-graph-and-advanced-intelligence/07-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement query_graph MCP tool</name>
  <files>src/mcp/tools/query-graph.ts, tests/mcp/query-graph.test.ts</files>
  <action>
**MCP tool handler (src/mcp/tools/query-graph.ts):**

1. Define `QueryGraphInput` schema (JSON Schema for MCP tool input):
   ```typescript
   {
     query: string;          // Natural language or entity name to search for
     entity_type?: EntityType; // Filter to specific entity type
     depth?: number;          // Traversal depth (default: 2, max: 4)
     relationship_types?: RelationshipType[]; // Filter to specific edge types
     limit?: number;          // Max results (default: 20, max: 50)
   }
   ```

2. `queryGraphTool` handler function:
   - Parse input, validate types against taxonomy (reject invalid entity_type/relationship_types)
   - Search strategy:
     a. First, try exact name match: getNodeByNameAndType(db, query, entity_type)
     b. If no exact match, do case-insensitive LIKE search on graph_nodes.name
     c. If entity_type provided, filter to that type
   - Once root node(s) found, call traverseFrom for each with specified depth
   - Collect the subgraph: nodes, edges, and linked observation text snippets
   - Format output for Claude consumption:
     ```
     ## Entities Found
     - [File] src/auth/login.ts (5 connections)
       - uses -> [Tool] jose
       - depends_on -> [File] src/auth/types.ts
       - related_to -> [Decision] Use JWT for authentication

     ## Related Observations
     - "Decided to use JWT tokens stored in httpOnly cookies..." (2 days ago)
     - "Switched from jsonwebtoken to jose for Edge runtime..." (1 day ago)
     ```
   - Use progressive disclosure: first show entity list with connection counts, then relationships, then observation excerpts (truncated to 200 chars each)
   - If no results found, return helpful message: "No entities matching '[query]' found. Try: [suggest related entity types]"

3. Register the tool with MCP server using the project's tool registration pattern (check src/mcp/ for how existing tools like search, save_memory are registered). The tool definition:
   ```typescript
   {
     name: "query_graph",
     description: "Query the knowledge graph to find entities and their relationships. Use to answer questions like 'what files does this decision affect?' or 'what tools does this project use?'",
     inputSchema: QueryGraphInput
   }
   ```

**Tests (tests/mcp/query-graph.test.ts):**

1. "finds entity by exact name and returns traversal results"
   - Set up: insert File node "src/auth/login.ts" with edges to Tool "jose" and Decision "Use JWT"
   - Query: { query: "src/auth/login.ts" }
   - Expect: File node with 2 relationships listed

2. "filters by entity type"
   - Set up: insert Tool "react" and File "react.config.js"
   - Query: { query: "react", entity_type: "Tool" }
   - Expect: only Tool node returned

3. "respects depth limit"
   - Set up: chain A->B->C->D
   - Query from A with depth=1
   - Expect: only B returned (not C, D)

4. "returns helpful message when no results found"
   - Query: { query: "nonexistent" }
   - Expect: message suggesting alternatives

5. "truncates observation text in results"
   - Set up: node with linked observation > 200 chars
   - Expect: observation text truncated with "..."
  </action>
  <verify>Run tests: `npx vitest run tests/mcp/query-graph.test.ts`. All 5 tests pass. npx tsc --noEmit passes.</verify>
  <done>Claude can call query_graph MCP tool to find entities by name/type, traverse relationships to configurable depth, and see linked observation excerpts. Results use progressive disclosure and are formatted for Claude readability.</done>
</task>

<task type="auto">
  <name>Task 2: Implement graph_stats MCP tool</name>
  <files>src/mcp/tools/graph-stats.ts</files>
  <action>
Create src/mcp/tools/graph-stats.ts:

1. Define `GraphStatsOutput`:
   ```typescript
   {
     total_nodes: number;
     total_edges: number;
     by_entity_type: Record<EntityType, number>;
     by_relationship_type: Record<RelationshipType, number>;
     avg_degree: number;
     max_degree: { node_name: string, node_type: EntityType, degree: number };
     hotspots: Array<{ name: string, type: EntityType, degree: number }>; // nodes near degree limit
     duplicate_candidates: number;
     staleness_flags: number; // count of stale-flagged observations
   }
   ```

2. `graphStatsTool` handler:
   - Call getGraphHealth from constraints module for core metrics
   - Count by entity type: SELECT type, COUNT(*) FROM graph_nodes GROUP BY type
   - Count by relationship type: SELECT type, COUNT(*) FROM graph_edges GROUP BY type
   - Get staleness flag count from staleness module
   - Format as readable summary for Claude:
     ```
     ## Knowledge Graph Stats
     Nodes: 142 | Edges: 287 | Avg degree: 4.0

     ### Entity Distribution
     File: 68 | Tool: 23 | Decision: 18 | Problem: 12 | Solution: 9 | Person: 7 | Project: 5

     ### Relationship Distribution
     uses: 89 | depends_on: 67 | related_to: 54 | part_of: 38 | decided_by: 21 | solved_by: 12 | caused_by: 6

     ### Health
     Hotspots (near 50-edge limit): src/index.ts (43 edges)
     Duplicate candidates: 3 pairs
     Stale observations: 7
     ```

3. Register tool:
   ```typescript
   {
     name: "graph_stats",
     description: "Get knowledge graph statistics: entity counts, relationship distribution, health metrics. Use to understand the state of accumulated knowledge.",
     inputSchema: {} // no input needed
   }
   ```

No input parameters -- this is a dashboard view.
  </action>
  <verify>npx tsc --noEmit src/mcp/tools/graph-stats.ts. Verify tool returns valid stats when graph has data and handles empty graph gracefully (all zeros, no errors).</verify>
  <done>graph_stats MCP tool returns comprehensive graph health metrics: counts by entity/relationship type, degree statistics, hotspots, duplicate candidates, and staleness flags. Handles empty graph without errors.</done>
</task>

</tasks>

<verification>
- query_graph returns results for known entities and helpful messages for unknown queries
- Traversal depth is respected (depth=1 only returns direct neighbors)
- Entity type and relationship type filters work correctly
- graph_stats returns correct counts matching actual graph state
- Both tools are registered and callable from MCP
- All tests pass
</verification>

<success_criteria>
Claude can query the knowledge graph via MCP tools: query_graph for finding entities and traversing relationships, graph_stats for monitoring graph health. Results are formatted for Claude readability with progressive disclosure. The knowledge graph is no longer write-only -- Claude can reason about entity relationships during conversations.
</success_criteria>

<output>
After completion, create `.planning/phases/07-knowledge-graph-and-advanced-intelligence/07-06-SUMMARY.md`
</output>
