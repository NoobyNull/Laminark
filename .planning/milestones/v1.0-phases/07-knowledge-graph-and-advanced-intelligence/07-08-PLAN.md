---
phase: 07-knowledge-graph-and-advanced-intelligence
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - src/index.ts
  - tests/integration/graph-wiring-integration.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "After an observation's embedding is generated, entity extraction and relationship detection run automatically"
    - "CurationAgent runs periodically in the MCP server lifecycle and stops on shutdown"
    - "All existing tests continue passing with zero regressions"
  artifacts:
    - path: "src/index.ts"
      provides: "Entity extraction, relationship detection, and curation agent wired into live flow"
      contains: "extractAndPersist"
    - path: "tests/integration/graph-wiring-integration.test.ts"
      provides: "Integration tests proving graph population from observations"
---

<objective>
Wire entity extraction, relationship detection, and curation agent into the MCP server's live observation processing flow.

Purpose: Close 3 failing success criteria from Phase 7 verification â€” automatic entity extraction (SC1), relationship detection (SC2), and curation agent lifecycle (SC5). All infrastructure exists but is orphaned; this plan connects it.

Output: processUnembedded() calls extractAndPersist() and detectAndPersist() after each embedding. CurationAgent instantiated and started in server lifecycle, stopped on shutdown.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Wire graph extraction into processUnembedded and start curation agent</name>
  <files>
    src/index.ts
  </files>
  <action>
**Step 1: Add imports for graph modules**

Add to the import section of src/index.ts:
```typescript
import { initGraphSchema } from './graph/schema.js';
import { extractAndPersist } from './graph/entity-extractor.js';
import { detectAndPersist } from './graph/relationship-detector.js';
import { CurationAgent } from './graph/curation-agent.js';
```

**Step 2: Initialize graph schema after database open**

After the `const db = openDatabase(...)` line, add:
```typescript
initGraphSchema(db.db);
```

**Step 3: Wire entity extraction and relationship detection into processUnembedded()**

Inside the `if (embedding)` block, after the topic shift detection block (after the closing `}` of `if (topicConfig.enabled)`), add:

```typescript
      // Knowledge graph -- extract entities and detect relationships
      try {
        const extractResult = extractAndPersist(db.db, text, String(id));
        if (extractResult.entities.length > 0) {
          const entityPairs = extractResult.entities.map(e => ({
            name: e.name,
            type: e.type,
          }));
          detectAndPersist(db.db, text, entityPairs);
          debug('embed', 'Graph updated', {
            id,
            entities: extractResult.entities.length,
          });
        }
      } catch (graphErr) {
        const msg = graphErr instanceof Error ? graphErr.message : String(graphErr);
        debug('embed', 'Graph extraction error (non-fatal)', { error: msg });
      }
```

**Step 4: Instantiate and start CurationAgent**

After the MCP server setup section (after the `startServer(server).catch(...)` block), add:

```typescript
// ---------------------------------------------------------------------------
// Background curation agent (graph maintenance)
// ---------------------------------------------------------------------------

const curationAgent = new CurationAgent(db.db, {
  intervalMs: 5 * 60 * 1000, // 5 minutes
  onComplete: (report) => {
    debug('db', 'Curation complete', {
      merged: report.mergedClusters,
      deduped: report.deduplicatedEntities,
      stale: report.staleFlagged,
      pruned: report.pruned,
    });
  },
});
curationAgent.start();
```

**Step 5: Stop curation agent in shutdown handlers**

Add `curationAgent.stop();` to each shutdown handler (SIGINT, SIGTERM, uncaughtException) before `db.close()`.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx vitest run` -- all existing tests pass
    - Inspect src/index.ts to confirm extractAndPersist and detectAndPersist called in processUnembedded
    - Inspect src/index.ts to confirm CurationAgent instantiated, started, and stopped on shutdown
  </verify>
  <done>
    - initGraphSchema called at startup
    - extractAndPersist called after each embedding in processUnembedded
    - detectAndPersist called with extracted entities after extraction
    - CurationAgent running with 5-minute interval
    - All shutdown handlers stop curation agent
    - All graph errors caught non-fatally
  </done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for graph wiring</name>
  <files>
    tests/integration/graph-wiring-integration.test.ts
  </files>
  <action>
Create integration tests that prove:

1. **extractAndPersist creates graph nodes from observation text**
   - Create temp database, init graph schema
   - Call extractAndPersist with text containing file paths and tool names
   - Assert graph_nodes table has entries

2. **detectAndPersist creates edges between extracted entities**
   - Extract entities from text with co-occurring entities
   - Call detectAndPersist with extracted entities
   - Assert graph_edges table has entries

3. **CurationAgent start/stop lifecycle**
   - Instantiate CurationAgent with short interval (100ms)
   - Start it, wait briefly, stop it
   - Assert no errors thrown

Use createTempDb pattern from existing test utilities.
  </action>
  <verify>
    - `npx vitest run` -- all tests pass including new integration tests
  </verify>
  <done>
    - Integration tests prove entity extraction populates graph nodes
    - Integration tests prove relationship detection creates edges
    - Integration tests prove curation agent lifecycle works
  </done>
</task>

</tasks>

<success_criteria>
- SC1 CLOSED: extractAndPersist() called in processUnembedded() after each embedding
- SC2 CLOSED: detectAndPersist() called with extracted entities after extraction
- SC5 CLOSED: CurationAgent instantiated, started, and stopped in server lifecycle
- Zero regressions: All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-knowledge-graph-and-advanced-intelligence/07-08-SUMMARY.md`
</output>
