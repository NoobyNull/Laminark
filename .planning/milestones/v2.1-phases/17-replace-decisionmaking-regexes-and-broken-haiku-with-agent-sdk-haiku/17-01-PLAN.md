---
phase: 17-replace-decisionmaking-regexes-and-broken-haiku-with-agent-sdk-haiku
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/config/haiku-config.ts
  - src/intelligence/haiku-client.ts
  - src/intelligence/haiku-entity-agent.ts
  - src/intelligence/haiku-relationship-agent.ts
  - src/intelligence/haiku-classifier-agent.ts
autonomous: true
user_setup:
  - service: anthropic
    why: "Laminark needs its own API key for Haiku calls (separate from Claude Code's ANTHROPIC_API_KEY)"
    env_vars:
      - name: LAMINARK_API_KEY
        source: "console.anthropic.com -> API Keys -> Create Key"

must_haves:
  truths:
    - "Anthropic SDK is installed and importable"
    - "Haiku client initializes with LAMINARK_API_KEY env var or config.json apiKey field"
    - "Haiku client returns null gracefully when no API key is configured"
    - "Entity extraction agent returns typed entities with confidence from Haiku"
    - "Relationship inference agent returns typed relationships from entity pairs"
    - "Classifier agent returns signal/noise classification and observation kind"
  artifacts:
    - path: "src/config/haiku-config.ts"
      provides: "API key loading and Haiku configuration"
      contains: "LAMINARK_API_KEY"
    - path: "src/intelligence/haiku-client.ts"
      provides: "Shared Anthropic client singleton and callHaiku helper"
      exports: ["getHaikuClient", "callHaiku", "extractJsonFromResponse", "isHaikuEnabled"]
    - path: "src/intelligence/haiku-entity-agent.ts"
      provides: "Entity extraction via Haiku"
      exports: ["extractEntitiesWithHaiku"]
    - path: "src/intelligence/haiku-relationship-agent.ts"
      provides: "Relationship inference via Haiku"
      exports: ["inferRelationshipsWithHaiku"]
    - path: "src/intelligence/haiku-classifier-agent.ts"
      provides: "Combined noise and observation classification via Haiku"
      exports: ["classifyWithHaiku"]
  key_links:
    - from: "src/intelligence/haiku-client.ts"
      to: "src/config/haiku-config.ts"
      via: "loadHaikuConfig import"
      pattern: "import.*haiku-config"
    - from: "src/intelligence/haiku-entity-agent.ts"
      to: "src/intelligence/haiku-client.ts"
      via: "callHaiku import"
      pattern: "import.*haiku-client"
---

<objective>
Create the Haiku intelligence foundation: SDK installation, API key configuration, shared client, and all three focused agent modules.

Purpose: Establishes the entire Haiku calling infrastructure so Plan 02 can wire it into the existing processing pipeline. Each agent is a standalone module with a focused prompt and Zod-validated structured output.

Output: 6 new files (1 config, 1 client, 3 agents) + updated package.json with @anthropic-ai/sdk dependency.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-replace-decisionmaking-regexes-and-broken-haiku-with-agent-sdk-haiku/17-RESEARCH.md
@src/graph/types.ts
@src/shared/config.ts
@src/shared/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install SDK and create API key config + Haiku client</name>
  <files>
    package.json
    src/config/haiku-config.ts
    src/intelligence/haiku-client.ts
  </files>
  <action>
    1. Run `npm install @anthropic-ai/sdk` to add the Anthropic TypeScript SDK.

    2. Create `src/config/haiku-config.ts` following the existing pattern in `src/shared/config.ts`:
       - Export `HaikuConfig` interface: `{ apiKey: string | null, model: string, maxTokensPerCall: number, enabled: boolean }`
       - Export `loadHaikuConfig()` function with resolution order:
         a. `LAMINARK_API_KEY` env var (highest priority)
         b. `config.json` in getConfigDir() with `apiKey` field
         c. Not configured (returns `{ enabled: false, apiKey: null }`)
       - Use `getConfigDir()` from `../shared/config.js` for config path
       - Use `debug()` from `../shared/debug.js` for logging when no key found
       - Model: `'claude-haiku-4-5-20251001'`
       - Default maxTokensPerCall: 1024

    3. Create `src/intelligence/haiku-client.ts`:
       - Import `Anthropic` from `@anthropic-ai/sdk`
       - Import `loadHaikuConfig` from `../config/haiku-config.js`
       - Singleton pattern: `_client: Anthropic | null` and `_config`
       - Export `getHaikuClient(): Anthropic | null` -- returns null if no API key
       - Export `isHaikuEnabled(): boolean` -- checks if client can be created
       - Export `callHaiku(systemPrompt: string, userContent: string, maxTokens?: number): Promise<string>` -- calls `client.messages.create()` with model from config, returns text content
       - Export `extractJsonFromResponse(text: string): unknown` -- defensive JSON extractor:
         a. Strip markdown code fences (`\`\`\`json` and `\`\`\``)
         b. Try to find JSON array `[...]`
         c. Try to find JSON object `{...}`
         d. Throw if no JSON found
       - Export `resetHaikuClient(): void` -- for testing (clears singleton)
  </action>
  <verify>
    - `npm ls @anthropic-ai/sdk` shows the package is installed
    - `npx tsc --noEmit src/config/haiku-config.ts src/intelligence/haiku-client.ts` compiles without errors
    - Verify loadHaikuConfig returns `{ enabled: false }` when no env var or config file is set
  </verify>
  <done>
    SDK installed, haiku-config exports loadHaikuConfig with 3-tier resolution, haiku-client exports getHaikuClient/callHaiku/extractJsonFromResponse/isHaikuEnabled/resetHaikuClient. Graceful degradation when no API key.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create all three Haiku agent modules</name>
  <files>
    src/intelligence/haiku-entity-agent.ts
    src/intelligence/haiku-relationship-agent.ts
    src/intelligence/haiku-classifier-agent.ts
  </files>
  <action>
    1. Create `src/intelligence/haiku-entity-agent.ts`:
       - Import `callHaiku`, `extractJsonFromResponse` from `./haiku-client.js`
       - Import `z` from `zod` (already installed)
       - Import `ENTITY_TYPES`, `EntityType` from `../graph/types.js`
       - Define Zod schema: `EntitySchema = z.object({ name: z.string().min(1), type: z.enum(ENTITY_TYPES), confidence: z.number().min(0).max(1) })`
       - Define `EntityArraySchema = z.array(EntitySchema)`
       - System prompt (see research Example 3): Instructs Haiku to extract entities using ONLY the 6 entity types (File, Project, Reference, Decision, Problem, Solution). Return JSON array `[{"name": "...", "type": "...", "confidence": 0.0-1.0}]`. Return `[]` if none found. No markdown, no explanation.
       - Export `extractEntitiesWithHaiku(text: string): Promise<Array<{ name: string; type: EntityType; confidence: number }>>`:
         a. Call `callHaiku(SYSTEM_PROMPT, text, 512)`
         b. Extract JSON via `extractJsonFromResponse`
         c. Validate with `EntityArraySchema.parse()`
         d. Return validated array

    2. Create `src/intelligence/haiku-relationship-agent.ts`:
       - Import `callHaiku`, `extractJsonFromResponse` from `./haiku-client.js`
       - Import `z` from `zod`
       - Import `RELATIONSHIP_TYPES`, `RelationshipType`, `EntityType` from `../graph/types.js`
       - Zod schema: `RelationshipSchema = z.object({ source: z.string(), target: z.string(), type: z.enum(RELATIONSHIP_TYPES), confidence: z.number().min(0).max(1) })`
       - System prompt (see research Example 4): Given observation text and entity list, infer relationships using ONLY the 8 relationship types. Return JSON array. Return `[]` if none.
       - Export `inferRelationshipsWithHaiku(text: string, entities: Array<{ name: string; type: EntityType }>): Promise<Array<{ source: string; target: string; type: RelationshipType; confidence: number }>>`:
         a. Build user content: observation text + entity list as JSON
         b. Call `callHaiku(SYSTEM_PROMPT, userContent, 512)`
         c. Validate with Zod
         d. Return validated array

    3. Create `src/intelligence/haiku-classifier-agent.ts`:
       - Import `callHaiku`, `extractJsonFromResponse` from `./haiku-client.js`
       - Import `z` from `zod`
       - Import `ObservationClassification` from `../shared/types.js`
       - Combined classifier (ONE Haiku call answers both noise vs signal AND observation kind) per research recommendation and user's "each concern" decision (noise+observation classification IS one concern).
       - Zod schema: `ClassificationSchema = z.object({ signal: z.enum(["noise", "signal"]), classification: z.enum(["discovery", "problem", "solution"]).nullable(), reason: z.string() })`
       - System prompt (see research Example 5): Classify as noise/signal. If signal, classify as discovery/problem/solution. Return JSON `{"signal": ..., "classification": ..., "reason": ...}`.
       - Export `ClassificationResult` type: `{ signal: 'noise' | 'signal'; classification: ObservationClassification | null; reason: string }`
       - Export `classifyWithHaiku(text: string, source?: string): Promise<ClassificationResult>`:
         a. Build user content including observation text and source if provided
         b. Call `callHaiku(SYSTEM_PROMPT, userContent, 256)`
         c. Validate with Zod
         d. Return validated result
  </action>
  <verify>
    - `npx tsc --noEmit src/intelligence/haiku-entity-agent.ts src/intelligence/haiku-relationship-agent.ts src/intelligence/haiku-classifier-agent.ts` compiles without errors
    - Each agent imports from haiku-client.js and graph/types.js correctly
    - Zod schemas match the expected response shapes
  </verify>
  <done>
    Three focused agent modules created. Entity agent extracts 6 entity types. Relationship agent infers 8 relationship types from entity pairs. Classifier agent determines noise/signal and discovery/problem/solution in one call. All use Zod validation for structured output.
  </done>
</task>

</tasks>

<verification>
1. `npm ls @anthropic-ai/sdk` shows installed dependency
2. `npx tsc --noEmit` across all new files compiles clean
3. All exports match the must_haves artifacts list
4. Haiku client returns null when LAMINARK_API_KEY is not set (graceful degradation)
5. Agent system prompts reference correct entity/relationship types from types.ts
</verification>

<success_criteria>
- @anthropic-ai/sdk installed in package.json
- 5 new files created: haiku-config.ts, haiku-client.ts, haiku-entity-agent.ts, haiku-relationship-agent.ts, haiku-classifier-agent.ts
- All files compile without TypeScript errors
- Graceful degradation path confirmed (no API key -> disabled)
</success_criteria>

<output>
After completion, create `.planning/phases/17-replace-decisionmaking-regexes-and-broken-haiku-with-agent-sdk-haiku/17-01-SUMMARY.md`
</output>
