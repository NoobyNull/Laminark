---
phase: 18-replace-anthropic-ai-sdk-with-claude-agent-sdk-for-subscription-based-haiku-calls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/config/haiku-config.ts
  - src/intelligence/haiku-client.ts
autonomous: true

must_haves:
  truths:
    - "Haiku calls route through Claude Code subscription auth, not a separate API key"
    - "callHaiku(systemPrompt, userContent) returns LLM text response using Agent SDK"
    - "isHaikuEnabled() always returns true (no API key check)"
    - "Session reuse avoids 12s cold start on sequential calls within a batch"
    - "@anthropic-ai/sdk is no longer a dependency"
  artifacts:
    - path: "src/intelligence/haiku-client.ts"
      provides: "callHaiku via Agent SDK V2 session, isHaikuEnabled always true, extractJsonFromResponse unchanged"
      exports: ["callHaiku", "isHaikuEnabled", "extractJsonFromResponse", "resetHaikuClient"]
    - path: "src/config/haiku-config.ts"
      provides: "Simplified config without API key resolution"
      exports: ["loadHaikuConfig", "HaikuConfig"]
    - path: "package.json"
      provides: "@anthropic-ai/claude-agent-sdk dependency, no @anthropic-ai/sdk"
      contains: "@anthropic-ai/claude-agent-sdk"
  key_links:
    - from: "src/intelligence/haiku-client.ts"
      to: "@anthropic-ai/claude-agent-sdk"
      via: "unstable_v2_createSession import"
      pattern: "unstable_v2_createSession"
    - from: "src/intelligence/haiku-client.ts"
      to: "src/config/haiku-config.ts"
      via: "loadHaikuConfig import (model name)"
      pattern: "loadHaikuConfig"
    - from: "src/intelligence/haiku-classifier-agent.ts"
      to: "src/intelligence/haiku-client.ts"
      via: "callHaiku import (unchanged contract)"
      pattern: "callHaiku"
---

<objective>
Replace @anthropic-ai/sdk with @anthropic-ai/claude-agent-sdk in haiku-client.ts so Haiku calls use Claude Code subscription auth instead of a separate API key.

Purpose: Eliminate the requirement for users to provide their own Anthropic API key. All Haiku enrichment calls piggyback on the user's existing Claude Code subscription.

Output: Working haiku-client.ts using Agent SDK V2 session API, simplified haiku-config.ts, updated package.json.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-replace-anthropic-ai-sdk-with-claude-agent-sdk-for-subscription-based-haiku-calls/18-RESEARCH.md
@src/intelligence/haiku-client.ts
@src/config/haiku-config.ts
@src/intelligence/haiku-processor.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Swap SDK dependency and simplify config</name>
  <files>package.json, src/config/haiku-config.ts</files>
  <action>
1. In package.json, replace `"@anthropic-ai/sdk": "^0.74.0"` with `"@anthropic-ai/claude-agent-sdk": "^0.2.42"` in dependencies. Run `npm install` to update node_modules and lock file.

2. Rewrite `src/config/haiku-config.ts` to remove ALL API key resolution logic:
   - Remove `readFileSync`, `join`, `getConfigDir`, `debug` imports (none needed)
   - Simplify `HaikuConfig` interface to just `{ model: string; maxTokensPerCall: number }` -- remove `apiKey` and `enabled` fields
   - `loadHaikuConfig()` returns a static object: `{ model: 'claude-haiku-4-5-20251001', maxTokensPerCall: 1024 }`
   - No env var checks, no config.json reads, no debug logging
   - The entire file should be ~15 lines

Why remove apiKey/enabled: With Agent SDK, auth is handled by Claude Code subscription transparently. There is no API key to configure.
  </action>
  <verify>
`npm ls @anthropic-ai/claude-agent-sdk` shows the package installed.
`npm ls @anthropic-ai/sdk 2>&1` shows "empty" or not found.
`npx tsc --noEmit 2>&1 | grep haiku-config` shows no type errors (will have errors in haiku-client.ts until Task 2).
  </verify>
  <done>package.json has claude-agent-sdk (not @anthropic-ai/sdk), haiku-config.ts returns model+maxTokens without API key logic</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite haiku-client.ts to use Agent SDK V2 session</name>
  <files>src/intelligence/haiku-client.ts</files>
  <action>
Rewrite `src/intelligence/haiku-client.ts` completely. The file must:

1. **Import** `unstable_v2_createSession` from `@anthropic-ai/claude-agent-sdk`. Import `loadHaikuConfig` from config (for model name only).

2. **Session singleton** (`_session`): Lazily created via `getOrCreateSession()`. The session is created with:
   ```typescript
   unstable_v2_createSession({
     model: 'haiku',  // Use short name per AgentDefinition type hint
     maxTurns: 1,
     permissionMode: 'bypassPermissions',
     allowDangerouslySkipPermissions: true,
     allowedTools: [],  // No tools -- pure text completion only
   })
   ```
   NOTE: If `'haiku'` short name does not work, fall back to `'claude-haiku-4-5-20251001'`. The research notes the AgentDefinition type shows `model?: "sonnet" | "opus" | "haiku" | "inherit"` suggesting short names.

3. **`callHaiku(systemPrompt, userContent, _maxTokens?)`**: Same signature as before for backward compatibility. Implementation:
   - Get or create session via `getOrCreateSession()`
   - Embed system prompt in user message: `<instructions>\n${systemPrompt}\n</instructions>\n\n${userContent}`
   - Call `session.send(fullPrompt)` then iterate `session.stream()` looking for `msg.type === 'result'`
   - On `msg.subtype === 'success'`, return `msg.result` (string)
   - On other subtypes, throw with error details
   - In catch block: close and null out `_session` (session may have expired), then rethrow
   - `_maxTokens` parameter kept for signature compat but unused (Agent SDK does not expose max_tokens; output constrained by system prompts)

4. **`isHaikuEnabled()`**: Simply `return true`. No API key check needed.

5. **`extractJsonFromResponse()`**: Copy UNCHANGED from current file. Pure function, no SDK dependency.

6. **`resetHaikuClient()`**: Close `_session` if non-null, set to null. Used by tests.

7. **Remove**: `getHaikuClient()` export (no longer needed -- callers use `callHaiku()` directly). Check that no other file imports `getHaikuClient` first. If any file does, keep it but make it throw an error explaining the migration.

Important: Do NOT change the `callHaiku` function signature. All three agent modules (`haiku-classifier-agent.ts`, `haiku-entity-agent.ts`, `haiku-relationship-agent.ts`) import and call `callHaiku(systemPrompt, userContent)` and must continue working without changes.
  </action>
  <verify>
`npx tsc --noEmit` passes with zero errors.
`grep -r "anthropic-ai/sdk" src/` returns zero matches (only claude-agent-sdk).
`grep "getHaikuClient" src/intelligence/haiku-classifier-agent.ts src/intelligence/haiku-entity-agent.ts src/intelligence/haiku-relationship-agent.ts` returns zero matches (agents only use callHaiku).
  </verify>
  <done>haiku-client.ts uses Agent SDK V2 session, callHaiku signature unchanged, isHaikuEnabled always returns true, TypeScript compiles clean</done>
</task>

</tasks>

<verification>
1. `npm run check` (tsc --noEmit) passes -- all types resolve
2. `npm run build` (tsdown) succeeds -- dist/ output updated
3. `grep -r "@anthropic-ai/sdk" src/ package.json` returns ONLY claude-agent-sdk references
4. `grep "callHaiku" src/intelligence/haiku-*.ts` shows all agents still importing from haiku-client
</verification>

<success_criteria>
- @anthropic-ai/sdk fully replaced by @anthropic-ai/claude-agent-sdk
- callHaiku() uses V2 session API with subscription auth
- isHaikuEnabled() always returns true
- All three agent modules unchanged and type-check clean
- haiku-config.ts has no API key logic
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/18-replace-anthropic-ai-sdk-with-claude-agent-sdk-for-subscription-based-haiku-calls/18-01-SUMMARY.md`
</output>
