---
phase: 10-tool-discovery-registry
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/tool-types.ts
  - src/storage/migrations.ts
  - src/storage/tool-registry.ts
autonomous: true

must_haves:
  truths:
    - "Migration 16 creates the tool_registry table with UNIQUE index on (name, COALESCE(project_hash, ''))"
    - "ToolRegistryRepository can upsert a tool and retrieve it by scope or name"
    - "Usage recording increments usage_count and updates last_used_at without creating duplicates"
    - "The tool_registry table persists across database reopen -- tools registered in one session are queryable in a new session"
  artifacts:
    - path: "src/shared/tool-types.ts"
      provides: "ToolType, ToolScope, DiscoveredTool, ToolRegistryRow type definitions"
      contains: "DiscoveredTool"
    - path: "src/storage/migrations.ts"
      provides: "Migration 16 adding tool_registry table with indexes"
      contains: "create_tool_registry"
    - path: "src/storage/tool-registry.ts"
      provides: "ToolRegistryRepository with upsert, recordUsage, getForProject, recordOrCreate"
      contains: "ToolRegistryRepository"
  key_links:
    - from: "src/storage/tool-registry.ts"
      to: "src/shared/tool-types.ts"
      via: "import DiscoveredTool and ToolRegistryRow types"
      pattern: "import.*tool-types"
    - from: "src/storage/migrations.ts"
      to: "tool_registry table"
      via: "Migration 16 creates the table that ToolRegistryRepository queries"
      pattern: "create_tool_registry"
---

<objective>
Create the storage foundation for tool discovery: type definitions, database migration, and repository class. This establishes the `tool_registry` table and its CRUD interface so that Plan 02 can wire in config scanning and organic discovery.

Purpose: DISC-06 requires a `tool_registry` table with scope metadata. All discovery mechanisms (config scanning, organic PostToolUse) need a repository to write to. This plan builds the data layer in isolation so it can be thoroughly tested before integration.

Output: Three new files -- `src/shared/tool-types.ts`, updated `src/storage/migrations.ts` (migration 16), and `src/storage/tool-registry.ts`.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-tool-discovery-registry/10-RESEARCH.md
@src/storage/observations.ts
@src/storage/research-buffer.ts
@src/storage/migrations.ts
@src/shared/types.ts
@src/shared/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tool type definitions and migration 16</name>
  <files>src/shared/tool-types.ts, src/storage/migrations.ts</files>
  <action>
    Create `src/shared/tool-types.ts` with these types:

    ```typescript
    /**
     * Tool type classification based on how the tool is provided.
     */
    export type ToolType = 'mcp_server' | 'mcp_tool' | 'slash_command' | 'skill' | 'plugin' | 'builtin' | 'unknown';

    /**
     * Scope origin of a tool -- where it was discovered from.
     */
    export type ToolScope = 'global' | 'project' | 'plugin';

    /**
     * A tool discovered during config scanning (SessionStart).
     * Used as input to ToolRegistryRepository.upsert().
     */
    export interface DiscoveredTool {
      name: string;
      toolType: ToolType;
      scope: ToolScope;
      source: string;        // e.g., 'config:.mcp.json', 'config:~/.claude.json', 'hook:PostToolUse'
      projectHash: string | null;
      description: string | null;
      serverName: string | null;  // for MCP servers/tools: the server name key
    }

    /**
     * Raw database row from the tool_registry table (snake_case).
     */
    export interface ToolRegistryRow {
      id: number;
      name: string;
      tool_type: string;
      scope: string;
      source: string;
      project_hash: string | null;
      description: string | null;
      server_name: string | null;
      usage_count: number;
      last_used_at: string | null;
      discovered_at: string;
      updated_at: string;
    }
    ```

    Add migration 16 to `src/storage/migrations.ts`:

    - Add it AFTER the existing migration 15 (update_graph_taxonomy) in the MIGRATIONS array.
    - Version: 16, name: 'create_tool_registry'.
    - SQL creates the `tool_registry` table with columns: id (INTEGER PRIMARY KEY AUTOINCREMENT), name (TEXT NOT NULL), tool_type (TEXT NOT NULL), scope (TEXT NOT NULL), source (TEXT NOT NULL), project_hash (TEXT), description (TEXT), server_name (TEXT), usage_count (INTEGER NOT NULL DEFAULT 0), last_used_at (TEXT), discovered_at (TEXT NOT NULL DEFAULT (datetime('now'))), updated_at (TEXT NOT NULL DEFAULT (datetime('now'))).
    - Create UNIQUE INDEX `idx_tool_registry_name_project` ON tool_registry(name, COALESCE(project_hash, '')) -- this handles NULL project_hash uniqueness.
    - Create INDEX `idx_tool_registry_scope` ON tool_registry(scope).
    - Create INDEX `idx_tool_registry_project` ON tool_registry(project_hash) WHERE project_hash IS NOT NULL.
    - Create INDEX `idx_tool_registry_usage` ON tool_registry(usage_count DESC, last_used_at DESC).
    - Update the comment block at the top of the MIGRATIONS array to include Migration 016 description.
    - This is a plain SQL string migration (not a function), similar to migration 13 (create_research_buffer).
  </action>
  <verify>
    1. `npx tsc --noEmit` passes (type definitions are valid TypeScript).
    2. Run `npm run build` to confirm the build completes with new files.
    3. Read src/storage/migrations.ts and confirm migration 16 is the last entry with version 16.
  </verify>
  <done>
    - src/shared/tool-types.ts exists with ToolType, ToolScope, DiscoveredTool, and ToolRegistryRow exports.
    - Migration 16 in src/storage/migrations.ts creates tool_registry table with all columns and 4 indexes including the COALESCE unique index.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ToolRegistryRepository</name>
  <files>src/storage/tool-registry.ts</files>
  <action>
    Create `src/storage/tool-registry.ts` following the pattern from `src/storage/observations.ts` and `src/storage/research-buffer.ts`:

    ```typescript
    import type BetterSqlite3 from 'better-sqlite3';
    import { debug } from '../shared/debug.js';
    import type { DiscoveredTool, ToolRegistryRow } from '../shared/tool-types.js';
    ```

    Class: `ToolRegistryRepository`
    - Constructor takes `db: BetterSqlite3.Database` (NO projectHash -- registry is queried across scopes).
    - Prepare ALL statements in constructor (same pattern as ObservationRepository):

    **stmtUpsert** -- INSERT INTO tool_registry (name, tool_type, scope, source, project_hash, description, server_name, discovered_at) VALUES (?, ?, ?, ?, ?, ?, ?, datetime('now')) ON CONFLICT (name, COALESCE(project_hash, '')) DO UPDATE SET description = COALESCE(excluded.description, tool_registry.description), source = excluded.source, updated_at = datetime('now')

    **stmtRecordUsage** -- UPDATE tool_registry SET usage_count = usage_count + 1, last_used_at = datetime('now'), updated_at = datetime('now') WHERE name = ? AND COALESCE(project_hash, '') = COALESCE(?, '')

    **stmtGetByScope** -- SELECT * FROM tool_registry WHERE (scope = 'global' OR project_hash = ?) ORDER BY usage_count DESC, discovered_at DESC

    **stmtGetByName** -- SELECT * FROM tool_registry WHERE name = ? ORDER BY usage_count DESC LIMIT 1

    **stmtGetAll** -- SELECT * FROM tool_registry ORDER BY usage_count DESC, discovered_at DESC

    Methods:

    1. `upsert(tool: DiscoveredTool): void` -- runs stmtUpsert with all fields from the DiscoveredTool interface. Wraps in try/catch with debug logging.

    2. `recordUsage(name: string, projectHash: string | null): void` -- runs stmtRecordUsage. This is called from organic PostToolUse discovery to increment usage.

    3. `recordOrCreate(name: string, defaults: Omit<DiscoveredTool, 'name'>): void` -- First tries recordUsage. If stmtRecordUsage.run().changes === 0 (tool not yet in registry), calls upsert with the full tool info. This is the entry point for organic discovery -- it's an upsert-and-increment-if-exists pattern.

    4. `getForProject(projectHash: string): ToolRegistryRow[]` -- returns global tools + project-specific tools.

    5. `getByName(name: string): ToolRegistryRow | null` -- returns the top-usage entry for a given tool name.

    6. `getAll(): ToolRegistryRow[]` -- returns all tools in the registry (for debugging/admin).

    7. `count(): number` -- returns total number of tools in registry.

    IMPORTANT: Wrap the constructor's `db.prepare()` calls in a try/catch. If the tool_registry table does not exist (pre-migration-16 database), the constructor should throw, and callers should catch this gracefully (same pattern as ResearchBufferRepository in handler.ts).

    Add a debug() log in the constructor: `debug('tool-registry', 'ToolRegistryRepository initialized')`.
  </action>
  <verify>
    1. `npx tsc --noEmit` passes.
    2. `npm run build` succeeds.
    3. Read src/storage/tool-registry.ts and confirm it has: constructor with 5+ prepared statements, upsert(), recordUsage(), recordOrCreate(), getForProject(), getByName(), getAll(), count() methods.
    4. Verify DiscoveredTool and ToolRegistryRow imports come from '../shared/tool-types.js'.
  </verify>
  <done>
    - src/storage/tool-registry.ts exists with ToolRegistryRepository class.
    - All 7 methods are implemented with prepared statements.
    - Constructor follows the same pattern as ObservationRepository (prepare all statements once).
    - recordOrCreate uses the upsert-then-increment pattern for organic discovery.
    - Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors (all type imports resolve).
2. `npm run build` succeeds (new files compile correctly).
3. Migration 16 is version 16 and creates tool_registry with the COALESCE unique index.
4. ToolRegistryRepository has prepared statements for upsert, usage recording, and scoped queries.
5. No existing files broken -- migrations.ts is the only modified file, with one new entry appended.
</verification>

<success_criteria>
- Three files exist: src/shared/tool-types.ts, src/storage/tool-registry.ts, and updated src/storage/migrations.ts.
- Types are clean: ToolType, ToolScope, DiscoveredTool, ToolRegistryRow all properly exported.
- Migration 16 creates tool_registry table with UNIQUE INDEX on (name, COALESCE(project_hash, '')).
- ToolRegistryRepository follows existing repository patterns (prepared statements in constructor, debug logging).
- Build compiles without errors.
</success_criteria>

<output>
After completion, create `.planning/phases/10-tool-discovery-registry/10-01-SUMMARY.md`
</output>
