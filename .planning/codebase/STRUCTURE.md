# Codebase Structure

**Analysis Date:** 2026-02-14

## Directory Layout

```
/data/Laminark/
├── .planning/              # GSD planning documents (research, phases, todos, codebase)
├── src/                    # TypeScript source code
│   ├── analysis/           # Embedding engine (worker thread, hybrid selector, engines)
│   │   ├── engines/        # Embedding implementations (piggyback, local-onnx, keyword-only)
│   │   └── __tests__/      # Analysis tests
│   ├── commands/           # CLI commands (resume, stash)
│   │   └── __tests__/      # Command tests
│   ├── config/             # Configuration loaders (graph extraction, topic detection, haiku)
│   ├── context/            # Dependency injection utilities
│   ├── curation/           # Summarization agents
│   ├── graph/              # Knowledge graph (schema, curation, entity extraction, relationships)
│   │   ├── migrations/     # Graph schema migrations
│   │   └── __tests__/      # Graph tests
│   ├── hooks/              # Hook handler pipeline (capture, filters, privacy, session lifecycle)
│   │   └── __tests__/      # Hook tests
│   ├── intelligence/       # AI agents (Haiku classifier/entity/relationship, topic detector, adaptive threshold)
│   │   └── __tests__/      # Intelligence tests
│   ├── mcp/                # MCP server implementation
│   │   ├── tools/          # MCP tool handlers (recall, save-memory, topic-context, query-graph, etc.)
│   │   │   └── __tests__/  # Tool tests
│   │   └── __tests__/      # MCP tests
│   ├── paths/              # Debug path tracking (reasoning traces)
│   ├── routing/            # Tool suggestion intelligence (conversation router, intent patterns)
│   ├── search/             # Hybrid search (RRF fusion)
│   │   └── __tests__/      # Search tests
│   ├── shared/             # Shared types and configuration utilities
│   ├── storage/            # Storage layer (database, repositories, migrations, search)
│   │   ├── migrations/     # Storage schema migrations
│   │   └── __tests__/      # Storage tests
│   ├── types/              # Domain types (stash, etc.)
│   ├── web/                # Web visualization server
│   │   └── routes/         # REST API routes (api, sse, admin)
│   └── index.ts            # MCP server entry point
├── plugin/                 # Claude Code plugin distribution
│   ├── .claude-plugin/     # Plugin manifest
│   ├── dist/               # Compiled plugin output (generated)
│   ├── scripts/            # Installation scripts (install.sh, update.sh, verify-install.sh)
│   ├── skills/             # Plugin skills (status check)
│   └── ui/                 # Web UI static assets
├── dist/                   # Compiled JavaScript output (generated by tsdown)
├── node_modules/           # NPM dependencies
├── package.json            # Package manifest and scripts
├── tsconfig.json           # TypeScript compiler configuration
└── vitest.config.ts        # Test runner configuration
```

## Directory Purposes

**`src/analysis/`**
- Purpose: Embedding generation via worker thread with engine selection
- Contains: AnalysisWorker (main thread bridge), worker (worker thread entry), hybrid-selector, embedding engines (piggyback, local-onnx, keyword-only)
- Key files: `worker-bridge.ts`, `worker.ts`, `hybrid-selector.ts`, `engines/piggyback.ts`

**`src/hooks/`**
- Purpose: Hook handler pipeline for capturing tool execution events
- Contains: Filter stages (privacy, admission, self-referential, save guard), extraction, session lifecycle
- Key files: `handler.ts`, `capture.ts`, `privacy-filter.ts`, `admission-filter.ts`, `save-guard.ts`, `session-lifecycle.ts`

**`src/mcp/`**
- Purpose: MCP server implementation and tool registration
- Contains: Server creation, tool handlers (recall, save-memory, topic-context, query-graph, graph-stats, status, discover-tools, report-tools, debug-paths)
- Key files: `server.ts`, `tools/recall.ts`, `tools/save-memory.ts`, `tools/topic-context.ts`, `status-cache.ts`, `token-budget.ts`

**`src/storage/`**
- Purpose: Core storage engine with repository pattern
- Contains: Database connection, schema migrations, repository classes (observations, sessions, embeddings, research-buffer, stash-manager, threshold-store, notifications, tool-registry)
- Key files: `database.ts`, `observations.ts`, `sessions.ts`, `embeddings.ts`, `search.ts`, `migrations.ts`, `tool-registry.ts`

**`src/graph/`**
- Purpose: Knowledge graph implementation (nodes, edges, constraints)
- Contains: Schema, entity extraction, relationship detection, curation agent, observation merger, deduplication, temporal decay, staleness detection
- Key files: `schema.ts`, `types.ts`, `curation-agent.ts`, `entity-extractor.ts`, `relationship-detector.ts`, `observation-merger.ts`, `fuzzy-dedup.ts`, `constraints.ts`, `temporal-decay.ts`, `staleness.ts`

**`src/intelligence/`**
- Purpose: AI agents for classification, entity/relationship extraction, topic detection
- Contains: Haiku processor (orchestrator), Haiku agents (classifier, entity, relationship), topic detector, adaptive threshold manager
- Key files: `haiku-processor.ts`, `haiku-classifier-agent.ts`, `haiku-entity-agent.ts`, `haiku-relationship-agent.ts`, `topic-detector.ts`, `adaptive-threshold.ts`, `haiku-client.ts`

**`src/web/`**
- Purpose: Web visualization server (Hono REST API + SSE)
- Contains: Server setup, route handlers (API, SSE, admin)
- Key files: `server.ts`, `routes/api.ts`, `routes/sse.ts`, `routes/admin.ts`

**`src/routing/`**
- Purpose: Tool suggestion intelligence based on conversation patterns
- Contains: Conversation router, intent pattern detection, heuristic fallback
- Key files: `conversation-router.ts`, `intent-patterns.ts`, `heuristic-fallback.ts`, `types.ts`

**`src/paths/`**
- Purpose: Debug path tracking for multi-step reasoning traces
- Contains: Path tracker, path repository, KISS summary agent
- Key files: `path-tracker.ts`, `path-repository.ts`, `kiss-summary-agent.ts`, `schema.ts`, `path-recall.ts`

**`src/shared/`**
- Purpose: Shared types, configuration utilities, debugging
- Contains: Type definitions (Observation, Session, SearchResult), config helpers, debug logger, similarity functions
- Key files: `types.ts`, `config.ts`, `debug.ts`, `similarity.ts`, `tool-types.ts`

**`plugin/`**
- Purpose: Claude Code plugin distribution package
- Contains: Plugin manifest, compiled output, installation scripts, skills, web UI
- Key files: `.claude-plugin/plugin.json`, `scripts/install.sh`, `skills/status/`, `ui/`

## Key File Locations

**Entry Points:**
- `src/index.ts`: MCP server entry point (initializes database, background agents, registers tools)
- `src/hooks/handler.ts`: Hook handler entry point (stdin JSON → filter pipeline → database)
- `src/web/server.ts`: Web server entry point (Hono app with REST API + SSE)
- `src/analysis/worker.ts`: Worker thread entry point (embedding generation)

**Configuration:**
- `package.json`: Package manifest, scripts, dependencies, bin exports (laminark-server, laminark-hook)
- `tsconfig.json`: TypeScript compiler options (ES2024, NodeNext, strict mode)
- `plugin/.claude-plugin/plugin.json`: Claude Code plugin manifest
- `src/config/graph-extraction-config.ts`: Knowledge graph extraction config
- `src/config/topic-detection-config.ts`: Topic shift detection config
- `src/config/haiku-config.ts`: Haiku API config

**Core Logic:**
- `src/storage/database.ts`: Database connection and initialization
- `src/storage/observations.ts`: Observation CRUD operations
- `src/storage/embeddings.ts`: Vector embedding storage (sqlite-vec)
- `src/storage/search.ts`: Hybrid search (keyword FTS5 + vector similarity)
- `src/graph/schema.ts`: Knowledge graph schema (nodes, edges)
- `src/intelligence/haiku-processor.ts`: Background orchestrator for Haiku agents
- `src/graph/curation-agent.ts`: Background graph maintenance
- `src/hooks/handler.ts`: Hook event processing pipeline

**Testing:**
- `src/storage/__tests__/`: Storage layer tests
- `src/graph/__tests__/`: Graph tests (curation, relationship detection, temporal decay, fuzzy dedup)
- `src/intelligence/__tests__/`: Intelligence tests (adaptive threshold)
- `src/hooks/__tests__/`: Hook tests
- `src/mcp/tools/__tests__/`: MCP tool tests
- `src/analysis/__tests__/`: Analysis tests (embedder, hybrid selector, piggyback)

## Naming Conventions

**Files:**
- TypeScript source: `lowercase-kebab.ts` (e.g., `crash-recovery.test.ts`, `haiku-classifier-agent.ts`)
- Barrel exports: `index.ts` in each directory
- Test files: `*.test.ts` co-located with source in `__tests__/` subdirectory
- Config files: `*.config.ts` (e.g., `vitest.config.ts`)

**Directories:**
- Source directories: `lowercase` (e.g., `storage`, `graph`, `intelligence`)
- Test directories: `__tests__/` (double underscore prefix/suffix)

**Classes:**
- PascalCase with descriptive suffix: `ObservationRepository`, `AnalysisWorker`, `HaikuProcessor`, `CurationAgent`, `TopicShiftHandler`

**Interfaces/Types:**
- PascalCase: `Observation`, `Session`, `SearchResult`, `GraphNode`, `GraphEdge`, `EntityType`, `RelationshipType`
- Row types (database layer): `ObservationRow` (snake_case fields)
- Application types: camelCase fields (e.g., `projectHash`, `sessionId`)

**Functions:**
- camelCase: `openDatabase()`, `runMigrations()`, `rowToObservation()`, `getProjectHash()`, `classifyWithHaiku()`

## Where to Add New Code

**New MCP Tool:**
- Primary code: `src/mcp/tools/new-tool.ts`
- Registration: Add `registerNewTool()` call in `src/index.ts`
- Tests: `src/mcp/tools/__tests__/new-tool.test.ts`

**New Background Agent:**
- Primary code: `src/intelligence/new-agent.ts` or `src/graph/new-agent.ts`
- Lifecycle: Implement start()/stop() methods with timer-based polling
- Integration: Start in `src/index.ts` after database initialization
- Tests: `src/intelligence/__tests__/new-agent.test.ts`

**New Repository:**
- Primary code: `src/storage/new-entity.ts`
- Export: Add to `src/storage/index.ts`
- Tests: `src/storage/__tests__/new-entity.test.ts`
- Pattern: Constructor receives db + projectHash, prepare all statements in constructor

**New Migration:**
- Add to `MIGRATIONS` array in `src/storage/migrations.ts`
- Increment version number sequentially
- Include up SQL and descriptive name

**New Filter:**
- Primary code: `src/hooks/new-filter.ts`
- Integration: Add to filter pipeline in `src/hooks/handler.ts` processPostToolUseFiltered
- Tests: `src/hooks/__tests__/new-filter.test.ts`
- Pattern: Pure function, early return on rejection, export for testing

**New Knowledge Graph Feature:**
- Nodes/edges: Update `src/graph/schema.ts`
- Types: Add to `src/graph/types.ts` (const arrays + union types)
- Extraction: Update `src/intelligence/haiku-entity-agent.ts` or `src/intelligence/haiku-relationship-agent.ts`
- Constraints: Update `src/graph/constraints.ts`

**New Web API Endpoint:**
- Primary code: `src/web/routes/api.ts` (REST) or `src/web/routes/sse.ts` (SSE)
- Integration: Route registered in `src/web/server.ts`
- Pattern: Hono route handler with db from context

**Utilities:**
- Shared helpers: `src/shared/` (types, config, debug, similarity)
- Graph helpers: `src/graph/` (constraints, dedup, temporal)
- Hook helpers: `src/hooks/` (filters, extraction)

## Special Directories

**`.planning/`**
- Purpose: GSD planning system documents (research, phase plans, codebase analysis)
- Generated: Manually by GSD commands
- Committed: Yes (planning docs tracked in git)

**`dist/`**
- Purpose: Compiled JavaScript output for npm distribution
- Generated: Yes (by `tsdown` via `npm run build`)
- Committed: No (in `.gitignore`, built on `npm publish`)

**`plugin/dist/`**
- Purpose: Compiled plugin output for Claude Code
- Generated: Yes (by `tsdown` via `npm run build`)
- Committed: Yes (plugin requires pre-built dist/)

**`plugin/ui/`**
- Purpose: Web visualization static assets (HTML, CSS, JS)
- Generated: No (written manually)
- Committed: Yes (served by web server)

**`src/*/__tests__/`**
- Purpose: Test suites co-located with source
- Generated: No (written manually)
- Committed: Yes (tests tracked in git)
- Note: Co-located with source in `__tests__/` subdirectory per Vitest conventions

**`src/storage/migrations/`**
- Purpose: Legacy migration files (now consolidated into migrations.ts)
- Generated: No
- Committed: Yes (historical reference)

**`src/graph/migrations/`**
- Purpose: Legacy graph migration files (now consolidated into schema.ts)
- Generated: No
- Committed: Yes (historical reference)

---

*Structure analysis: 2026-02-14*
