# Codebase Structure

**Analysis Date:** 2026-02-08

## Directory Layout

```
/data/Laminark/
├── .planning/              # GSD planning documents (research, phases, todos, codebase)
│   ├── codebase/           # Codebase mapping documents (this directory)
│   ├── phases/             # Phase-specific plans and summaries (01-08)
│   ├── research/           # Initial research docs (STACK, FEATURES, ARCHITECTURE, etc.)
│   └── todos/              # Pending and done task tracking
├── src/                    # TypeScript source code
│   ├── storage/            # Storage layer (database, repositories, migrations, search)
│   │   └── __tests__/      # Storage layer tests
│   ├── shared/             # Shared types and configuration utilities
│   └── index.ts            # Package entry point
├── dist/                   # Compiled JavaScript output (generated by tsdown)
├── node_modules/           # NPM dependencies
├── package.json            # Package manifest and scripts
├── tsconfig.json           # TypeScript compiler configuration
├── tsdown.config.ts        # Build tool configuration (tsdown)
├── vitest.config.ts        # Test runner configuration
└── .gitignore              # Git exclusions
```

## Directory Purposes

**`.planning/`**
- Purpose: GSD command system planning and documentation
- Contains: Research docs, phase plans, todos, codebase analysis
- Key files: `research/ARCHITECTURE.md`, `phases/01-storage-engine/01-01-PLAN.md`

**`src/storage/`**
- Purpose: Core storage engine implementation
- Contains: Database connection, schema migrations, repository classes, FTS5 search
- Key files: `database.ts`, `observations.ts`, `sessions.ts`, `search.ts`, `migrations.ts`, `index.ts`

**`src/storage/__tests__/`**
- Purpose: Storage layer test suite
- Contains: Unit and integration tests for database, repositories, search, concurrency, crash recovery
- Key files: `database.test.ts`, `repositories.test.ts`, `search.test.ts`, `concurrency.test.ts`, `crash-recovery.test.ts`, `persistence.test.ts`

**`src/shared/`**
- Purpose: Shared types and configuration utilities
- Contains: Type definitions (interfaces, Zod schemas, mapping helpers), config helpers
- Key files: `types.ts`, `config.ts`

**`dist/`**
- Purpose: Compiled JavaScript output for distribution
- Contains: `.js`, `.d.ts`, `.d.ts.map`, `.js.map` files generated from `src/`
- Generated: Yes (by `tsdown` via `npm run build`)
- Committed: No (in `.gitignore`)

**`node_modules/`**
- Purpose: NPM package dependencies
- Contains: better-sqlite3, sqlite-vec, zod, vitest, typescript, etc.
- Generated: Yes (by `npm install`)
- Committed: No (in `.gitignore`)

## Key File Locations

**Entry Points:**
- `src/index.ts`: Package entry point (re-exports storage API)
- `dist/index.js`: Compiled CLI entry point (bin: `laminark-server`)

**Configuration:**
- `package.json`: Package manifest, scripts, dependencies
- `tsconfig.json`: TypeScript compiler options (ES2024, NodeNext, strict mode)
- `tsdown.config.ts`: Build configuration for tsdown bundler
- `vitest.config.ts`: Test runner configuration

**Core Logic:**
- `src/storage/database.ts`: Database connection and initialization
- `src/storage/observations.ts`: Observation CRUD operations
- `src/storage/sessions.ts`: Session lifecycle management
- `src/storage/search.ts`: FTS5 full-text search with BM25 ranking
- `src/storage/migrations.ts`: Schema versioning and migrations
- `src/shared/types.ts`: Type definitions and mapping helpers
- `src/shared/config.ts`: Configuration utilities (project hash, db path)

**Testing:**
- `src/storage/__tests__/database.test.ts`: Database initialization tests
- `src/storage/__tests__/repositories.test.ts`: Repository CRUD tests
- `src/storage/__tests__/search.test.ts`: FTS5 search tests
- `src/storage/__tests__/concurrency.test.ts`: Concurrent access tests
- `src/storage/__tests__/crash-recovery.test.ts`: Crash recovery tests
- `src/storage/__tests__/persistence.test.ts`: Data persistence tests
- `src/storage/__tests__/test-utils.ts`: Test helper utilities

## Naming Conventions

**Files:**
- TypeScript source: `lowercase-kebab.ts` (e.g., `crash-recovery.test.ts`)
- Barrel exports: `index.ts` in each directory
- Test files: `*.test.ts` co-located with source in `__tests__/` subdirectory
- Config files: `*.config.ts` (e.g., `tsdown.config.ts`, `vitest.config.ts`)

**Directories:**
- Source directories: `lowercase` (e.g., `storage`, `shared`)
- Test directories: `__tests__/` (double underscore prefix/suffix)
- Planning directories: `lowercase-kebab` (e.g., `01-storage-engine`)

**Classes:**
- PascalCase with descriptive suffix: `ObservationRepository`, `SessionRepository`, `SearchEngine`

**Interfaces/Types:**
- PascalCase: `Observation`, `Session`, `SearchResult`, `DatabaseConfig`, `LaminarkDatabase`
- Row types (database layer): `ObservationRow`, `SessionRow` (snake_case fields)
- Application types: camelCase fields (e.g., `projectHash`, `sessionId`)

**Functions:**
- camelCase: `openDatabase()`, `runMigrations()`, `rowToObservation()`, `getProjectHash()`

## Where to Add New Code

**New Repository:**
- Primary code: `src/storage/new-entity.ts`
- Export: Add to `src/storage/index.ts`
- Tests: `src/storage/__tests__/new-entity.test.ts`

**New Migration:**
- Add to `MIGRATIONS` array in `src/storage/migrations.ts`
- Increment version number sequentially
- Include up SQL and descriptive name

**New Shared Type:**
- Add to `src/shared/types.ts`
- Export interface and Zod schema (if input validation needed)
- Add mapping function if converting from database row

**New Configuration:**
- Add to `src/shared/config.ts`
- Export function for retrieving config value
- Document default values and environment variable sources (if any)

**New Test Utilities:**
- Add to `src/storage/__tests__/test-utils.ts`
- Export helper functions for test setup/teardown

**Future MCP Server:**
- Primary code: `src/mcp/` (new directory for Phase 2)
- Server entry point: Update `src/index.ts` to initialize MCP server
- Handler registration: `src/mcp/handlers/` for tool/resource handlers

## Special Directories

**`.planning/`**
- Purpose: GSD planning system documents (research, phase plans, codebase analysis)
- Generated: Manually by GSD commands
- Committed: Yes (planning docs tracked in git)

**`dist/`**
- Purpose: Compiled JavaScript output for npm distribution
- Generated: Yes (by `tsdown` via `npm run build`)
- Committed: No (in `.gitignore`, built on `npm publish`)

**`node_modules/`**
- Purpose: NPM package dependencies
- Generated: Yes (by `npm install`)
- Committed: No (in `.gitignore`)

**`src/storage/__tests__/`**
- Purpose: Storage layer test suite
- Generated: No (written manually)
- Committed: Yes (tests tracked in git)
- Note: Co-located with source in `__tests__/` subdirectory per Vitest conventions

---

*Structure analysis: 2026-02-08*
