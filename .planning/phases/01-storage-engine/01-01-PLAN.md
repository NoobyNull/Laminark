---
phase: 01-storage-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - tsdown.config.ts
  - vitest.config.ts
  - .gitignore
  - src/shared/types.ts
  - src/shared/config.ts
  - src/storage/index.ts
autonomous: true

must_haves:
  truths:
    - "npm install completes without errors"
    - "tsc --noEmit passes with zero type errors"
    - "vitest runs and reports zero tests (infrastructure works)"
    - "tsdown builds src/storage/index.ts to dist/ without errors"
  artifacts:
    - path: "package.json"
      provides: "Project manifest with all Phase 1 dependencies"
      contains: "better-sqlite3"
    - path: "tsconfig.json"
      provides: "TypeScript configuration for Node.js 22 ESM"
      contains: "NodeNext"
    - path: "src/shared/types.ts"
      provides: "Core type definitions for observations, sessions, project scoping"
      exports: ["Observation", "Session", "ProjectScope"]
    - path: "src/shared/config.ts"
      provides: "Configuration management for database path resolution"
      exports: ["getConfig", "getDbPath"]
    - path: "src/storage/index.ts"
      provides: "Storage module barrel export"
  key_links:
    - from: "src/shared/config.ts"
      to: "~/.memorite/data/<project-hash>/memorite.db"
      via: "getDbPath computes deterministic path from project directory"
      pattern: "createHash.*sha256"
---

<objective>
Project scaffolding, TypeScript configuration, and dependency installation for Memorite Phase 1.

Purpose: Establish the build toolchain, type system, and dependency graph so all subsequent plans can import types and compile code without setup friction.
Output: A buildable, testable TypeScript project with core type definitions and configuration utilities.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Node.js project with TypeScript, build tooling, and Phase 1 dependencies</name>
  <files>
    package.json
    tsconfig.json
    tsdown.config.ts
    vitest.config.ts
    .gitignore
  </files>
  <action>
    1. Run `npm init -y` to create package.json. Update it to set:
       - `"name": "memorite"`
       - `"version": "0.1.0"`
       - `"type": "module"` (ESM-first)
       - `"engines": { "node": ">=22.0.0" }`
       - `"main": "dist/index.js"` and `"types": "dist/index.d.ts"`
       - Scripts: `"build": "tsdown"`, `"check": "tsc --noEmit"`, `"test": "vitest run"`, `"test:watch": "vitest"`

    2. Install production dependencies:
       `npm install better-sqlite3 sqlite-vec zod`
       Note: @modelcontextprotocol/sdk is Phase 2. Only install what Phase 1 needs.

    3. Install dev dependencies:
       `npm install -D typescript @types/better-sqlite3 @types/node tsdown vitest`

    4. Create tsconfig.json:
       - `"target": "ES2024"` (Node.js 22 supports this)
       - `"module": "NodeNext"`, `"moduleResolution": "NodeNext"`
       - `"outDir": "dist"`, `"rootDir": "src"`
       - `"strict": true`, `"esModuleInterop": true`, `"skipLibCheck": true`
       - `"declaration": true`, `"declarationMap": true`, `"sourceMap": true`
       - Include: `["src/**/*.ts"]`, Exclude: `["node_modules", "dist", "**/*.test.ts"]`

    5. Create tsdown.config.ts:
       ```typescript
       import { defineConfig } from 'tsdown';
       export default defineConfig({
         entry: ['src/storage/index.ts'],
         format: ['esm'],
         dts: true,
         clean: true,
         outDir: 'dist',
       });
       ```

    6. Create vitest.config.ts:
       ```typescript
       import { defineConfig } from 'vitest/config';
       export default defineConfig({
         test: {
           globals: true,
           include: ['src/**/*.test.ts'],
         },
       });
       ```

    7. Create .gitignore with: node_modules/, dist/, *.db, *.db-wal, *.db-shm, .env, .DS_Store

    Do NOT install @huggingface/transformers, hono, or cytoscape -- those are for later phases.
  </action>
  <verify>
    Run these commands in sequence:
    1. `npm install` completes with exit code 0
    2. `npx tsc --noEmit` exits 0 (may need empty src files first)
    3. `npx vitest run` exits 0 with "no test files found" or similar
    4. `npx tsdown` builds without errors (may produce empty output until source files exist)
  </verify>
  <done>
    package.json has correct dependencies (better-sqlite3, sqlite-vec, zod as production; typescript, @types/better-sqlite3, @types/node, tsdown, vitest as dev). tsconfig.json targets ES2024 with NodeNext module resolution. Build and test commands work.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create core type definitions and project-scoped configuration</name>
  <files>
    src/shared/types.ts
    src/shared/config.ts
    src/storage/index.ts
  </files>
  <action>
    1. Create `src/shared/types.ts` with these type definitions:

       - `ProjectScope`: `{ projectDir: string; projectHash: string; }` -- identifies a project by its directory path and its deterministic hash
       - `Observation`: `{ id: string; projectHash: string; content: string; source: string; sessionId: string | null; embedding: Float32Array | null; embeddingModel: string | null; embeddingVersion: string | null; createdAt: string; updatedAt: string; deletedAt: string | null; }` -- the core memory unit. Note: embedding fields are nullable from day one (MEM-09 requires model version metadata). Use ISO 8601 strings for dates (SQLite stores text). `source` tracks where the observation came from (e.g., "hook:PostToolUse", "mcp:save_memory", "manual").
       - `Session`: `{ id: string; projectHash: string; startedAt: string; endedAt: string | null; summary: string | null; }` -- session lifecycle tracking
       - `ObservationInsert`: Omit<Observation, 'id' | 'createdAt' | 'updatedAt' | 'deletedAt'> -- for creating new observations
       - `SearchResult`: `{ observation: Observation; score: number; matchType: 'fts' | 'vector' | 'hybrid'; snippet: string; }` -- search result with ranking info
       - `DatabaseConfig`: `{ dbPath: string; busyTimeout: number; walMode: boolean; }` -- database connection config

       Use Zod schemas for runtime validation alongside TypeScript types. Export both the Zod schema and the inferred type for each. Example pattern:
       ```typescript
       import { z } from 'zod';
       export const ObservationInsertSchema = z.object({ ... });
       export type ObservationInsert = z.infer<typeof ObservationInsertSchema>;
       ```

    2. Create `src/shared/config.ts`:

       - `getProjectHash(projectDir: string): string` -- creates a deterministic SHA-256 hash of the absolute project directory path, truncated to first 16 hex chars. Use `node:crypto` createHash.
       - `getDbPath(projectDir: string): string` -- returns `~/.memorite/data/<projectHash>/memorite.db`. Resolves `~` to `os.homedir()`. Creates directory recursively if it does not exist using `fs.mkdirSync({ recursive: true })`.
       - `getConfig(projectDir: string): DatabaseConfig` -- returns full config with defaults: busyTimeout 5000ms, walMode true.
       - `DEFAULT_BUSY_TIMEOUT = 5000` -- exported constant per research (>=5000ms prevents SQLITE_BUSY)
       - Ensure `getDbPath` always uses canonical absolute paths (resolve symlinks with `fs.realpathSync`) to prevent the SQLite corruption vector of multiple paths to same file.

    3. Create `src/storage/index.ts` as a barrel export file:
       ```typescript
       // Storage module - populated in Plan 02
       export {};
       ```
       This is a placeholder so the build toolchain has something to compile.

    After creating files, run `npx tsc --noEmit` to verify types compile, and `npx tsdown` to verify the build succeeds.
  </action>
  <verify>
    1. `npx tsc --noEmit` passes with zero errors
    2. `npx tsdown` builds to dist/ successfully
    3. `node -e "import('./dist/storage/index.js')"` loads without error (ESM import test)
    4. Grep confirms: types.ts exports Observation, Session, ProjectScope, ObservationInsert, SearchResult, DatabaseConfig
    5. Grep confirms: config.ts exports getProjectHash, getDbPath, getConfig
    6. Grep confirms: config.ts uses createHash('sha256') for deterministic project hashing
    7. Grep confirms: config.ts uses realpathSync for canonical path resolution
  </verify>
  <done>
    Core types (Observation with nullable embedding + model version metadata, Session, ProjectScope, SearchResult, DatabaseConfig) are defined with both Zod schemas and TypeScript types. Config utilities compute deterministic database paths per project directory using SHA-256 hashing. The storage barrel export exists as a build target. `tsc --noEmit` and `tsdown` both succeed.
  </done>
</task>

</tasks>

<verification>
- `npm install && npx tsc --noEmit && npx vitest run && npx tsdown` all pass
- src/shared/types.ts defines all core types with Zod schemas
- src/shared/config.ts resolves project-scoped database paths deterministically
- No Phase 2+ dependencies installed (no MCP SDK, no hono, no huggingface)
</verification>

<success_criteria>
- Project compiles, builds, and test runner works
- Core types include embedding + model version fields (MEM-09)
- Database path is project-scoped via hash (MEM-06)
- Config defaults include busyTimeout >= 5000ms (MEM-07/MEM-08)
</success_criteria>

<output>
After completion, create `.planning/phases/01-storage-engine/01-01-SUMMARY.md`
</output>
