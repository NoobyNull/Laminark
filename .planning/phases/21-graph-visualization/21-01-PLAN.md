---
phase: 21-graph-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/web/routes/api.ts
  - src/web/routes/sse.ts
  - ui/app.js
autonomous: true

must_haves:
  truths:
    - "GET /api/paths returns a JSON array of recent debug paths"
    - "GET /api/paths/:id returns a single path with its waypoints"
    - "SSE broadcasts path_started, path_waypoint, and path_resolved events to connected clients"
  artifacts:
    - path: "src/web/routes/api.ts"
      provides: "Path REST endpoints"
      contains: "apiRoutes.get('/paths'"
    - path: "src/web/routes/sse.ts"
      provides: "SSE broadcast infrastructure (already exists)"
    - path: "ui/app.js"
      provides: "SSE event listeners for path events"
      contains: "path_started"
  key_links:
    - from: "src/web/routes/api.ts"
      to: "src/paths/path-repository.ts"
      via: "PathRepository instantiation with db and projectHash"
      pattern: "new PathRepository"
    - from: "ui/app.js"
      to: "window.laminarkGraph"
      via: "SSE event dispatch triggers graph overlay update"
      pattern: "laminark:path_"
---

<objective>
Add REST API endpoints for debug paths and wire SSE events for live path updates.

Purpose: The D3 overlay (Plan 02) and detail panel (Plan 03) need backend data sources. This plan creates the API endpoints and SSE event wiring that all frontend plans depend on.

Output: Three new API routes and SSE event listeners in the frontend.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/paths/path-repository.ts
@src/paths/types.ts
@src/web/routes/api.ts
@src/web/routes/sse.ts
@ui/app.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add path REST API endpoints</name>
  <files>src/web/routes/api.ts</files>
  <action>
Add three new endpoints to the existing apiRoutes in src/web/routes/api.ts:

1. **GET /api/paths** — List recent debug paths
   - Import PathRepository from '../../paths/path-repository.js' and PathWaypoint from '../../paths/types.js'
   - Instantiate `new PathRepository(db, projectHash)` using getDb(c) and getProjectHash(c)
   - Call `repo.listPaths(limit)` where limit comes from ?limit query param (default 20, max 50)
   - Return JSON: `{ paths: DebugPath[] }`

2. **GET /api/paths/active** — Get the currently active path
   - Same PathRepository pattern
   - Call `repo.getActivePath()`
   - Return JSON: `{ path: DebugPath | null }`

3. **GET /api/paths/:id** — Get a single path with its waypoints
   - Call `repo.getPath(pathId)` and `repo.getWaypoints(pathId)`
   - If path not found, return 404 with `{ error: 'Path not found' }`
   - Parse kiss_summary from JSON string back to object if present
   - Return JSON: `{ path: DebugPath, waypoints: PathWaypoint[] }`

All endpoints follow the existing pattern: use getDb(c) for database, getProjectHash(c) for project scoping, wrap in try/catch. Place the :id route AFTER /active and /paths to avoid route matching conflicts (Hono matches in registration order).
  </action>
  <verify>Run `npx tsx -e "import('./src/web/routes/api.js')"` to verify no import errors. Grep for 'paths' in api.ts to confirm all three endpoints exist.</verify>
  <done>Three path API endpoints registered on apiRoutes, importable without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Wire SSE path events in frontend</name>
  <files>ui/app.js</files>
  <action>
Add three new SSE event listeners in ui/app.js, following the exact pattern of existing listeners (entity_updated, topic_shift, etc.):

1. In the connectSSE() function, add listeners for:
   - `path_started`: Parse JSON, recordEventReceived(), dispatch CustomEvent `laminark:path_started` with detail
   - `path_waypoint`: Parse JSON, recordEventReceived(), dispatch CustomEvent `laminark:path_waypoint` with detail
   - `path_resolved`: Parse JSON, recordEventReceived(), dispatch CustomEvent `laminark:path_resolved` with detail

2. In the DOMContentLoaded handler (after the existing SSE event listeners around line 1226), add document event listeners:
   - `laminark:path_started`: If window.laminarkGraph and window.laminarkGraph.addPathOverlay, call it with e.detail
   - `laminark:path_waypoint`: If window.laminarkGraph and window.laminarkGraph.updatePathOverlay, call it with e.detail
   - `laminark:path_resolved`: If window.laminarkGraph and window.laminarkGraph.resolvePathOverlay, call it with e.detail

These listeners use optional chaining checks (the graph overlay functions don't exist yet — Plan 02 adds them). This ensures no errors before Plan 02 is executed.

3. Add a new fetchPaths() helper function following the fetchGraphData() pattern:
   ```
   async function fetchPaths() {
     try {
       const params = new URLSearchParams();
       if (window.laminarkState.currentProject) params.set('project', window.laminarkState.currentProject);
       const res = await fetch('/api/paths' + (params.toString() ? '?' + params.toString() : ''));
       if (!res.ok) throw new Error('HTTP ' + res.status);
       return await res.json();
     } catch (err) {
       console.error('[laminark] Failed to fetch paths:', err);
       return { paths: [] };
     }
   }
   ```

   And fetchPathDetail(pathId):
   ```
   async function fetchPathDetail(pathId) {
     try {
       const res = await fetch('/api/paths/' + encodeURIComponent(pathId));
       if (!res.ok) return null;
       return await res.json();
     } catch (err) {
       console.error('[laminark] Failed to fetch path detail:', err);
       return null;
     }
   }
   ```

4. Export both new functions on window.laminarkApp (add to the existing exports object at the bottom):
   - fetchPaths: fetchPaths
   - fetchPathDetail: fetchPathDetail
  </action>
  <verify>Open ui/app.js and verify the three SSE listeners are registered in connectSSE(), the two fetch helpers exist, and the laminarkApp exports include fetchPaths and fetchPathDetail.</verify>
  <done>SSE path events dispatch to CustomEvents, fetch helpers for paths available on window.laminarkApp.</done>
</task>

</tasks>

<verification>
1. `cd /data/Laminark && npm run build` completes without errors
2. Grep confirms: `grep -c "paths" src/web/routes/api.ts` shows multiple matches for path endpoints
3. Grep confirms: `grep "path_started\|path_waypoint\|path_resolved" ui/app.js` shows all three SSE events
4. Grep confirms: `grep "fetchPaths\|fetchPathDetail" ui/app.js` shows both helpers
</verification>

<success_criteria>
- Three REST endpoints for paths (list, active, detail) exist in api.ts
- Three SSE event types wired in app.js (path_started, path_waypoint, path_resolved)
- Two fetch helpers (fetchPaths, fetchPathDetail) exported on window.laminarkApp
- Build succeeds with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-graph-visualization/21-01-SUMMARY.md`
</output>
