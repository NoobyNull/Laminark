---
phase: 08-web-visualization
plan: 04
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - ui/timeline.js
  - ui/index.html
  - ui/styles.css
autonomous: true

must_haves:
  truths:
    - "Timeline view shows a chronological vertical layout of sessions with observations inside them"
    - "Topic shift points are visually marked as dividers between observation groups"
    - "User can scroll through the timeline and see the flow of their work across sessions"
  artifacts:
    - path: "ui/timeline.js"
      provides: "Timeline rendering with sessions as lanes, observations as entries, topic shifts as dividers"
      min_lines: 100
  key_links:
    - from: "ui/timeline.js"
      to: "/api/timeline"
      via: "fetch call to load timeline data"
      pattern: "fetch.*api/timeline"
    - from: "ui/app.js"
      to: "ui/timeline.js"
      via: "script loading and SSE event dispatch"
      pattern: "memorite:new_observation|memorite:session"
---

<objective>
Build the timeline view showing chronological flow of sessions, observations, and topic shift points in a scrollable vertical layout.

Purpose: VIS-04 -- the timeline gives users a temporal perspective on their memory. While the graph shows relationships between entities, the timeline shows when things happened. Users can see their session history, observation flow, and where topic shifts occurred.
Output: A fully rendered timeline view with session cards, observation entries, topic shift markers, and scroll-based navigation.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/STACK.md
@.planning/phases/08-web-visualization/08-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build timeline rendering engine</name>
  <files>ui/timeline.js, ui/styles.css</files>
  <action>
Create ui/timeline.js as the timeline visualization module:

**Data structure:**
The timeline API returns `{ sessions, observations, topicShifts }`. The timeline module groups observations by session and inserts topic shift markers at the correct chronological positions.

**Initialization:**
- Export `initTimeline(containerId)` that targets the `#timeline-view` container
- Set up an intersection observer for lazy rendering (only render visible session cards) -- this is the basic performance pattern since the timeline can have hundreds of entries

**Rendering:**
- The timeline is a vertical scrollable list
- Structure: a central vertical line (the "spine") with session cards branching off it
- Each session card contains:
  - Session header: start time (formatted as "Mon Jan 15, 2:30 PM"), duration (e.g., "45 min"), observation count badge
  - Optional session summary text (if generated by Phase 5)
  - Observation list: each observation shows truncated text (first 120 chars with ellipsis), timestamp (relative, e.g., "2:31 PM"), and a small type indicator dot
  - Topic shift markers between observation groups: a horizontal divider with a label showing the shift direction (e.g., "Topic shifted") with a confidence indicator dot (green=high, yellow=medium)
- Sessions are ordered most-recent first (reverse chronological)
- Each session card has an expand/collapse toggle (collapsed shows just header + summary, expanded shows all observations)
- Default state: most recent 3 sessions expanded, older sessions collapsed

**Implementation approach (vanilla DOM):**
- Use `document.createElement` to build the DOM structure (no innerHTML for security)
- Create helper functions: `createSessionCard(session, observations, shifts)`, `createObservationEntry(obs)`, `createTopicShiftMarker(shift)`
- Use DocumentFragment for batch DOM insertion (performance)
- Each session card has a data attribute `data-session-id` for targeting updates

**Empty state:**
- If no timeline data, show centered message: "No sessions recorded yet. Timeline will populate as you use Claude."

**Data loading:**
- Export `loadTimelineData(range?)` that fetches from /api/timeline with optional time range params
- Transform data: group observations by sessionId, sort chronologically within each session, insert topic shifts at correct positions
- Call rendering functions to build the DOM

**Scroll behavior:**
- Smooth scroll to a specific session via `scrollToSession(sessionId)`
- "Jump to today" floating button that scrolls to the most recent session
- Infinite scroll: when user scrolls near bottom, load older sessions (fetch with offset param)
  </action>
  <verify>
1. Start the server, navigate to Timeline tab
2. If data exists: sessions appear as cards with a vertical spine, observations listed inside, topic shifts marked with dividers
3. If no data: empty state message displays
4. Click session header to expand/collapse observation list
5. "Jump to today" button scrolls to top (most recent session)
6. Scroll down to trigger loading of older sessions (if available)
  </verify>
  <done>Timeline view renders sessions as cards on a vertical spine. Observations are listed chronologically within sessions. Topic shift markers appear as labeled dividers. Sessions can be expanded/collapsed. Infinite scroll loads older data.</done>
</task>

<task type="auto">
  <name>Task 2: Wire timeline into SPA with styling and SSE updates</name>
  <files>ui/timeline.js, ui/index.html, ui/styles.css</files>
  <action>
**Update ui/index.html:**
- Add `<script src="/timeline.js"></script>` after graph.js
- Add the "Jump to today" floating button inside `#timeline-view`: `<button class="jump-today-btn" title="Jump to latest">Today</button>`

**Wire into app.js initialization:**
- When user clicks the Timeline tab (or on initial load if timeline is active), call `initTimeline('timeline-view')` followed by `loadTimelineData()`
- Lazy initialization: only initialize the Cytoscape graph or timeline when their respective tab is first activated (saves resources)

**SSE update handling in timeline.js:**
- Listen for `memorite:new_observation` custom event: prepend the new observation to the correct session card (matching sessionId). If the session card does not exist yet (new session), create a new card at the top of the timeline.
- Listen for `memorite:session_start` event: create a new empty session card at the top with "Active" badge
- Listen for `memorite:session_end` event: update the session card header to show end time and duration, remove "Active" badge
- Listen for `memorite:topic_shift` event: insert a topic shift marker at the current position in the active session

**Comprehensive CSS in ui/styles.css:**
- .timeline-container: max-width 800px, margin 0 auto, padding 24px, position relative
- .timeline-spine: position absolute, left 50%, width 2px, background var(--border), top 0, bottom 0, transform translateX(-50%)
- .session-card: position relative, background var(--surface), border 1px solid var(--border), border-radius 12px, padding 16px, margin-bottom 24px, margin-left 60px (offset from spine)
- .session-card::before: a small circle on the spine (timeline dot), position absolute, left -48px (aligns with spine), width 12px, height 12px, border-radius 50%, background var(--accent)
- .session-header: display flex, justify-content space-between, align-items center, cursor pointer
- .session-header h3: font-size 14px, font-weight 600, color var(--text)
- .session-meta: font-size 12px, color #8b949e (muted)
- .session-summary: font-size 13px, color #8b949e, margin-top 8px, font-style italic
- .observation-list: margin-top 12px, border-top 1px solid var(--border), padding-top 8px
- .observation-entry: display flex, gap 8px, padding 8px 0, border-bottom 1px solid rgba(48,54,61,0.5)
- .observation-entry .obs-time: font-size 11px, color #8b949e, min-width 60px, flex-shrink 0
- .observation-entry .obs-text: font-size 13px, color var(--text), line-height 1.4
- .topic-shift-marker: display flex, align-items center, gap 8px, padding 12px 0, color #f0883e
- .topic-shift-marker::before, .topic-shift-marker::after: content '', flex 1, height 1px, background #f0883e, opacity 0.3
- .topic-shift-marker .shift-label: font-size 11px, text-transform uppercase, letter-spacing 0.5px, white-space nowrap
- .session-badge: font-size 10px, padding 2px 8px, border-radius 10px, background var(--accent), color #0d1117
- .session-badge.active: background #3fb950, animation pulse 2s infinite (subtle green pulse for active session)
- .jump-today-btn: position fixed, bottom 24px, right 24px, z-index 10, padding 8px 16px, border-radius 20px, background var(--accent), color #0d1117, border none, cursor pointer, font-weight 600, box-shadow 0 2px 8px rgba(0,0,0,0.3)
- .session-card.collapsed .observation-list: display none
- .session-card .toggle-icon: transition transform 0.2s; .session-card.collapsed .toggle-icon: transform rotate(-90deg)
- @media (max-width: 768px): .timeline-spine display none, .session-card margin-left 0, .session-card::before display none (simplified mobile layout)
  </action>
  <verify>
1. Open Timeline tab -- sessions render with vertical spine and styled cards
2. Click session header -- observation list collapses/expands with toggle animation
3. Topic shift markers appear as orange dividers between observation groups
4. Active session (if any) shows green pulsing "Active" badge
5. "Jump to today" button in bottom-right scrolls to the latest session
6. On mobile viewport: spine and dots disappear, cards fill width
7. SSE events update the timeline in real-time (if server is sending events)
  </verify>
  <done>Timeline view is fully styled and wired into the SPA. Sessions display as cards on a vertical spine with expandable observation lists. Topic shifts are marked with orange dividers. SSE events update the timeline live. Mobile layout adapts gracefully.</done>
</task>

</tasks>

<verification>
- Timeline tab shows sessions in reverse chronological order
- Each session card has: header with time/duration, optional summary, expandable observation list
- Topic shift markers appear as styled dividers with labels
- Sessions can be expanded/collapsed
- Most recent 3 sessions start expanded, older ones collapsed
- "Jump to today" button works
- Empty state shows informative message
- Mobile layout removes spine, cards fill width
- SSE events create new session cards and prepend observations in real-time
</verification>

<success_criteria>
VIS-04 is fully delivered: the timeline view shows chronological flow of sessions, observations, and topic shift points. Users can browse their session history, see observation flow within sessions, and identify where topic shifts occurred.
</success_criteria>

<output>
After completion, create `.planning/phases/08-web-visualization/08-04-SUMMARY.md`
</output>
