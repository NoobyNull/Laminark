---
phase: 08-web-visualization
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - ui/graph.js
  - ui/index.html
autonomous: true

must_haves:
  truths:
    - "Knowledge graph renders as an interactive force-directed layout with entities as nodes and relationships as edges"
    - "Different entity types are visually distinguishable by color and shape"
    - "User can pan, zoom, and drag nodes in the graph"
  artifacts:
    - path: "ui/graph.js"
      provides: "Cytoscape graph initialization, data loading, force-directed layout, and node styling"
      min_lines: 80
  key_links:
    - from: "ui/graph.js"
      to: "/api/graph"
      via: "fetch call to load graph data"
      pattern: "fetch.*api/graph"
    - from: "ui/graph.js"
      to: "cytoscape"
      via: "Cytoscape.js initialization"
      pattern: "cytoscape\\("
    - from: "ui/app.js"
      to: "ui/graph.js"
      via: "script loading and custom event dispatch for SSE updates"
      pattern: "entity_updated|new_observation"
---

<objective>
Render the knowledge graph as an interactive Cytoscape.js force-directed layout where entities are nodes (colored/shaped by type) and relationships are edges (labeled by type).

Purpose: This is the core visualization -- VIS-02. The knowledge graph is the primary way users explore their memory. A force-directed layout makes relationships naturally visible through spatial clustering.
Output: A working interactive graph view that loads data from the REST API and renders it with Cytoscape's cose layout.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/STACK.md
@.planning/phases/08-web-visualization/08-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Cytoscape graph module with force-directed layout</name>
  <files>ui/graph.js</files>
  <action>
Create ui/graph.js as the knowledge graph visualization module:

**Initialization:**
- Export `initGraph(containerId)` that creates a Cytoscape instance targeting the `#graph-view` container
- Use the `cose` layout (built into Cytoscape, no extra plugin needed) with these settings:
  - `animate: true, animationDuration: 500`
  - `nodeRepulsion: 400000` (push nodes apart for readability)
  - `idealEdgeLength: 100`
  - `gravity: 0.25` (pull toward center, prevent drift)
  - `numIter: 1000` (enough iterations for stable layout)
- Enable user interaction: box selection disabled, panning enabled, zooming enabled (min 0.1, max 3.0), node dragging enabled
- Set the container to fill its parent: `style: { width: '100%', height: '100%' }`

**Node styling by entity type:**
Define a color + shape map for the 7 entity types from Phase 7 (INT-09):
- Project: color #58a6ff (blue), shape: round-rectangle
- File: color #7ee787 (green), shape: rectangle
- Decision: color #d2a8ff (purple), shape: diamond
- Problem: color #f85149 (red), shape: triangle
- Solution: color #3fb950 (green-bright), shape: star
- Tool: color #f0883e (orange), shape: hexagon
- Person: color #79c0ff (light-blue), shape: ellipse

Apply these via Cytoscape's style array:
```javascript
style: [
  { selector: 'node', style: {
    'label': 'data(label)',
    'text-valign': 'center',
    'font-size': '11px',
    'color': '#c9d1d9',
    'text-outline-width': 2,
    'text-outline-color': '#0d1117',
    'width': 'mapData(observationCount, 0, 50, 30, 80)',  // Size by observation count
    'height': 'mapData(observationCount, 0, 50, 30, 80)',
  }},
  // One selector per entity type, e.g.:
  { selector: 'node[type="Project"]', style: { 'background-color': '#58a6ff', 'shape': 'round-rectangle' }},
  // ... etc for all 7 types
  { selector: 'edge', style: {
    'label': 'data(type)',
    'font-size': '9px',
    'color': '#8b949e',
    'text-rotation': 'autorotate',
    'curve-style': 'bezier',
    'target-arrow-shape': 'triangle',
    'target-arrow-color': '#30363d',
    'line-color': '#30363d',
    'width': 1.5,
    'opacity': 0.7,
  }},
  { selector: 'node:selected', style: { 'border-width': 3, 'border-color': '#f0883e' }},
  { selector: 'edge:selected', style: { 'line-color': '#f0883e', 'width': 3 }},
]
```

**Data loading:**
- Export `loadGraphData(filters?)` that calls `fetchGraphData(filters)` from app.js (or directly fetches /api/graph)
- Transform API response into Cytoscape elements format:
  - Nodes: `{ data: { id, label, type, observationCount, createdAt } }`
  - Edges: `{ data: { id, source, target, type, label: type } }`
- Call `cy.add(elements)` then `cy.layout({ name: 'cose', ...settings }).run()`
- Handle empty data gracefully: show a centered message "No graph data yet. Observations will appear here as they are processed."

**Update handling:**
- Export `addNode(nodeData)` and `addEdge(edgeData)` for incremental updates (called when SSE events arrive)
- When adding a node: `cy.add({ data: nodeData })` then run a local layout animation (only re-layout the new node and its neighbors, not the entire graph) using `cy.getElementById(nodeData.id).neighborhood().layout({ name: 'cose', ... }).run()`
- Export `removeElements(ids)` for node/edge removal

**Fit to view:**
- After initial data load, call `cy.fit(undefined, 50)` to fit all elements with 50px padding
- Export `fitToView()` for manual trigger
  </action>
  <verify>
1. Start the server with some test data in the database (or mock the API to return sample nodes/edges)
2. Open http://localhost:37820 and verify the graph tab shows nodes with different colors/shapes
3. Verify nodes can be dragged, the graph can be panned (click + drag on background), and zoomed (scroll wheel)
4. Check that edge labels are visible between connected nodes
5. Verify node sizes vary based on observation count
  </verify>
  <done>Cytoscape renders a force-directed graph from API data. Entities appear as colored/shaped nodes by type. Relationships render as labeled directed edges. Users can pan, zoom, and drag. Empty state shows an informative message.</done>
</task>

<task type="auto">
  <name>Task 2: Wire graph module into SPA and add legend</name>
  <files>ui/index.html, ui/graph.js</files>
  <action>
Update ui/index.html:
- Add `<script src="/graph.js"></script>` before the closing body tag (after app.js)
- Add a graph legend element inside `#graph-view`: a small semi-transparent overlay in the bottom-left corner showing the entity type color/shape key. Use a simple HTML list with colored circles/shapes next to type names. Give it class `graph-legend`.
- Add a "Fit to View" button (small icon button) in the top-right corner of `#graph-view` that calls `fitToView()`
- Add a node count indicator in the top-left showing "N nodes, M edges" that updates when data loads

Update ui/graph.js initialization flow:
- In app.js page load sequence, after fetching initial data, call `initGraph('graph-view')` then `loadGraphData()`
- Listen for custom DOM events dispatched by SSE handler in app.js:
  - `laminark:entity_updated` -- call `addNode()` or update existing node data
  - `laminark:new_observation` -- refresh observation counts on affected nodes
- Update the node/edge count display after data loads and after incremental updates
- Add the legend styling in CSS: position absolute, bottom-left, backdrop-filter blur, small text, flex column layout

Add to ui/styles.css (or inline in graph.js):
- .graph-legend: position absolute, bottom 16px, left 16px, background rgba(13,17,23,0.85), border-radius 8px, padding 12px, backdrop-filter blur(8px)
- .graph-legend-item: flex row, gap 8px, align-items center, font-size 12px
- .legend-color: 12x12px inline-block, border-radius per shape type
- .fit-btn: position absolute, top 16px, right 16px, icon button with compass/crosshair icon
- .graph-stats: position absolute, top 16px, left 16px, small muted text
  </action>
  <verify>
1. Open http://localhost:37820, graph view shows with legend in bottom-left corner
2. Legend shows all 7 entity types with correct colors
3. Node/edge count shows in top-left and updates after data loads
4. "Fit to View" button in top-right recenters the graph when clicked
5. Browser console shows no errors during graph initialization
  </verify>
  <done>Graph module is fully wired into the SPA. Legend shows entity type color key. Stats display shows node/edge counts. Fit-to-view button recenters the graph. SSE events trigger incremental graph updates.</done>
</task>

</tasks>

<verification>
- Graph view renders Cytoscape force-directed layout from API data
- Nodes are colored/shaped by entity type (7 distinct visual styles)
- Nodes are sized proportionally to their observation count
- Edges show relationship type labels with directional arrows
- Users can pan (drag background), zoom (scroll), and drag individual nodes
- Legend in bottom-left shows all entity type colors
- Node/edge count displayed and updates
- Empty database shows graceful "no data" message instead of blank screen
</verification>

<success_criteria>
Knowledge graph renders as an interactive Cytoscape force-directed layout matching VIS-02. All 7 entity types are visually distinguishable. Edges are labeled by relationship type. The graph is pannable, zoomable, and nodes are draggable. Visual indicators (legend, stats, fit button) aid navigation.
</success_criteria>

<output>
After completion, create `.planning/phases/08-web-visualization/08-02-SUMMARY.md`
</output>
