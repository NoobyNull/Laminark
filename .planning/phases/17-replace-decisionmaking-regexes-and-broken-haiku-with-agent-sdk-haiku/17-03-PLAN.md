---
phase: 17-replace-decisionmaking-regexes-and-broken-haiku-with-agent-sdk-haiku
plan: 03
type: execute
wave: 3
depends_on: ["17-02"]
files_modified:
  - src/intelligence/__tests__/haiku-client.test.ts
  - src/intelligence/__tests__/haiku-agents.test.ts
  - src/intelligence/__tests__/haiku-processor.test.ts
  - src/graph/__tests__/entity-extractor.test.ts
  - src/graph/__tests__/relationship-detector.test.ts
  - src/graph/__tests__/signal-classifier.test.ts
  - src/hooks/__tests__/admission-filter.test.ts
  - src/curation/__tests__/observation-classifier.test.ts
autonomous: true

must_haves:
  truths:
    - "Haiku client tests verify graceful degradation (no API key -> null client)"
    - "Agent tests mock callHaiku and verify Zod validation of responses"
    - "HaikuProcessor tests mock all agents and verify the classify -> extract -> relate pipeline"
    - "Entity-extractor tests updated for new async path"
    - "Admission-filter tests no longer reference noise patterns"
    - "Old observation-classifier tests are removed or repurposed"
    - "All tests pass: npx vitest run"
  artifacts:
    - path: "src/intelligence/__tests__/haiku-client.test.ts"
      provides: "Tests for haiku client singleton, config loading, JSON extraction"
      min_lines: 40
    - path: "src/intelligence/__tests__/haiku-agents.test.ts"
      provides: "Tests for entity, relationship, and classifier agents with mocked Haiku"
      min_lines: 80
    - path: "src/intelligence/__tests__/haiku-processor.test.ts"
      provides: "Tests for background processor orchestration with mocked agents"
      min_lines: 60
  key_links:
    - from: "src/intelligence/__tests__/haiku-agents.test.ts"
      to: "src/intelligence/haiku-client.ts"
      via: "vi.mock for callHaiku"
      pattern: "vi.mock.*haiku-client"
---

<objective>
Create comprehensive tests for all new Haiku modules and update existing tests for modified modules. All tests mock the Haiku API (no real API calls).

Purpose: Ensure the new Haiku-based pipeline is tested without requiring API credentials in CI. Existing test suites for modified files need updating to reflect the removal of regex patterns and the new async paths.

Output: 3 new test files, 4 updated test files, 1 deleted/replaced test file. All tests pass.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-replace-decisionmaking-regexes-and-broken-haiku-with-agent-sdk-haiku/17-01-SUMMARY.md
@.planning/phases/17-replace-decisionmaking-regexes-and-broken-haiku-with-agent-sdk-haiku/17-02-SUMMARY.md
@src/intelligence/haiku-client.ts
@src/intelligence/haiku-entity-agent.ts
@src/intelligence/haiku-relationship-agent.ts
@src/intelligence/haiku-classifier-agent.ts
@src/intelligence/haiku-processor.ts
@src/graph/__tests__/entity-extractor.test.ts
@src/graph/__tests__/relationship-detector.test.ts
@src/graph/__tests__/signal-classifier.test.ts
@src/hooks/__tests__/admission-filter.test.ts
@src/curation/__tests__/observation-classifier.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tests for new Haiku modules (client, agents, processor)</name>
  <files>
    src/intelligence/__tests__/haiku-client.test.ts
    src/intelligence/__tests__/haiku-agents.test.ts
    src/intelligence/__tests__/haiku-processor.test.ts
  </files>
  <action>
    Create `src/intelligence/__tests__/` directory if it does not exist.

    1. `haiku-client.test.ts` -- Test the client singleton and helpers:
       - Test `loadHaikuConfig()`:
         a. Returns `{ enabled: false }` when no env var and no config file
         b. Returns `{ enabled: true, apiKey: 'sk-test' }` when LAMINARK_API_KEY is set
         c. Falls back to config.json when env var is not set (use LAMINARK_DATA_DIR for test isolation)
       - Test `getHaikuClient()`:
         a. Returns null when no API key
         b. Returns an Anthropic instance when API key is set (mock the Anthropic constructor)
       - Test `isHaikuEnabled()`:
         a. Returns false when no API key
         b. Returns true when API key is configured
       - Test `extractJsonFromResponse()`:
         a. Parses bare JSON array: `'[{"name":"foo"}]'`
         b. Parses markdown-fenced JSON: `` '```json\n[{"name":"foo"}]\n```' ``
         c. Parses JSON with surrounding text: `'Here are the entities:\n[{"name":"foo"}]\nDone.'`
         d. Parses JSON object: `'{"signal":"noise"}'`
         e. Throws on no JSON: `'No entities found in this text'`
       - Use `resetHaikuClient()` in beforeEach to clear singleton state
       - Use `process.env.LAMINARK_API_KEY` manipulation in tests (save/restore in beforeEach/afterEach)

    2. `haiku-agents.test.ts` -- Test all 3 agents with mocked callHaiku:
       - Use `vi.mock('../haiku-client.js')` to mock `callHaiku` and `extractJsonFromResponse`
       - For each agent:
         a. Mock `callHaiku` to return a known JSON string
         b. Let `extractJsonFromResponse` use the real implementation (or mock it to return parsed JSON)
         c. Verify the agent returns correctly typed and validated results

       Entity agent tests:
       - Returns empty array for empty text (mock returns `'[]'`)
       - Extracts File entities from Haiku response
       - Extracts mixed entity types (File, Decision, Problem)
       - Rejects invalid entity types (Zod validation catches `"Unknown"` type)
       - Handles Haiku returning markdown-fenced JSON

       Relationship agent tests:
       - Returns empty array when fewer than 2 entities provided (or mock returns `'[]'`)
       - Infers modifies relationship between File and Decision
       - Validates relationship types against RELATIONSHIP_TYPES enum
       - Rejects invalid relationship types

       Classifier agent tests:
       - Classifies noise correctly: `{"signal":"noise","classification":null,"reason":"build output"}`
       - Classifies discovery correctly: `{"signal":"signal","classification":"discovery","reason":"new finding"}`
       - Classifies problem correctly
       - Classifies solution correctly
       - Handles Haiku returning extra fields (Zod strips them)

    3. `haiku-processor.test.ts` -- Test the orchestrator with all agents mocked:
       - Mock all 3 agent modules: `vi.mock('../haiku-entity-agent.js')`, `vi.mock('../haiku-relationship-agent.js')`, `vi.mock('../haiku-classifier-agent.js')`
       - Mock `isHaikuEnabled` from `../haiku-client.js` to return true
       - Use a real temp SQLite database (use `createTempDb` pattern from existing tests)
       - Test `processOnce()`:
         a. Skips when no unclassified observations exist
         b. Classifies a noise observation -> soft-deletes it
         c. Classifies a signal observation -> extracts entities -> creates graph nodes
         d. With 2+ entities -> infers relationships -> creates edges
         e. Handles Haiku agent failures gracefully (logs, doesn't crash)
       - Test `start()/stop()`:
         a. Timer starts and stops cleanly
         b. Use fake timers (`vi.useFakeTimers()`) to verify interval firing
  </action>
  <verify>
    - `npx vitest run src/intelligence/__tests__/` passes all tests
    - No real API calls made (all mocked)
    - Tests cover graceful degradation, valid responses, invalid responses, and error handling
  </verify>
  <done>
    3 new test files with comprehensive coverage of Haiku client, all 3 agents, and the background processor. All tests use mocked Haiku calls -- no API key needed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update existing tests for modified modules</name>
  <files>
    src/graph/__tests__/entity-extractor.test.ts
    src/graph/__tests__/relationship-detector.test.ts
    src/graph/__tests__/signal-classifier.test.ts
    src/hooks/__tests__/admission-filter.test.ts
    src/curation/__tests__/observation-classifier.test.ts
  </files>
  <action>
    1. Update `src/graph/__tests__/entity-extractor.test.ts`:
       - Keep existing tests that test the sync `extractEntities()` function IF it still exists as a deprecated path
       - If `extractEntities()` was removed (check Plan 02 outcome), delete tests that reference it or `ALL_RULES` from extraction-rules
       - If extraction-rules.ts was deleted, remove any imports of `filePathRule`, `decisionRule`, etc.
       - Add test for `extractEntitiesAsync()` if it was added (mock the Haiku agent)
       - Ensure `extractAndPersist()` tests still work if the sync path remains
       - The goal: tests should pass without importing from the deleted extraction-rules.ts

    2. Update `src/graph/__tests__/relationship-detector.test.ts`:
       - Keep tests for the sync `detectRelationships()` function if it still exists
       - Add test for `detectRelationshipsAsync()` if it was added (mock the Haiku agent)
       - Ensure `detectAndPersist()` tests still work
       - Remove any tests that rely on specific regex patterns from the deprecated code

    3. Update `src/graph/__tests__/signal-classifier.test.ts`:
       - The signal-classifier.ts file was marked deprecated but not deleted
       - Keep all existing tests as-is -- they test deprecated but still functional code
       - Add a comment at the top: "Tests for deprecated signal classifier. These verify the legacy regex-based classification which is no longer used in the live pipeline (replaced by HaikuProcessor)."

    4. Update `src/hooks/__tests__/admission-filter.test.ts`:
       - REMOVE all tests that verify noise pattern rejection (tests for isNoise integration)
       - Specifically: remove tests that check `shouldAdmit()` returns false for build output, package install logs, linter warnings, etc. (those were regex-based noise patterns)
       - KEEP all other tests: self-referential rejection, empty content rejection, HIGH_SIGNAL_TOOLS bypass, Bash command filtering, long content without indicators
       - Add a test that verifies content which WAS previously rejected by noise patterns is now ADMITTED (since noise filtering moved to Haiku post-storage)

    5. Handle `src/curation/__tests__/observation-classifier.test.ts`:
       - Delete this file entirely -- the ObservationClassifier class it tests no longer exists
       - Or if the file tests other curation functionality, keep those parts and remove only the ObservationClassifier tests

    6. Run full test suite: `npx vitest run` -- all tests must pass.
  </action>
  <verify>
    - `npx vitest run` passes all tests (zero failures)
    - No test imports from deleted files (extraction-rules.ts, observation-classifier.ts)
    - Admission filter tests no longer check noise pattern rejection
    - Signal classifier tests still pass (deprecated code still functional)
  </verify>
  <done>
    All test suites updated to reflect the Haiku migration. Deleted tests for removed modules. Updated tests for modified modules. No broken imports. Full test suite passes.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` -- all tests pass
2. No test file imports from deleted source files
3. New test files cover: client config, JSON extraction, all 3 agents, processor pipeline
4. Existing test files updated for admission-filter changes and deprecated modules
5. Zero real API calls in any test
</verification>

<success_criteria>
- All new Haiku modules have test coverage with mocked API calls
- All modified module tests updated and passing
- Deleted module tests removed
- `npx vitest run` reports zero failures
</success_criteria>

<output>
After completion, create `.planning/phases/17-replace-decisionmaking-regexes-and-broken-haiku-with-agent-sdk-haiku/17-03-SUMMARY.md`
</output>
