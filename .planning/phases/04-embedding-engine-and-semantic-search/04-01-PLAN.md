---
phase: 04-embedding-engine-and-semantic-search
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/storage/migrations.ts
  - src/analysis/embedder.ts
  - src/analysis/engines/local-onnx.ts
  - src/analysis/engines/keyword-only.ts
autonomous: true

must_haves:
  truths:
    - "EmbeddingEngine interface defines embed(), embedBatch(), dimensions(), name(), initialize(), isReady() methods"
    - "LocalOnnxEngine loads BGE Small EN v1.5 via dynamic import() and returns 384-dim Float32Array from embed()"
    - "KeywordOnlyEngine always returns null from embed() and false from initialize()"
    - "Migration 006 recreates observation_embeddings table with distance_metric=cosine"
  artifacts:
    - path: "src/analysis/embedder.ts"
      provides: "EmbeddingEngine interface and createEmbeddingEngine() factory"
      exports: ["EmbeddingEngine", "createEmbeddingEngine"]
    - path: "src/analysis/engines/local-onnx.ts"
      provides: "Local ONNX embedding engine using @huggingface/transformers"
      exports: ["LocalOnnxEngine"]
    - path: "src/analysis/engines/keyword-only.ts"
      provides: "Null fallback engine for graceful degradation"
      exports: ["KeywordOnlyEngine"]
    - path: "src/storage/migrations.ts"
      provides: "Migration 006 dropping and recreating vec0 table with cosine distance"
      contains: "distance_metric=cosine"
  key_links:
    - from: "src/analysis/embedder.ts"
      to: "src/analysis/engines/local-onnx.ts"
      via: "createEmbeddingEngine() factory returns LocalOnnxEngine or falls back to KeywordOnlyEngine"
      pattern: "new LocalOnnxEngine|new KeywordOnlyEngine"
    - from: "src/analysis/engines/local-onnx.ts"
      to: "@huggingface/transformers"
      via: "dynamic import() inside initialize()"
      pattern: "import\\('@huggingface/transformers'\\)"
---

<objective>
Create the pluggable embedding engine foundation and fix the vec0 migration for cosine distance.

Purpose: Establishes the embedding abstraction layer that all downstream components depend on (worker bridge, hybrid search, MCP integration). The migration fix ensures vector similarity uses cosine distance, which is correct for normalized BGE embeddings.

Output: EmbeddingEngine interface, LocalOnnxEngine (BGE Small EN v1.5, q8), KeywordOnlyEngine (null fallback), migration 006 (cosine distance).
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-embedding-engine-and-semantic-search/04-RESEARCH.md
@src/shared/types.ts
@src/storage/migrations.ts
@src/shared/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EmbeddingEngine interface and two implementations</name>
  <files>
    src/analysis/embedder.ts
    src/analysis/engines/local-onnx.ts
    src/analysis/engines/keyword-only.ts
  </files>
  <action>
Create the embedding engine abstraction layer with three files:

**src/analysis/embedder.ts** -- Interface and factory:
- Define `EmbeddingEngine` interface with methods:
  - `embed(text: string): Promise<Float32Array | null>` -- single text embedding
  - `embedBatch(texts: string[]): Promise<(Float32Array | null)[]>` -- batch embedding
  - `dimensions(): number` -- embedding dimensions (384 for BGE Small)
  - `name(): string` -- engine identifier string
  - `initialize(): Promise<boolean>` -- lazy init, returns true on success
  - `isReady(): boolean` -- whether initialize() succeeded
- Export `createEmbeddingEngine()` async factory function:
  - Attempts to create and initialize a `LocalOnnxEngine`
  - If initialize() returns false, returns a `KeywordOnlyEngine` instead
  - Never throws -- always returns a valid engine

**src/analysis/engines/local-onnx.ts** -- Default engine:
- Class `LocalOnnxEngine` implements `EmbeddingEngine`
- Private fields: `pipe` (the HF pipeline, initially null), `ready` (boolean, initially false)
- `initialize()`:
  - Uses `const { pipeline, env } = await import('@huggingface/transformers')` for lazy loading
  - Sets `env.cacheDir` to `path.join(getConfigDir(), 'models')` using existing config utility
  - Creates pipeline: `pipeline('feature-extraction', 'Xenova/bge-small-en-v1.5', { dtype: 'q8' })`
  - Wraps everything in try/catch -- on failure sets `ready = false`, returns false
  - On success sets `ready = true`, returns true
- `embed(text)`:
  - Guard: if `!this.ready || !this.pipe`, return null
  - Guard: if `!text || text.trim().length === 0`, return null
  - Call `this.pipe(text, { pooling: 'cls', normalize: true })`
  - Return `new Float32Array(output.data)` (384-dim)
  - Wrap in try/catch, return null on error
- `embedBatch(texts)`:
  - Filter empty texts, map to embed() calls, return results preserving order
  - Return null for any text that was empty or failed
- `dimensions()`: return 384
- `name()`: return 'bge-small-en-v1.5-q8'
- `isReady()`: return this.ready

**src/analysis/engines/keyword-only.ts** -- Null fallback:
- Class `KeywordOnlyEngine` implements `EmbeddingEngine`
- `embed()`: return null (always)
- `embedBatch()`: return array of nulls matching input length
- `dimensions()`: return 0
- `name()`: return 'keyword-only'
- `initialize()`: return false (intentionally -- this engine has no model)
- `isReady()`: return false

All methods that can fail MUST return null/false, NEVER throw. This is critical for graceful degradation (DQ-03).

Install @huggingface/transformers:
```bash
npm install @huggingface/transformers
```
  </action>
  <verify>
`npx tsc --noEmit` passes with no type errors. Verify the three files exist with correct exports:
- `src/analysis/embedder.ts` exports EmbeddingEngine and createEmbeddingEngine
- `src/analysis/engines/local-onnx.ts` exports LocalOnnxEngine
- `src/analysis/engines/keyword-only.ts` exports KeywordOnlyEngine
  </verify>
  <done>EmbeddingEngine interface defined with 6 methods, LocalOnnxEngine uses dynamic import() for @huggingface/transformers with BGE Small q8, KeywordOnlyEngine returns null/false for everything, createEmbeddingEngine factory tries ONNX then falls back to keyword-only</done>
</task>

<task type="auto">
  <name>Task 2: Add migration 006 for cosine distance vec0 table</name>
  <files>
    src/storage/migrations.ts
  </files>
  <action>
Add migration 006 to the MIGRATIONS array in `src/storage/migrations.ts`.

Migration 006 must:
1. Drop the existing `observation_embeddings` table (created by migration 004 with L2 distance)
2. Recreate it with `distance_metric=cosine`:
```sql
DROP TABLE IF EXISTS observation_embeddings;
CREATE VIRTUAL TABLE IF NOT EXISTS observation_embeddings USING vec0(
  observation_id TEXT PRIMARY KEY,
  embedding float[384] distance_metric=cosine
);
```

This is safe because no embeddings have been written yet (Phase 4 is the first phase to write them).

Migration 006 must also be conditional on `hasVectorSupport`, following the same pattern as migration 004. Update the `runMigrations()` function to skip migration 006 when `!hasVectorSupport`, using the same conditional logic as migration 004:
```typescript
if ((migration.version === 4 || migration.version === 6) && !hasVectorSupport) {
  continue;
}
```

Add the migration entry:
```typescript
{
  version: 6,
  name: 'recreate_vec0_cosine_distance',
  up: `
    DROP TABLE IF EXISTS observation_embeddings;
    CREATE VIRTUAL TABLE IF NOT EXISTS observation_embeddings USING vec0(
      observation_id TEXT PRIMARY KEY,
      embedding float[384] distance_metric=cosine
    );
  `,
},
```
  </action>
  <verify>
`npx tsc --noEmit` passes. `npm test` passes with all existing tests green (migration change should not break anything since vec0 table is recreated cleanly). Verify the MIGRATIONS array has 6 entries and the runMigrations conditional covers both version 4 and 6.
  </verify>
  <done>Migration 006 drops and recreates observation_embeddings with distance_metric=cosine. runMigrations conditionally skips both migration 004 and 006 when sqlite-vec is unavailable. All existing tests pass.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `npm test` passes with all existing tests green (no regressions)
- `src/analysis/embedder.ts` exports EmbeddingEngine interface and createEmbeddingEngine factory
- `src/analysis/engines/local-onnx.ts` exports LocalOnnxEngine class
- `src/analysis/engines/keyword-only.ts` exports KeywordOnlyEngine class
- Migration 006 in MIGRATIONS array with `distance_metric=cosine`
- `@huggingface/transformers` in package.json dependencies
</verification>

<success_criteria>
1. EmbeddingEngine interface is the single abstraction all consumers depend on
2. LocalOnnxEngine uses dynamic import() for zero startup cost (DQ-04)
3. KeywordOnlyEngine provides silent fallback (DQ-03)
4. vec0 table uses cosine distance for correct BGE embedding similarity
5. No existing tests regress
</success_criteria>

<output>
After completion, create `.planning/phases/04-embedding-engine-and-semantic-search/04-01-SUMMARY.md`
</output>
