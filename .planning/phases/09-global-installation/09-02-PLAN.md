---
phase: 09-global-installation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude-plugin/plugin.json
  - .claude-plugin/marketplace.json
  - hooks/hooks.json
  - .mcp.json
autonomous: false

must_haves:
  truths:
    - "Plugin manifest declares Laminark with correct metadata, version, and component paths"
    - "hooks.json configures all 5 hook events with CLAUDE_PLUGIN_ROOT paths and correct async/sync settings"
    - ".mcp.json uses CLAUDE_PLUGIN_ROOT for portable MCP server startup via ensure-deps.sh"
    - "User can run claude --plugin-dir and see Laminark hooks and MCP tools registered"
  artifacts:
    - path: ".claude-plugin/plugin.json"
      provides: "Plugin manifest with name, description, author, skills path"
      contains: "laminark"
    - path: ".claude-plugin/marketplace.json"
      provides: "Marketplace catalog with GitHub source"
      contains: "productivity"
    - path: "hooks/hooks.json"
      provides: "Hook event configuration for all 5 lifecycle events"
      contains: "CLAUDE_PLUGIN_ROOT"
    - path: ".mcp.json"
      provides: "MCP server configuration with plugin-portable paths"
      contains: "CLAUDE_PLUGIN_ROOT"
  key_links:
    - from: "hooks/hooks.json"
      to: "dist/hooks/handler.js"
      via: "CLAUDE_PLUGIN_ROOT command path"
      pattern: "CLAUDE_PLUGIN_ROOT.*dist/hooks/handler\\.js"
    - from: ".mcp.json"
      to: "dist/index.js"
      via: "CLAUDE_PLUGIN_ROOT command path"
      pattern: "CLAUDE_PLUGIN_ROOT.*dist/index\\.js"
    - from: ".mcp.json"
      to: "scripts/ensure-deps.sh"
      via: "CLAUDE_PLUGIN_ROOT bash wrapper"
      pattern: "CLAUDE_PLUGIN_ROOT.*scripts/ensure-deps\\.sh"
---

<objective>
Update all plugin configuration files so Laminark works as a globally-installed Claude Code plugin. This covers the plugin manifest (plugin.json), marketplace catalog (marketplace.json), hook configuration (hooks.json), and MCP server definition (.mcp.json) -- all using `${CLAUDE_PLUGIN_ROOT}` for portable paths.

Purpose: These configuration files are what the Claude Code plugin system reads to register Laminark's hooks and MCP server. Without correct `${CLAUDE_PLUGIN_ROOT}` paths, the plugin breaks when installed to the plugin cache directory. This covers GLOB-01 (available in every session), GLOB-02 (project detection via cwd -- already works, verified here), GLOB-03 (plugin manifest), and GLOB-05 (installable via marketplace).

Output: Updated plugin.json, marketplace.json, hooks.json, and .mcp.json ready for `claude --plugin-dir` testing and marketplace distribution.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-global-installation/09-RESEARCH.md
@.claude-plugin/plugin.json
@.claude-plugin/marketplace.json
@hooks/hooks.json
@.mcp.json
@scripts/ensure-deps.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update plugin manifest and marketplace catalog</name>
  <files>.claude-plugin/plugin.json, .claude-plugin/marketplace.json</files>
  <action>
    Update `.claude-plugin/plugin.json`:
    - Change `"version"` from `"7"` to `"1.0.0"` (semver for plugin system)
    - Keep all other fields as-is (name, description, author, homepage, repository, license, keywords, skills)
    - Verify the `"skills": "./skills/"` path is correct (skills directory may not exist yet, that is fine -- it is for Phase 10+)

    Update `.claude-plugin/marketplace.json`:
    - Change `"version"` from `"7"` to `"1.0.0"` to match plugin.json
    - Keep all other fields as-is (name, owner, source, description, category)

    Both files already exist and have the correct structure. Only the version field needs updating.
  </action>
  <verify>Read both files and confirm version is "1.0.0". Validate JSON syntax with `node -e "JSON.parse(require('fs').readFileSync('.claude-plugin/plugin.json','utf8'))"` and same for marketplace.json.</verify>
  <done>plugin.json and marketplace.json both have version "1.0.0" and valid JSON structure.</done>
</task>

<task type="auto">
  <name>Task 2: Update hooks.json and .mcp.json for plugin-portable paths</name>
  <files>hooks/hooks.json, .mcp.json</files>
  <action>
    Update `hooks/hooks.json` to match the researched plugin hook configuration:
    - Add top-level `"description"` field: `"Laminark: persistent adaptive memory for Claude Code"`
    - SessionStart: Add `"statusMessage": "Loading Laminark memory context..."`, keep synchronous (NO async field), reduce timeout to 10 (from 30). The command should be `"node ${CLAUDE_PLUGIN_ROOT}/dist/hooks/handler.js"` (NOT wrapping with bash/ensure-deps.sh -- the MCP server handles deps, hooks run after server starts). Actually, keep the bash ensure-deps.sh wrapper since hooks run independently of the MCP server and node_modules may not be installed yet on first session. Use: `"bash \"${CLAUDE_PLUGIN_ROOT}/scripts/ensure-deps.sh\" node \"${CLAUDE_PLUGIN_ROOT}/dist/hooks/handler.js\""`
    - PostToolUse: Keep async: true, timeout: 30. Keep existing command. Remove empty `"matcher": ""` (unnecessary, matcher is optional).
    - PostToolUseFailure: Keep async: true, timeout: 30. Keep existing command. Remove empty `"matcher": ""`.
    - Stop: Keep async: true, reduce timeout to 15 (from 30 -- Stop should be fast).
    - SessionEnd: Keep async: true, reduce timeout to 15 (from 30). Remove empty `"matcher": ""`.
    - SessionStart: Keep existing matcher as empty string (matches all session types).

    Update `.mcp.json` to use `${CLAUDE_PLUGIN_ROOT}` paths:
    - Change from: `["./scripts/ensure-deps.sh", "node", "./dist/index.js"]`
    - Change to: `["${CLAUDE_PLUGIN_ROOT}/scripts/ensure-deps.sh", "node", "${CLAUDE_PLUGIN_ROOT}/dist/index.js"]`
    - This is critical: relative paths like `./` break when the plugin is installed to the cache directory

    IMPORTANT: Do NOT change the ensure-deps.sh script itself. The script uses `$(dirname "$0")/..` to find PLUGIN_ROOT which works correctly from any location.
  </action>
  <verify>
    1. Validate JSON: `node -e "JSON.parse(require('fs').readFileSync('hooks/hooks.json','utf8'))"` and same for .mcp.json
    2. Verify CLAUDE_PLUGIN_ROOT appears in hooks.json: `grep -c 'CLAUDE_PLUGIN_ROOT' hooks/hooks.json` should be 5 (one per hook event)
    3. Verify CLAUDE_PLUGIN_ROOT appears in .mcp.json: `grep -c 'CLAUDE_PLUGIN_ROOT' .mcp.json` should be 2
    4. Verify SessionStart has no "async" field (synchronous)
    5. Verify PostToolUse, PostToolUseFailure, Stop, SessionEnd all have "async": true
    6. `npm run build` succeeds (unchanged code, but verify build still works)
  </verify>
  <done>hooks.json has all 5 events with CLAUDE_PLUGIN_ROOT paths, correct async/sync settings, and statusMessage on SessionStart. .mcp.json uses CLAUDE_PLUGIN_ROOT paths for ensure-deps.sh and dist/index.js. Build passes.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify plugin mode with claude --plugin-dir</name>
  <what-built>Complete plugin configuration (plugin.json, marketplace.json, hooks.json, .mcp.json) with portable CLAUDE_PLUGIN_ROOT paths, ready for global installation via Claude Code plugin system.</what-built>
  <how-to-verify>
    1. Open a new terminal and run: `claude --plugin-dir /data/Laminark`
    2. Once Claude Code starts, type `/hooks` and verify you see [Plugin] entries for:
       - SessionStart
       - PostToolUse
       - PostToolUseFailure
       - Stop
       - SessionEnd
    3. Type `/mcp` and verify the `laminark` MCP server appears and its tools are listed
    4. Test that Laminark's memory tools work by trying to save and recall a memory
    5. Check that the SessionStart hook injected context (you should see "[Laminark" context at the top of the session)

    If hooks or MCP tools do not appear, check:
    - `cat /data/Laminark/.claude-plugin/plugin.json` is valid JSON
    - `cat /data/Laminark/hooks/hooks.json` is valid JSON
    - `cat /data/Laminark/.mcp.json` is valid JSON
  </how-to-verify>
  <resume-signal>Type "approved" if hooks and MCP tools appear correctly, or describe what is missing/broken.</resume-signal>
</task>

</tasks>

<verification>
1. All 4 config files are valid JSON
2. CLAUDE_PLUGIN_ROOT used consistently in hooks.json and .mcp.json (no relative paths)
3. SessionStart hook is synchronous with statusMessage
4. All other hooks are async: true
5. Plugin manifest has correct semver version
6. Build passes after changes
7. User confirms hooks and MCP tools appear with `claude --plugin-dir`
</verification>

<success_criteria>
- `claude --plugin-dir /data/Laminark` shows all 5 hook events registered as [Plugin]
- MCP tools (recall, save_memory, query_graph, etc.) are available and functional
- SessionStart injects Laminark context into the session
- No relative paths (`./ `) remain in hooks.json or .mcp.json (all use CLAUDE_PLUGIN_ROOT)
- Plugin version is "1.0.0" in both plugin.json and marketplace.json
</success_criteria>

<output>
After completion, create `.planning/phases/09-global-installation/09-02-SUMMARY.md`
</output>
