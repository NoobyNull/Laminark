---
phase: 06-topic-detection-and-context-stashing
plan: 05
type: tdd
wave: 3
depends_on: ["06-01"]
files_modified:
  - src/intelligence/adaptive-threshold.ts
  - src/intelligence/__tests__/adaptive-threshold.test.ts
  - src/storage/migrations/007-threshold-history.sql
  - src/storage/threshold-store.ts
autonomous: true

must_haves:
  truths:
    - "EWMA threshold adapts: a scattered session raises the shift threshold over time"
    - "EWMA threshold adapts: a focused session lowers the shift threshold over time"
    - "New sessions seed with historical average from previous sessions (cold start handling)"
    - "If no history exists, the global default (0.3) is used as seed"
    - "Threshold is bounded within [0.15, 0.6] to prevent extreme drift"
  artifacts:
    - path: "src/intelligence/adaptive-threshold.ts"
      provides: "AdaptiveThresholdManager with EWMA computation"
      exports: ["AdaptiveThresholdManager", "ThresholdState"]
    - path: "src/intelligence/__tests__/adaptive-threshold.test.ts"
      provides: "Test suite for EWMA threshold behavior"
      min_lines: 100
    - path: "src/storage/migrations/007-threshold-history.sql"
      provides: "threshold_history table for session seeding"
      contains: "CREATE TABLE threshold_history"
    - path: "src/storage/threshold-store.ts"
      provides: "ThresholdStore for persisting session threshold data"
      exports: ["ThresholdStore"]
  key_links:
    - from: "src/intelligence/adaptive-threshold.ts"
      to: "src/intelligence/topic-detector.ts"
      via: "extends/replaces static threshold with adaptive"
      pattern: "setThreshold|getThreshold"
    - from: "src/intelligence/adaptive-threshold.ts"
      to: "src/storage/threshold-store.ts"
      via: "loads and saves historical averages"
      pattern: "thresholdStore\\.(load|save)"
---

<objective>
Build the EWMA-based adaptive threshold system that adjusts the topic shift threshold per-user, per-session based on natural topic variance, with historical session seeding for cold start.

Purpose: This is the intelligence layer that makes topic detection adapt to the user (INT-06, INT-07). A user having a scattered day gets a higher threshold (fewer false positives). A focused user gets a lower threshold (catches real shifts). New sessions bootstrap from historical averages to avoid cold-start problems. Using TDD because EWMA is pure math with well-defined I/O.

Output: AdaptiveThresholdManager class, ThresholdStore for persistence, migration for history table, comprehensive tests.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-topic-detection-and-context-stashing/06-01-SUMMARY.md
</context>

<feature>
  <name>EWMA Adaptive Topic Threshold</name>
  <files>src/intelligence/adaptive-threshold.ts, src/intelligence/__tests__/adaptive-threshold.test.ts, src/storage/migrations/007-threshold-history.sql, src/storage/threshold-store.ts</files>
  <behavior>
    AdaptiveThresholdManager maintains EWMA of cosine distances and variance:
    - ewmaDistance: exponentially weighted moving average of observed distances
    - ewmaVariance: exponentially weighted variance of distances
    - alpha: decay factor (default 0.3)
    - sensitivityMultiplier: standard deviations above mean (default 1.5)

    Threshold formula: ewmaDistance + sensitivityMultiplier * sqrt(ewmaVariance)
    Bounded to [0.15, 0.6]

    Cases:
    - Sequence of high distances [0.8, 0.7, 0.9] -> threshold rises toward 0.6 cap
    - Sequence of low distances [0.05, 0.08, 0.03] -> threshold drops toward 0.15 floor
    - Mixed distances converge to a middle threshold
    - Cold start with no history -> uses 0.3 as initial ewmaDistance, 0.01 as initial variance
    - Cold start with history -> seeds from stored average distance and variance
    - Threshold never exceeds 0.6 or drops below 0.15

    ThresholdState type: { ewmaDistance: number, ewmaVariance: number, alpha: number, sensitivityMultiplier: number, observationCount: number }

    ThresholdStore persists:
    - threshold_history table: id, project_id, session_id, final_ewma_distance, final_ewma_variance, observation_count, created_at
    - loadHistoricalSeed(projectId): returns average ewmaDistance and ewmaVariance across last 10 sessions, or null if no history
    - saveSessionThreshold(projectId, sessionId, state): persists final state at session end

    update(distance) method:
    1. ewmaDistance = alpha * distance + (1 - alpha) * ewmaDistance
    2. diff = distance - ewmaDistance
    3. ewmaVariance = alpha * (diff * diff) + (1 - alpha) * ewmaVariance
    4. Compute new threshold = clamp(ewmaDistance + sensitivityMultiplier * sqrt(ewmaVariance), 0.15, 0.6)
    5. Increment observationCount
    6. Return new threshold

    Integration with TopicShiftDetector:
    - After each detect() call, call adaptiveManager.update(result.distance)
    - Set detector.setThreshold(newThreshold)
  </behavior>
  <implementation>
    1. Create ThresholdState interface and AdaptiveThresholdManager class
    2. Implement update(distance) with EWMA math and clamping
    3. Implement seedFromHistory(averageDistance, averageVariance)
    4. Implement getThreshold(), getState(), reset()
    5. Create migration 007-threshold-history.sql
    6. Create ThresholdStore with loadHistoricalSeed and saveSessionThreshold
    7. Write tests covering all EWMA scenarios, boundary clamping, cold start, history seeding
  </implementation>
</feature>

<verification>
- EWMA correctly converges: feed 20 high distances, threshold approaches upper bound
- EWMA correctly converges: feed 20 low distances, threshold approaches lower bound
- Bounds enforced: threshold never below 0.15 or above 0.6
- Cold start without history uses defaults (0.3 distance, 0.01 variance)
- Cold start with history uses stored averages
- ThresholdStore round-trips data through SQLite
- `npm test -- --testPathPattern=adaptive-threshold` passes
</verification>

<success_criteria>
- AdaptiveThresholdManager with working EWMA computation
- Threshold bounded [0.15, 0.6] in all cases
- Cold start seeding from historical averages
- ThresholdStore persists and loads session data
- At least 10 test cases covering convergence, bounds, seeding, cold start, integration
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-topic-detection-and-context-stashing/06-05-SUMMARY.md`
</output>
