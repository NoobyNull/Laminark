---
phase: 06-topic-detection-and-context-stashing
plan: 04
type: execute
wave: 2
depends_on: ["06-02"]
files_modified:
  - src/commands/resume.ts
  - src/mcp/tools/topic-context.ts
  - src/commands/__tests__/resume.test.ts
  - src/mcp/tools/__tests__/topic-context.test.ts
autonomous: true

must_haves:
  truths:
    - "User can type /memorite:resume and see a list of stashed context threads"
    - "User can select a stashed thread and have it re-injected into conversation context"
    - "User can ask 'where was I?' and see recently abandoned threads ranked by recency"
    - "Resume updates stash status to 'resumed'"
  artifacts:
    - path: "src/commands/resume.ts"
      provides: "/memorite:resume slash command handler"
      exports: ["handleResumeCommand"]
    - path: "src/mcp/tools/topic-context.ts"
      provides: "topic_context MCP tool for 'where was I?' queries"
      exports: ["topicContextTool"]
  key_links:
    - from: "src/commands/resume.ts"
      to: "src/storage/stash-manager.ts"
      via: "StashManager.listStashes() and resumeStash()"
      pattern: "stashManager\\.(listStashes|resumeStash|getStash)"
    - from: "src/mcp/tools/topic-context.ts"
      to: "src/storage/stash-manager.ts"
      via: "StashManager.getRecentStashes()"
      pattern: "stashManager\\.getRecentStashes"
---

<objective>
Build the /memorite:resume slash command and the topic_context MCP tool that powers "where was I?" queries. These are the user's path back to stashed context threads.

Purpose: CTX-05 and CTX-06 require that users can resume stashed threads and discover abandoned context. This plan builds both the command-line and MCP tool interfaces for context thread recovery.

Output: /memorite:resume command handler, topic_context MCP tool, tests for both.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-topic-detection-and-context-stashing/06-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: /memorite:resume slash command</name>
  <files>src/commands/resume.ts, src/commands/__tests__/resume.test.ts</files>
  <action>
    Create /memorite:resume command handler (follow Phase 5 slash command patterns):

    Export async function handleResumeCommand(args: { projectId: string, stashId?: string }, deps: { stashManager: StashManager }): Promise of { success: boolean, message: string, context?: StashObservation[] }

    Two modes:
    1. No stashId provided (list mode):
       - Call stashManager.listStashes(projectId, { status: 'stashed', limit: 5 })
       - If empty, return { success: true, message: "No stashed context threads found." }
       - Format as numbered list: "Stashed context threads:\n1. {topicLabel} ({timeAgo}) - {summary truncated to 80 chars}\n2. ..."
       - Include instruction: "Use /memorite:resume {id} to restore a thread."
       - Return { success: true, message: formattedList }

    2. stashId provided (resume mode):
       - Call stashManager.getStash(stashId)
       - If not found, return { success: false, message: "Stash not found: {stashId}" }
       - Call stashManager.resumeStash(stashId)
       - Return { success: true, message: "Resumed: \"{topicLabel}\"\n\nContext restored with {N} observations.", context: stash.observationSnapshots }
       - The caller (MCP layer) is responsible for injecting the returned context into Claude's context window

    Helper: timeAgo(dateString) - returns human-readable relative time ("2 hours ago", "yesterday", etc.)

    Register in slash command router alongside /memorite:stash.

    Tests:
    - List mode with no stashes returns "no stashed" message
    - List mode with stashes returns formatted list with topic labels and time
    - Resume mode with valid ID returns observations and marks as resumed
    - Resume mode with invalid ID returns error
    - Time formatting produces readable relative strings
  </action>
  <verify>`npm test -- --testPathPattern=resume` passes. Command correctly lists and resumes stashes.</verify>
  <done>/memorite:resume lists stashed threads in list mode, restores context in resume mode. Status updated on resume. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: topic_context MCP tool for "where was I?" queries</name>
  <files>src/mcp/tools/topic-context.ts, src/mcp/tools/__tests__/topic-context.test.ts</files>
  <action>
    Create topic_context MCP tool (follow the tool registration pattern from Phase 2):

    Tool definition:
    - name: "topic_context"
    - description: "Shows recently stashed context threads. Use when the user asks 'where was I?' or wants to see abandoned conversation threads."
    - inputSchema: { type: "object", properties: { query: { type: "string", description: "Optional search query to filter threads" }, limit: { type: "number", description: "Max threads to return", default: 5 } } }

    Handler logic:
    1. Get projectId from MCP server context (however Phase 2 established this pattern)
    2. Call stashManager.getRecentStashes(projectId, limit)
    3. If query provided, filter stashes where topicLabel or summary includes query (case-insensitive)
    4. Sort remaining by recency (already sorted from DB, but if filtered, maintain order)
    5. Format response using progressive disclosure (follow Phase 2 pattern):
       - Compact: numbered list of topic labels with time
       - Detail: include summaries
       - Full: include observation count and first few observation snippets
    6. Return formatted text response

    If no stashes found, return: "No stashed context threads found. You're working in a single thread."

    Register tool in MCP tool registry (wherever Phase 2 established the pattern).

    Tests:
    - Returns formatted list of recent stashes
    - Empty stashes returns appropriate message
    - Query filters by topic label
    - Limit parameter works
    - Response follows progressive disclosure format
  </action>
  <verify>`npm test -- --testPathPattern=topic-context` passes. Tool registered and callable via MCP.</verify>
  <done>topic_context MCP tool surfaces stashed threads for "where was I?" queries. Supports filtering by query and limit. Progressive disclosure format. Registered in MCP. All tests pass.</done>
</task>

</tasks>

<verification>
- /memorite:resume lists stashes when no ID given
- /memorite:resume restores context and updates status when ID given
- topic_context MCP tool returns ranked stash list
- Both handle empty state gracefully
- Progressive disclosure in MCP tool response
</verification>

<success_criteria>
- /memorite:resume works in both list and resume modes (CTX-05, UI-05)
- topic_context MCP tool answers "where was I?" (CTX-06)
- Resumed stash status updated to prevent re-listing
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-topic-detection-and-context-stashing/06-04-SUMMARY.md`
</output>
