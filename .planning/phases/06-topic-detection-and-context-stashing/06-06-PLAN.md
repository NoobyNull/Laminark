---
phase: 06-topic-detection-and-context-stashing
plan: 06
type: execute
wave: 4
depends_on: ["06-03", "06-05"]
files_modified:
  - src/config/topic-detection-config.ts
  - src/intelligence/decision-logger.ts
  - src/intelligence/__tests__/decision-logger.test.ts
  - src/storage/migrations/008-decision-log.sql
autonomous: true

must_haves:
  truths:
    - "User can configure sensitivity multiplier between 'sensitive' and 'relaxed' modes"
    - "Manual override always takes precedence over adaptive threshold"
    - "Every topic shift decision (shifted or not) is logged with all inputs for debugging"
    - "Decision log entries include: distance, threshold, EWMA state, shifted boolean, timestamp"
  artifacts:
    - path: "src/config/topic-detection-config.ts"
      provides: "TopicDetectionConfig with sensitivity multiplier and manual override"
      exports: ["TopicDetectionConfig", "SensitivityPreset", "loadTopicDetectionConfig"]
    - path: "src/intelligence/decision-logger.ts"
      provides: "TopicShiftDecisionLogger for debugging and tuning"
      exports: ["TopicShiftDecisionLogger", "ShiftDecision"]
    - path: "src/storage/migrations/008-decision-log.sql"
      provides: "shift_decisions table for decision logging"
      contains: "CREATE TABLE shift_decisions"
  key_links:
    - from: "src/config/topic-detection-config.ts"
      to: "src/intelligence/adaptive-threshold.ts"
      via: "sensitivityMultiplier applied to AdaptiveThresholdManager"
      pattern: "sensitivityMultiplier"
    - from: "src/intelligence/decision-logger.ts"
      to: "src/hooks/topic-shift-handler.ts"
      via: "called after every detect() to log the decision"
      pattern: "decisionLogger\\.log"
    - from: "src/config/topic-detection-config.ts"
      to: "src/intelligence/topic-detector.ts"
      via: "manual threshold override bypasses adaptive"
      pattern: "manualThreshold|override"
---

<objective>
Add user-configurable sensitivity multiplier with preset modes and comprehensive decision logging for all topic shift decisions.

Purpose: INT-08 requires a user-facing sensitivity dial. DQ-05 requires all decisions to be logged for debugging and threshold tuning. This plan completes Phase 6 by adding configurability and observability on top of the adaptive detection built in Plans 01-05.

Output: Configuration module with sensitivity presets, decision logger with database persistence, migration for decision log table.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-topic-detection-and-context-stashing/06-01-SUMMARY.md
@.planning/phases/06-topic-detection-and-context-stashing/06-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Topic detection configuration with sensitivity presets</name>
  <files>src/config/topic-detection-config.ts</files>
  <action>
    Create configuration module for topic detection:

    SensitivityPreset enum: 'sensitive' | 'balanced' | 'relaxed'
    - sensitive: sensitivityMultiplier = 1.0 (detects smaller shifts)
    - balanced: sensitivityMultiplier = 1.5 (default)
    - relaxed: sensitivityMultiplier = 2.5 (only detects large shifts)

    TopicDetectionConfig interface:
    {
      sensitivityPreset: SensitivityPreset;
      sensitivityMultiplier: number;      // Derived from preset or custom
      manualThreshold: number | null;     // If set, overrides adaptive threshold entirely
      ewmaAlpha: number;                  // Default 0.3
      thresholdBounds: { min: number, max: number };  // Default [0.15, 0.6]
      enabled: boolean;                   // Default true, allows disabling topic detection
    }

    Export function loadTopicDetectionConfig(): TopicDetectionConfig
    - Reads from a JSON config file at a standard location (e.g., .laminark/topic-detection.json)
    - Falls back to defaults if file doesn't exist
    - Validates bounds: min >= 0.05, max <= 0.95, min < max

    Export function applyConfig(config: TopicDetectionConfig, detector: TopicShiftDetector, adaptiveManager: AdaptiveThresholdManager): void
    - If config.manualThreshold is set, call detector.setThreshold(manualThreshold) and skip adaptive updates
    - Otherwise, set adaptiveManager's sensitivityMultiplier and alpha from config
    - If config.enabled is false, set detector threshold to 999 (effectively never triggers)

    Export function sensitivityPresetToMultiplier(preset: SensitivityPreset): number
  </action>
  <verify>Config loads from file with fallback to defaults. Presets map to correct multipliers. Manual override bypasses adaptive. Disabled mode prevents all shifts.</verify>
  <done>Topic detection fully configurable via JSON file. Three sensitivity presets. Manual override option. Enable/disable toggle. Config applied to detector and adaptive manager.</done>
</task>

<task type="auto">
  <name>Task 2: Decision logger with database persistence</name>
  <files>src/intelligence/decision-logger.ts, src/intelligence/__tests__/decision-logger.test.ts, src/storage/migrations/008-decision-log.sql</files>
  <action>
    Create migration 008-decision-log.sql:
    - shift_decisions table: id TEXT PRIMARY KEY, project_id TEXT NOT NULL, session_id TEXT NOT NULL, observation_id TEXT, distance REAL NOT NULL, threshold REAL NOT NULL, ewma_distance REAL, ewma_variance REAL, sensitivity_multiplier REAL, shifted INTEGER NOT NULL (0 or 1), confidence REAL, stash_id TEXT (NULL if not shifted), created_at TEXT NOT NULL DEFAULT (datetime('now'))
    - Index on (project_id, session_id, created_at DESC) for session-level debugging
    - Index on (shifted, created_at DESC) for analyzing shift patterns

    Create TopicShiftDecisionLogger class:

    ShiftDecision interface:
    {
      projectId: string;
      sessionId: string;
      observationId: string | null;
      distance: number;
      threshold: number;
      ewmaDistance: number | null;
      ewmaVariance: number | null;
      sensitivityMultiplier: number;
      shifted: boolean;
      confidence: number;
      stashId: string | null;
    }

    Methods:
    - log(decision: ShiftDecision): Promise of void -- inserts row into shift_decisions
    - getSessionDecisions(projectId: string, sessionId: string, limit?: number): Promise of ShiftDecision[] -- returns decisions for debugging
    - getShiftRate(projectId: string, lastN?: number): Promise of { total: number, shifted: number, rate: number } -- returns shift statistics for tuning

    Write tests:
    - Log a decision and retrieve it
    - Session decisions ordered by recency
    - Shift rate calculation correct (e.g., 3 shifts out of 10 observations = 0.3)
    - All fields persisted correctly including nulls
    - Multiple sessions tracked independently
  </action>
  <verify>`npm test -- --testPathPattern=decision-logger` passes. Decisions persisted with all fields. Shift rate calculation works.</verify>
  <done>Every topic shift decision logged to database with full context. Session-level debugging queries work. Shift rate statistics available for tuning. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 3: Wire config and logging into TopicShiftHandler</name>
  <files>src/hooks/topic-shift-handler.ts</files>
  <action>
    Update the TopicShiftHandler (created in Plan 03) to integrate config and decision logging:

    1. Add to constructor dependencies: { ..., config: TopicDetectionConfig, decisionLogger: TopicShiftDecisionLogger, adaptiveManager?: AdaptiveThresholdManager }

    2. At start of handleObservation():
       - If config.enabled is false, return early { stashed: false, notification: null }
       - If config.manualThreshold is set, ensure detector uses it (call detector.setThreshold(config.manualThreshold))

    3. After detect() call:
       - If adaptiveManager exists and no manual override, call adaptiveManager.update(result.distance) and detector.setThreshold(newThreshold)
       - Call decisionLogger.log({ projectId, sessionId, observationId: observation.id, distance: result.distance, threshold: result.threshold, ewmaDistance: adaptiveManager?.getState().ewmaDistance, ewmaVariance: adaptiveManager?.getState().ewmaVariance, sensitivityMultiplier: config.sensitivityMultiplier, shifted: result.shifted, confidence: result.confidence, stashId: stash?.id or null })

    4. Ensure backward compatibility: adaptiveManager and decisionLogger are optional in constructor. If not provided, skip adaptive updates and skip logging (for simpler test setups and fallback).

    Do NOT break existing tests from Plan 03. The new dependencies are additive and optional.
  </action>
  <verify>Existing Plan 03 tests still pass. New integration with config, adaptive, and logging works when all dependencies provided. Graceful behavior when optional deps omitted.</verify>
  <done>TopicShiftHandler integrates config (enable/disable, manual override), adaptive threshold updates, and decision logging. Backward compatible with Plan 03 tests. Full pipeline: detect -> adapt -> log -> stash.</done>
</task>

</tasks>

<verification>
- Configuration presets (sensitive/balanced/relaxed) produce correct multipliers
- Manual threshold override bypasses adaptive entirely
- Decision logger persists every detection attempt
- Decision log includes all inputs needed for debugging (distance, threshold, EWMA state, shifted, confidence)
- Shift rate statistics computed correctly
- TopicShiftHandler runs full pipeline: config check -> detect -> adapt -> log -> stash
- All Plan 03 tests still pass after handler updates
</verification>

<success_criteria>
- Sensitivity configurable as dial between sensitive and relaxed (INT-08)
- Manual override always available (INT-08)
- All topic shift decisions logged with inputs (DQ-05)
- Session-level debugging queries work
- Full integration: config -> detect -> adapt -> log -> stash -> notify
- All tests pass across the phase
</success_criteria>

<output>
After completion, create `.planning/phases/06-topic-detection-and-context-stashing/06-06-SUMMARY.md`
</output>
