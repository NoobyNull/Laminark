---
phase: 18-replace-anthropic-ai-sdk-with-claude-agent-sdk-for-subscription-based-haiku-calls
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - src/intelligence/__tests__/haiku-client.test.ts
autonomous: true

must_haves:
  truths:
    - "haiku-client tests pass without @anthropic-ai/sdk mocks"
    - "isHaikuEnabled() test confirms always-true behavior"
    - "callHaiku() test confirms Agent SDK session send/stream pattern"
    - "extractJsonFromResponse() tests unchanged and passing"
    - "Session expiration recovery is tested"
  artifacts:
    - path: "src/intelligence/__tests__/haiku-client.test.ts"
      provides: "Test suite for Agent SDK-based haiku-client"
      contains: "unstable_v2_createSession"
  key_links:
    - from: "src/intelligence/__tests__/haiku-client.test.ts"
      to: "@anthropic-ai/claude-agent-sdk"
      via: "vi.mock of the SDK module"
      pattern: "vi.mock.*claude-agent-sdk"
---

<objective>
Rewrite haiku-client tests to mock Agent SDK V2 session instead of @anthropic-ai/sdk Anthropic client. Verify all existing behavior plus session expiration recovery.

Purpose: Tests must validate the new SDK integration. The agent tests (haiku-agents.test.ts) and processor tests (haiku-processor.test.ts) mock callHaiku directly and need NO changes -- only haiku-client.test.ts tests the SDK integration layer.

Output: Passing test suite validating Agent SDK session usage, always-enabled state, and JSON extraction.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/18-replace-anthropic-ai-sdk-with-claude-agent-sdk-for-subscription-based-haiku-calls/18-RESEARCH.md
@.planning/phases/18-replace-anthropic-ai-sdk-with-claude-agent-sdk-for-subscription-based-haiku-calls/18-01-SUMMARY.md
@src/intelligence/haiku-client.ts
@src/intelligence/__tests__/haiku-client.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite haiku-client.test.ts for Agent SDK mocks</name>
  <files>src/intelligence/__tests__/haiku-client.test.ts</files>
  <action>
Rewrite the test file completely. Mock `@anthropic-ai/claude-agent-sdk` module, NOT `@anthropic-ai/sdk`.

**Mock setup:**
```typescript
// Mock the Agent SDK module
const mockSend = vi.fn();
const mockStream = vi.fn();
const mockClose = vi.fn();
const mockCreateSession = vi.fn(() => ({
  send: mockSend,
  stream: mockStream,
  close: mockClose,
}));

vi.mock('@anthropic-ai/claude-agent-sdk', () => ({
  unstable_v2_createSession: mockCreateSession,
}));
```

The `mockStream` should return an async iterable. Create a helper:
```typescript
function createMockStream(messages: Array<{ type: string; subtype?: string; result?: string }>) {
  return async function* () {
    for (const msg of messages) yield msg;
  }();
}
```

**Test groups:**

1. **isHaikuEnabled** (simplified):
   - `it('always returns true')` -- no env var manipulation needed, just call and assert true

2. **callHaiku** (new tests):
   - `it('sends prompt with embedded system instructions to session')` -- call callHaiku('system', 'user'), verify mockSend was called with string containing `<instructions>` and system prompt
   - `it('returns result text from successful stream message')` -- mockStream returns `[{ type: 'result', subtype: 'success', result: 'response text' }]`, assert callHaiku returns 'response text'
   - `it('throws on failed stream message')` -- mockStream returns `[{ type: 'result', subtype: 'error', errors: ['fail'] }]`, assert callHaiku throws
   - `it('reuses session across multiple calls')` -- call callHaiku twice, assert mockCreateSession was called only once
   - `it('creates new session after error (session expiration recovery)')` -- first call: mockSend throws Error. Call resetHaikuClient or let the catch handler null the session. Second call: succeeds. Assert mockCreateSession called twice.
   - `it('returns empty string when no result message in stream')` -- mockStream yields no result messages, assert returns ''

3. **extractJsonFromResponse** (UNCHANGED -- copy all 6 existing tests exactly):
   - bare JSON array
   - markdown-fenced JSON
   - JSON with surrounding text
   - JSON object
   - throws on no JSON
   - JSON array with multiple objects

**beforeEach:** Call `resetHaikuClient()` and reset all mocks (`vi.clearAllMocks()`).

**Remove:** All `process.env.LAMINARK_API_KEY` manipulation, `getHaikuClient` tests, `savedApiKey` state.
  </action>
  <verify>
`npm test -- --run src/intelligence/__tests__/haiku-client.test.ts` passes all tests.
`npm test -- --run` passes the full suite (agent tests and processor tests still pass unchanged).
  </verify>
  <done>All haiku-client tests pass with Agent SDK mocks. Full test suite green. No references to @anthropic-ai/sdk in test files.</done>
</task>

<task type="auto">
  <name>Task 2: Final cleanup and full verification</name>
  <files>package.json</files>
  <action>
1. Run `npm run check` (tsc --noEmit) to verify full type-check passes.
2. Run `npm run build` to verify dist/ builds cleanly.
3. Run `npm test -- --run` to verify ALL tests pass (not just haiku-client).
4. Verify NO references to `@anthropic-ai/sdk` remain anywhere in src/ or test files:
   - `grep -r "@anthropic-ai/sdk" src/` should return nothing (only `@anthropic-ai/claude-agent-sdk` matches)
   - `grep -r "from '@anthropic-ai/sdk'" src/` should return nothing
   - `grep -r "Anthropic" src/intelligence/` should return nothing (the class name is gone)
5. Verify agent files are untouched:
   - `git diff --name-only src/intelligence/haiku-classifier-agent.ts` should be empty
   - `git diff --name-only src/intelligence/haiku-entity-agent.ts` should be empty
   - `git diff --name-only src/intelligence/haiku-relationship-agent.ts` should be empty
   - `git diff --name-only src/intelligence/haiku-processor.ts` should be empty

If any check fails, fix the issue before marking done.
  </action>
  <verify>
`npm run check` exits 0.
`npm run build` exits 0.
`npm test -- --run` exits 0 with all tests passing.
  </verify>
  <done>Full build, type-check, and test suite pass. No @anthropic-ai/sdk references remain. Agent modules unchanged. Migration complete.</done>
</task>

</tasks>

<verification>
1. `npm test -- --run` -- all tests pass
2. `npm run check` -- TypeScript clean
3. `npm run build` -- build succeeds
4. No remaining `@anthropic-ai/sdk` references in source
5. Agent and processor files untouched
</verification>

<success_criteria>
- haiku-client.test.ts mocks Agent SDK V2 session (not Anthropic client)
- All tests pass including session reuse and expiration recovery
- extractJsonFromResponse tests unchanged and passing
- Full test suite green (agent tests, processor tests unmodified)
- Zero @anthropic-ai/sdk references in codebase
</success_criteria>

<output>
After completion, create `.planning/phases/18-replace-anthropic-ai-sdk-with-claude-agent-sdk-for-subscription-based-haiku-calls/18-02-SUMMARY.md`
</output>
