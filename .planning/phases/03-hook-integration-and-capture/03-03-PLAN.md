---
phase: 03-hook-integration-and-capture
plan: 03
type: execute
wave: 2
depends_on: ["03-02"]
files_modified:
  - src/ingest/privacy-filter.ts
  - src/ingest/__tests__/privacy-filter.test.ts
  - src/shared/config.ts
autonomous: true

must_haves:
  truths:
    - "Content matching .env file patterns (KEY=value pairs) is stripped before storage"
    - "API keys, tokens, and secrets matching common patterns are redacted"
    - "Privacy patterns are configurable via memorite config"
    - "Redacted content is replaced with [REDACTED:category] placeholders, not silently dropped"
    - "Privacy filter runs BEFORE admission filter so sensitive content never reaches storage"
  artifacts:
    - path: "src/ingest/privacy-filter.ts"
      provides: "Pattern-based sensitive content redaction"
      exports: ["PrivacyFilter", "PrivacyConfig", "RedactionResult"]
    - path: "src/shared/config.ts"
      provides: "Privacy pattern configuration"
      contains: "privacyPatterns"
  key_links:
    - from: "src/ingest/privacy-filter.ts"
      to: "src/shared/config.ts"
      via: "reads privacy patterns from config"
      pattern: "import.*config|privacyPatterns"
    - from: "src/ingest/privacy-filter.ts"
      to: "src/shared/types.ts"
      via: "imports RawObservation type"
      pattern: "import.*RawObservation.*from.*types"
---

<objective>
Create the privacy filter that prevents sensitive content from being stored in the memory database (DQ-02). This filter redacts API keys, environment variable values, credentials, and other configurable patterns from observations before they reach the admission filter or storage.

Purpose: Memorite captures tool output automatically. Tool output can contain .env file contents, API keys echoed in bash output, or credentials in config files. Without privacy filtering, these end up searchable in the memory database -- a security risk for a tool that persists data across sessions.

Output: A PrivacyFilter module with configurable pattern matching, redaction (not dropping), and integration point in the ingest pipeline before the admission filter.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/ARCHITECTURE.md

Research: "Privacy controls allow excluding sensitive content patterns (like .env file contents) from observation capture"
Feature research: "At minimum: exclude patterns (like .env content), manual forget/delete tool."

Plan 03-02 creates: AdmissionFilter and NoiseDetector. The privacy filter sits BEFORE the admission filter in the pipeline: raw hook payload -> privacy filter (redact) -> normalizer -> admission filter (reject/admit) -> storage.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create privacy filter with configurable pattern redaction</name>
  <files>src/ingest/privacy-filter.ts, src/ingest/__tests__/privacy-filter.test.ts, src/shared/config.ts</files>
  <action>
Create src/ingest/privacy-filter.ts:

Export type RedactionResult = { redacted: boolean, content: string, redactionCount: number, categories: string[] }

Export type PrivacyConfig = {
  patterns: Array<{ name: string, regex: RegExp, category: string }>,
  filePatterns: string[]  // Glob patterns for files to fully exclude (e.g., "**/.env*", "**/credentials*")
}

Export class PrivacyFilter:
- Constructor takes config: PrivacyConfig (with sensible defaults if not provided)
- Method redact(content: string, filePaths?: string[]): RedactionResult
- Method shouldExcludeFile(filePath: string): boolean

Default patterns (built-in, always active):

1. ENV_VARIABLE: Match KEY=value patterns where KEY is all-caps with underscores and value is non-empty. Regex: /\b([A-Z][A-Z0-9_]{2,})=(["']?)([^\s"']{8,})\2/g. Replace value with [REDACTED:env]. Keep the key name visible (knowing STRIPE_KEY exists is fine, its value is not).

2. API_KEY: Match common API key patterns:
   - "sk-" followed by 20+ alphanumeric chars (OpenAI, Stripe secret keys)
   - "pk_" or "sk_" prefixed tokens (Stripe)
   - "ghp_" followed by 36+ chars (GitHub personal tokens)
   - "AKIA" followed by 16+ chars (AWS access keys)
   - Generic: any string of 32+ alphanumeric characters that follows "key", "token", "secret", "password", "apikey", "api_key" (case insensitive)
   Replace with [REDACTED:api_key]

3. JWT_TOKEN: Match "eyJ" followed by base64 chars, typical JWT structure (3 dot-separated base64 segments). Replace with [REDACTED:jwt]

4. CONNECTION_STRING: Match patterns like "postgresql://", "mongodb://", "mysql://", "redis://" followed by credentials. Replace credentials portion with [REDACTED:connection_string]

5. PRIVATE_KEY: Match "-----BEGIN.*PRIVATE KEY-----" blocks. Replace entire block with [REDACTED:private_key]

File exclusion patterns (built-in defaults):
- "**/.env", "**/.env.*", "**/.env.local", "**/.env.production"
- "**/credentials*", "**/secrets*"
- "**/*.pem", "**/*.key"

If shouldExcludeFile returns true for any file in filePaths, the ENTIRE observation is excluded (return empty content with redacted=true and category="excluded_file").

In src/shared/config.ts, add/extend a getPrivacyConfig() function that:
- Reads from a memorite config file if it exists (e.g., .memorite/config.json or memorite.config.json in project root)
- Falls back to built-in defaults
- Allows users to add custom patterns and file exclusions
- Returns PrivacyConfig

Create tests in src/ingest/__tests__/privacy-filter.test.ts:
- Test env variable redaction: "STRIPE_KEY=sk_live_abc123xyz" -> "STRIPE_KEY=[REDACTED:env]"
- Test API key detection: "Bearer sk-proj-abc123..." -> "Bearer [REDACTED:api_key]"
- Test JWT redaction: "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMjM0NTY3ODkwIn0.abc" -> "[REDACTED:jwt]"
- Test connection string: "postgresql://user:pass@host/db" -> "postgresql://[REDACTED:connection_string]"
- Test private key block redaction
- Test file exclusion: observation with filePath ".env.local" should be fully excluded
- Test that non-sensitive content passes through unchanged
- Test that short values (< 8 chars) are NOT redacted (avoid false positives on "X=Y" type content)
- Test custom patterns from config
  </action>
  <verify>
Run: npx vitest run src/ingest/__tests__/privacy-filter.test.ts --reporter=verbose
All tests pass. Sensitive content is redacted with category labels. Non-sensitive content passes through unchanged.
  </verify>
  <done>
PrivacyFilter redacts API keys, env variable values, JWTs, connection strings, and private keys with category-labeled placeholders. File exclusion patterns prevent .env and credential file contents from being stored at all. Patterns are configurable via project config. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate privacy filter into ingest pipeline ordering</name>
  <files>src/ingest/normalizer.ts, src/ingest/__tests__/normalizer.test.ts</files>
  <action>
Update src/ingest/normalizer.ts (created in 03-01) to integrate the privacy filter into the normalization pipeline.

The pipeline order must be:
1. Parse raw JSON payload
2. Privacy filter (redact sensitive content from tool_output and tool_input)
3. Check file exclusion (if observation touches an excluded file, return null)
4. Extract semantic summary (tool_name + first 200 chars of REDACTED output + file paths)
5. Return RawObservation (which later goes through AdmissionFilter from 03-02)

Update normalizeHookPayload to:
- Accept an optional PrivacyFilter instance (dependency injection, defaults to one with default config)
- Call privacyFilter.shouldExcludeFile() on any file paths in the payload -- if excluded, return null
- Call privacyFilter.redact() on the tool output and tool input BEFORE extracting the semantic summary
- The RawObservation.content field should contain the redacted content, never the original sensitive values

Add/update tests in src/ingest/__tests__/normalizer.test.ts:
- Test that a payload containing "STRIPE_KEY=sk_live_..." produces an observation with "[REDACTED:env]" in the content
- Test that a payload touching ".env" file produces null (excluded)
- Test that non-sensitive payloads pass through normally
- Test pipeline order: privacy first, then summary extraction
  </action>
  <verify>
Run: npx vitest run src/ingest/__tests__/normalizer.test.ts --reporter=verbose
Tests confirm: sensitive content is redacted in output observations, .env file observations are excluded, pipeline ordering is correct.
  </verify>
  <done>
Privacy filter is integrated into the normalizer pipeline. Sensitive content is redacted before semantic summary extraction. File exclusion prevents .env and credential file observations from being stored. The pipeline order is: parse -> privacy filter -> extract summary -> return RawObservation.
  </done>
</task>

</tasks>

<verification>
1. npx vitest run src/ingest/ passes all tests (including normalizer integration tests)
2. An observation containing "export OPENAI_API_KEY=sk-proj-abc123..." produces content with "[REDACTED:api_key]"
3. An observation from reading .env.local file returns null (fully excluded)
4. Non-sensitive observations pass through with no modifications
5. Privacy patterns can be extended via config file
</verification>

<success_criteria>
- API keys, env values, JWTs, connection strings, and private keys are redacted with labeled placeholders
- File exclusion patterns prevent .env and credential file observations from storage
- Privacy filter runs before admission filter in the pipeline
- Patterns are configurable via project config
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-hook-integration-and-capture/03-03-SUMMARY.md`
</output>
