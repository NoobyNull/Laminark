---
phase: 03-hook-integration-and-capture
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/hooks/admission-filter.ts
  - src/hooks/noise-patterns.ts
  - src/hooks/privacy-filter.ts
  - src/hooks/__tests__/admission-filter.test.ts
  - src/hooks/__tests__/privacy-filter.test.ts
autonomous: true

must_haves:
  truths:
    - "Build output lines (npm WARN, webpack compiled, tsc errors) are rejected by the admission filter"
    - "Write and Edit tool observations are never rejected based on content patterns alone"
    - "Bash tool observations with noise patterns (npm install output, linter spam) are rejected"
    - "Short or empty observations are rejected"
    - "API keys (sk-*, ghp_*, AKIA*) are replaced with [REDACTED:api_key]"
    - "JWT tokens are replaced with [REDACTED:jwt]"
    - "Connection strings have credentials redacted"
    - "Private keys are fully redacted"
    - "Env variable values (KEY=secret) are replaced with KEY=[REDACTED:env]"
    - "Observations touching .env files are fully excluded (return null)"
    - "Users can extend privacy patterns via ~/.laminark/config.json privacy section"
  artifacts:
    - path: "src/hooks/admission-filter.ts"
      provides: "shouldAdmit(toolName, content) -> boolean decision with noise detection"
      exports: ["shouldAdmit"]
      min_lines: 40
    - path: "src/hooks/noise-patterns.ts"
      provides: "Noise pattern definitions by category (BUILD_OUTPUT, PACKAGE_INSTALL, LINTER_WARNING, EMPTY_OUTPUT)"
      exports: ["NOISE_PATTERNS", "isNoise"]
      min_lines: 30
    - path: "src/hooks/privacy-filter.ts"
      provides: "redactSensitiveContent(text, filePath?) -> string|null with configurable patterns"
      exports: ["redactSensitiveContent", "isExcludedFile"]
      min_lines: 60
  key_links:
    - from: "src/hooks/admission-filter.ts"
      to: "src/hooks/noise-patterns.ts"
      via: "imports noise pattern definitions"
      pattern: "import.*noise-patterns"
    - from: "src/hooks/privacy-filter.ts"
      to: "src/shared/config.ts"
      via: "reads user privacy config from ~/.laminark/config.json"
      pattern: "getConfigDir|config\\.json"
---

<objective>
Implement the admission filter (noise detection) and privacy filter (sensitive content redaction) as pure logic modules with TDD, ensuring low-signal noise never reaches the database and sensitive content is always redacted before storage.

Purpose: These are the quality gatekeepers of the observation pipeline. The admission filter prevents the database from filling with noise (build output, linter spam, package install logs). The privacy filter ensures API keys, JWT tokens, connection strings, and other secrets are never stored in plaintext. Both are pure functions with well-defined I/O -- ideal TDD candidates.

Output: Two production modules and two comprehensive test suites proving every noise category and privacy pattern works correctly.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-hook-integration-and-capture/03-RESEARCH.md

# Config for privacy settings
@src/shared/config.ts
@src/shared/debug.ts
</context>

<tasks>

<feature>
  <name>Admission Filter with Noise Detection</name>
  <files>src/hooks/admission-filter.ts, src/hooks/noise-patterns.ts, src/hooks/__tests__/admission-filter.test.ts</files>
  <behavior>
    shouldAdmit(toolName: string, content: string) -> boolean

    The admission filter decides whether an observation is worth storing.

    Cases:
    - shouldAdmit('Write', '[Write] Created src/index.ts\nimport ...') -> true (Write tool always admitted regardless of content)
    - shouldAdmit('Edit', '[Edit] Modified src/foo.ts: ...') -> true (Edit tool always admitted)
    - shouldAdmit('Bash', '[Bash] $ npm test\nnpm WARN deprecated...') -> false (BUILD_OUTPUT noise)
    - shouldAdmit('Bash', '[Bash] $ npm install\nadded 42 packages...') -> false (PACKAGE_INSTALL noise)
    - shouldAdmit('Bash', '[Bash] $ git commit -m "feat: add auth"') -> true (meaningful command)
    - shouldAdmit('Bash', '') -> false (EMPTY_OUTPUT)
    - shouldAdmit('Bash', 'OK') -> false (EMPTY_OUTPUT)
    - shouldAdmit('Read', '[Read] src/config.ts') -> true (file reads are low-signal but admitted; volume managed elsewhere)
    - shouldAdmit('Bash', '[Bash] $ eslint .\n42 problems (10 errors, 32 warnings)\n...warning: ...warning: ...warning:') -> false (LINTER_WARNING)
    - shouldAdmit('Bash', '[Bash] $ cat package.json\n{"name": ...very long output...}') -> depends on length (content over 5000 chars with no decision/error indicators -> reject)

    Noise pattern categories:
    - BUILD_OUTPUT: npm WARN, npm ERR, Successfully compiled, webpack compiled, Build completed, tsc error TS, Module not found
    - PACKAGE_INSTALL: added N packages, npm install, up to date, removed N packages, audited N packages
    - LINTER_WARNING: eslint, prettier, N problems, consecutive warning: lines
    - EMPTY_OUTPUT: empty, whitespace-only, "OK", "Success", "Done", "undefined", "null"

    Critical rule (per research pitfall #3): Write and Edit tools are NEVER rejected by content pattern matching. Tool type is the primary signal. Content patterns only apply to Bash/Read output.
  </behavior>
  <implementation>
Create `src/hooks/noise-patterns.ts` with:
- NOISE_PATTERNS object mapping category names to arrays of RegExp
- `isNoise(content: string): { isNoise: boolean; category?: string }` function that checks content against all patterns
- Each pattern category has a descriptive name for debug logging

Create `src/hooks/admission-filter.ts` with:
- `shouldAdmit(toolName: string, content: string): boolean` as the main export
- HIGH_SIGNAL_TOOLS constant: `['Write', 'Edit']` -- these always pass regardless of content
- For non-high-signal tools: check content against noise patterns, reject if match found
- Reject empty/whitespace-only content for all tool types
- Log rejections via debug('hook', 'Observation rejected', { tool, reason })
  </implementation>
</feature>

<feature>
  <name>Privacy Filter with Configurable Patterns</name>
  <files>src/hooks/privacy-filter.ts, src/hooks/__tests__/privacy-filter.test.ts</files>
  <behavior>
    redactSensitiveContent(text: string, filePath?: string) -> string | null
    isExcludedFile(filePath: string) -> boolean

    The privacy filter redacts sensitive content before storage and fully excludes observations from sensitive files.

    Cases -- file exclusion:
    - isExcludedFile('.env') -> true
    - isExcludedFile('.env.local') -> true
    - isExcludedFile('.env.production') -> true
    - isExcludedFile('credentials.json') -> true
    - isExcludedFile('secrets.yaml') -> true
    - isExcludedFile('server.pem') -> true
    - isExcludedFile('id_rsa') -> true
    - isExcludedFile('src/config.ts') -> false
    - isExcludedFile('package.json') -> false

    Cases -- content redaction:
    - redactSensitiveContent('API_KEY=sk-abc123defg456hijklmnop789') -> 'API_KEY=[REDACTED:env]' (env var with 8+ char value)
    - redactSensitiveContent('token: sk-abcdefghijklmnopqrstuvwxyz') -> 'token: [REDACTED:api_key]' (OpenAI key)
    - redactSensitiveContent('ghp_1234567890abcdefghijklmnopqrstuvwxyz') -> '[REDACTED:api_key]' (GitHub PAT)
    - redactSensitiveContent('AKIAIOSFODNN7EXAMPLE') -> '[REDACTED:api_key]' (AWS access key)
    - redactSensitiveContent('eyJhbG.eyJzdW.signature') -> '[REDACTED:jwt]' (JWT token)
    - redactSensitiveContent('postgresql://user:pass@host/db') -> 'postgresql://[REDACTED:connection_string]'
    - redactSensitiveContent('-----BEGIN RSA PRIVATE KEY-----\nMII...\n-----END RSA PRIVATE KEY-----') -> '[REDACTED:private_key]'
    - redactSensitiveContent('const x = 42;') -> 'const x = 42;' (no sensitive content, returned as-is)

    Cases -- file path triggers null return:
    - redactSensitiveContent('[Write] Created .env\nSECRET=abc', '.env') -> null (excluded file)
    - redactSensitiveContent('[Read] credentials.json', 'credentials.json') -> null

    Cases -- user config extension:
    - If ~/.laminark/config.json has `{ "privacy": { "additionalPatterns": [{ "regex": "CUSTOM_\\w+", "replacement": "[REDACTED:custom]" }] } }`, those patterns are also applied
  </behavior>
  <implementation>
Create `src/hooks/privacy-filter.ts` with:

1. DEFAULT_PRIVACY_PATTERNS array with objects: `{ name, regex, replacement, category }` for:
   - env_variable: `\b([A-Z][A-Z0-9_]{2,})=(["']?)([^\s"']{8,})\2` -> `$1=[REDACTED:env]`
   - api_key_openai: `sk-[a-zA-Z0-9]{20,}` -> `[REDACTED:api_key]`
   - api_key_github: `ghp_[a-zA-Z0-9]{36,}` -> `[REDACTED:api_key]`
   - aws_access_key: `AKIA[A-Z0-9]{12,}` -> `[REDACTED:api_key]`
   - jwt_token: `eyJ[A-Za-z0-9_-]+\.eyJ[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+` -> `[REDACTED:jwt]`
   - connection_string: `(postgresql|mongodb|mysql|redis):\/\/[^\s]+` -> `$1://[REDACTED:connection_string]`
   - private_key: `-----BEGIN[A-Z ]*PRIVATE KEY-----[\s\S]*?-----END[A-Z ]*PRIVATE KEY-----` -> `[REDACTED:private_key]`

2. DEFAULT_EXCLUDED_FILE_PATTERNS array of RegExp for: `.env`, `credentials`, `secrets`, `.pem`, `.key`, `id_rsa`

3. `loadUserPrivacyPatterns(): PrivacyPattern[]` that reads `~/.laminark/config.json` privacy section and merges with defaults. Cache the result (patterns don't change at runtime). Use try/catch -- missing/invalid config is fine.

4. `isExcludedFile(filePath: string): boolean` checks against excluded file patterns (default + user-configured).

5. `redactSensitiveContent(text: string, filePath?: string): string | null`:
   - If filePath provided and isExcludedFile(filePath) -> return null
   - Apply all privacy patterns (default + user) sequentially to text
   - Log redaction events via debug('privacy', 'Content redacted', { patterns: [...matched pattern names] })
   - Return redacted text (or original if no patterns matched)
  </implementation>
</feature>

</tasks>

<verification>
1. `npm test` passes -- all admission filter and privacy filter tests pass
2. `npm run check` passes with no type errors
3. Admission filter correctly admits Write/Edit regardless of content
4. Admission filter rejects noise from Bash output (build logs, package install, linter spam)
5. Privacy filter redacts all secret pattern types
6. Privacy filter returns null for excluded files
7. All existing Phase 1 tests still pass
</verification>

<success_criteria>
- Admission filter has tests for every noise category (BUILD_OUTPUT, PACKAGE_INSTALL, LINTER_WARNING, EMPTY_OUTPUT)
- Admission filter never rejects Write/Edit observations based on content
- Privacy filter has tests for every secret pattern (env vars, API keys, JWTs, connection strings, private keys)
- Privacy filter returns null for excluded files (.env, credentials, secrets, .pem, .key, id_rsa)
- Privacy filter supports user-configured additional patterns
- RED-GREEN-REFACTOR commits produced
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-hook-integration-and-capture/03-02-SUMMARY.md`
</output>
