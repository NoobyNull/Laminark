---
phase: 19-path-detection-and-storage
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/intelligence/haiku-classifier-agent.ts
autonomous: true

must_haves:
  truths:
    - "Haiku classifier returns debug signal data alongside existing classification"
    - "No additional Haiku API call is made for debug detection"
    - "Debug signals include error detection, resolution detection, and waypoint type hints"
  artifacts:
    - path: "src/intelligence/haiku-classifier-agent.ts"
      provides: "Extended classifier with debug_signal field in output"
      exports: ["classifyWithHaiku", "ClassificationResult"]
  key_links:
    - from: "src/intelligence/haiku-classifier-agent.ts"
      to: "src/intelligence/haiku-client.ts"
      via: "callHaiku() single call with extended prompt"
      pattern: "callHaiku"
---

<objective>
Extend the existing Haiku classifier to detect debug signals in the same API call that classifies observations.

Purpose: PATH-01 requires automatic debug session detection from error/failure patterns. Per locked decision: extend existing classifier prompt, do NOT add a separate Haiku call (prevents API volume explosion). The classifier already runs for every observation — we piggyback debug signal detection onto it.

Output: Modified haiku-classifier-agent.ts with debug_signal field in classification output.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/intelligence/haiku-classifier-agent.ts
@src/intelligence/haiku-client.ts
@src/intelligence/haiku-processor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend classifier prompt and schema for debug signals</name>
  <files>src/intelligence/haiku-classifier-agent.ts</files>
  <action>
Modify `src/intelligence/haiku-classifier-agent.ts` to add debug signal detection to the existing Haiku call. This is a single-file change.

**1. Extend the Zod schema:**

Add a `debug_signal` object field to ClassificationSchema (nullable — null for noise observations):

```typescript
const DebugSignalSchema = z.object({
  is_error: z.boolean(),           // Observation contains an error/failure
  is_resolution: z.boolean(),      // Observation indicates a fix/resolution
  waypoint_hint: z.enum([
    'error', 'attempt', 'failure', 'success',
    'pivot', 'revert', 'discovery', 'resolution',
  ]).nullable(),                   // Suggested waypoint type if part of debug flow
  confidence: z.number(),          // 0.0-1.0 confidence in debug relevance
}).nullable();

const ClassificationSchema = z.object({
  signal: z.enum(['noise', 'signal']),
  classification: z.enum(['discovery', 'problem', 'solution']).nullable(),
  reason: z.string(),
  debug_signal: DebugSignalSchema,  // NEW
});
```

**2. Update ClassificationResult type:**

Add `debug_signal` field:
```typescript
export type DebugSignal = {
  is_error: boolean;
  is_resolution: boolean;
  waypoint_hint: 'error' | 'attempt' | 'failure' | 'success' | 'pivot' | 'revert' | 'discovery' | 'resolution' | null;
  confidence: number;
};

export type ClassificationResult = {
  signal: 'noise' | 'signal';
  classification: ObservationClassification | null;
  reason: string;
  debug_signal: DebugSignal | null;  // NEW
};
```

**3. Extend SYSTEM_PROMPT:**

Add to the existing system prompt (append, do not replace):

```
3. debug_signal (always, even for noise): Is this related to debugging?
   - is_error: Does this contain an error message, test failure, build failure, or exception?
   - is_resolution: Does this indicate a successful fix, passing test, or resolved error?
   - waypoint_hint: If debug-related, what type? "error" (hit an error), "attempt" (trying a fix), "failure" (fix didn't work), "success" (something passed), "pivot" (changing approach), "revert" (undoing a change), "discovery" (learned something), "resolution" (final fix). null if not debug-related.
   - confidence: 0.0-1.0 how confident this is debug activity

Return JSON: {"signal": "noise"|"signal", "classification": "discovery"|"problem"|"solution"|null, "reason": "brief", "debug_signal": {"is_error": bool, "is_resolution": bool, "waypoint_hint": "type"|null, "confidence": 0.0-1.0}|null}
```

Remove the old "Return JSON" line and replace with the updated one. Keep all existing classification instructions intact.

**4. Update the return in classifyWithHaiku:**

The Zod parse already handles the extended schema. Ensure the return type matches the new ClassificationResult.

IMPORTANT: Do NOT change the function signature or add new Haiku calls. The `callHaiku(SYSTEM_PROMPT, userContent, 256)` call stays as-is — only the prompt content and response parsing change. Bump maxTokens to 512 since the response is now larger.

For backward compatibility: if Haiku returns without debug_signal (edge case during transition), default to null. Add `.catch` on the debug_signal Zod parse or use `.default(null)` on the schema field.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no type errors. Verify the SYSTEM_PROMPT still contains the original noise/signal instructions by grepping for "noise" in the file.</verify>
  <done>classifyWithHaiku returns ClassificationResult with debug_signal field. Single Haiku call (no new API calls). Backward-compatible (debug_signal defaults to null if missing from response).</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `classifyWithHaiku` still makes exactly one `callHaiku()` call (grep confirms single callHaiku invocation)
- ClassificationResult type includes debug_signal field
- SYSTEM_PROMPT includes debug signal instructions alongside existing noise/signal/classification instructions
- DebugSignal type exported for use by PathTracker in Plan 03
</verification>

<success_criteria>
- Haiku classifier produces debug_signal data without additional API calls
- is_error and is_resolution booleans enable PathTracker state machine transitions
- waypoint_hint enables automatic waypoint type assignment
- Backward compatible: null debug_signal if Haiku response is missing the field
</success_criteria>

<output>
After completion, create `.planning/phases/19-path-detection-and-storage/19-02-SUMMARY.md`
</output>
