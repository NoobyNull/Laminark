---
phase: 02-mcp-interface-and-search
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/storage/migrations.ts
  - src/shared/types.ts
  - src/mcp/server.ts
  - src/mcp/tools/save-memory.ts
  - src/mcp/token-budget.ts
  - src/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "MCP server starts via stdio transport without crashing"
    - "save_memory tool persists text as a new observation with optional title"
    - "Auto-generated title is derived from content when title not provided"
    - "Title column exists in observations schema and is indexed by FTS5"
  artifacts:
    - path: "src/mcp/server.ts"
      provides: "McpServer creation with registerTool, stdio transport connection"
      exports: ["createServer", "startServer"]
    - path: "src/mcp/tools/save-memory.ts"
      provides: "save_memory tool registration"
      exports: ["registerSaveMemory"]
    - path: "src/mcp/token-budget.ts"
      provides: "Token estimation and budget enforcement utility"
      exports: ["estimateTokens", "enforceTokenBudget"]
    - path: "src/storage/migrations.ts"
      provides: "Migration 005 adding title column and rebuilding FTS5"
      contains: "add_observation_title"
  key_links:
    - from: "src/mcp/tools/save-memory.ts"
      to: "src/storage/observations.ts"
      via: "ObservationRepository.create()"
      pattern: "obsRepo\\.create"
    - from: "src/mcp/server.ts"
      to: "@modelcontextprotocol/sdk"
      via: "McpServer + StdioServerTransport"
      pattern: "McpServer|StdioServerTransport"
    - from: "src/index.ts"
      to: "src/mcp/server.ts"
      via: "MCP server startup in entry point"
      pattern: "startServer|createServer"
---

<objective>
Schema migration for title column, MCP server scaffold with stdio transport, save_memory tool, and token budget utility.

Purpose: Establishes the MCP server foundation and the first tool (save_memory) so Claude can persist memories. The title column migration is prerequisite for save_memory's optional title parameter (locked user decision).

Output: Running MCP server with save_memory tool callable via stdio, title column in observations schema, token budget utility for downstream use.
</objective>

<execution_context>
@/home/matthew/.claude/get-shit-done/workflows/execute-plan.md
@/home/matthew/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-mcp-interface-and-search/02-CONTEXT.md
@.planning/phases/02-mcp-interface-and-search/02-RESEARCH.md
@.planning/phases/01-storage-engine/01-03-SUMMARY.md
@src/storage/migrations.ts
@src/storage/observations.ts
@src/storage/search.ts
@src/shared/types.ts
@src/shared/config.ts
@src/shared/debug.ts
@src/index.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add title column migration and MCP types</name>
  <files>
    src/storage/migrations.ts
    src/shared/types.ts
    src/mcp/token-budget.ts
    package.json
  </files>
  <action>
1. Install @modelcontextprotocol/sdk: `npm install @modelcontextprotocol/sdk`

2. Add migration 005 to MIGRATIONS array in `src/storage/migrations.ts`:
   - ALTER TABLE observations ADD COLUMN title TEXT
   - DROP the 3 FTS5 sync triggers (observations_ai, observations_au, observations_ad)
   - DROP TABLE observations_fts
   - CREATE VIRTUAL TABLE observations_fts USING fts5(title, content, content='observations', content_rowid='rowid', tokenize='porter unicode61')
   - Recreate all 3 sync triggers to include title column in INSERT/UPDATE/DELETE operations
   - INSERT INTO observations_fts(observations_fts) VALUES('rebuild') to re-index existing data
   - See 02-RESEARCH.md Pattern 4 for exact SQL

3. Update `src/shared/types.ts`:
   - Add `title: z.string().nullable()` to ObservationRowSchema (after `content`)
   - Add `title: string | null` to Observation interface (after `content`)
   - Add `title: z.string().max(200).nullable().default(null)` to ObservationInsertSchema
   - Update `rowToObservation()` to map `row.title` to `title`

4. Create `src/mcp/token-budget.ts`:
   - Export `TOKEN_BUDGET = 2000` constant
   - Export `estimateTokens(text: string): number` -- returns `Math.ceil(text.length / 4)`
   - Export `enforceTokenBudget<T>(results: T[], formatResult: (item: T) => string, budget?: number): { items: T[]; truncated: boolean; tokenEstimate: number }`
   - Reserve 100 tokens for metadata envelope
   - Iterate results, accumulate token count, stop when budget exceeded (always include at least 1 result)
   - See 02-RESEARCH.md Pattern 3 for implementation reference

IMPORTANT: Do NOT use console.log anywhere -- use debug() from src/shared/debug.ts for stderr logging. stdout must stay clean for MCP protocol.
  </action>
  <verify>
    Run `npm run check` (TypeScript compilation succeeds).
    Run `npm test` (existing 78 tests still pass -- migration is backward-compatible since title defaults to NULL).
    Verify migration 005 exists in MIGRATIONS array with version 5.
    Verify ObservationInsertSchema accepts optional title field.
  </verify>
  <done>
    Migration 005 adds title column to observations and rebuilds FTS5 to index both title and content.
    ObservationInsert type accepts optional title.
    Token budget utility exports estimateTokens and enforceTokenBudget.
    All existing tests pass (no regressions).
    @modelcontextprotocol/sdk installed as dependency.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MCP server scaffold and save_memory tool</name>
  <files>
    src/mcp/server.ts
    src/mcp/tools/save-memory.ts
    src/index.ts
  </files>
  <action>
1. Create `src/mcp/server.ts`:
   - Import McpServer from '@modelcontextprotocol/sdk/server/mcp.js'
   - Import StdioServerTransport from '@modelcontextprotocol/sdk/server/stdio.js'
   - Import openDatabase, getDatabaseConfig, getProjectHash from storage
   - Import debug from shared/debug
   - Export `createServer(db, projectHash)` function that:
     - Creates McpServer with name 'laminark', version '0.1.0'
     - Sets capabilities: { tools: { listChanged: true } }
     - Sets instructions describing Laminark's purpose (help Claude understand when to use tools)
     - Returns the server instance
   - Export `startServer()` async function that:
     - Opens database via getDatabaseConfig()
     - Gets projectHash via getProjectHash(process.cwd())
     - Creates server via createServer()
     - Calls tool registration functions (registerSaveMemory, and later registerRecall)
     - Creates StdioServerTransport and connects server
     - Registers SIGINT handler to close database and exit
     - Registers uncaughtException handler to log error, close db, exit(1)
     - All logging via debug('mcp', ...) to stderr, NEVER console.log

2. Create `src/mcp/tools/save-memory.ts`:
   - Export `registerSaveMemory(server, db, projectHash)` function
   - Use `server.registerTool('save_memory', config, callback)` (NOT deprecated server.tool())
   - Tool config:
     - title: 'Save Memory'
     - description: 'Persist a new memory observation. Provide text content and an optional title.'
     - inputSchema with Zod:
       - text: z.string().min(1).max(10000).describe('The text content to save as a memory')
       - title: z.string().max(200).optional().describe('Optional title (auto-generated from text if omitted)')
       - source: z.string().default('manual').describe('Source identifier for the memory')
   - Callback implementation:
     - Auto-generate title if not provided: extract first sentence (up to 100 chars) or first 80 chars + ellipsis
     - Create ObservationRepository with db and projectHash
     - Call obsRepo.create({ content: args.text, title: generatedTitle, source: args.source })
     - Return CallToolResult: { content: [{ type: 'text', text: `Saved memory "${title}" (id: ${obs.id})` }] }
     - On error: return { content: [{ type: 'text', text: `Failed to save memory: ${error.message}` }], isError: true }
   - Export `generateTitle(content: string): string` helper function for title generation

3. Update `src/index.ts`:
   - Replace current placeholder content
   - Add shebang: #!/usr/bin/env node
   - Import { startServer } from './mcp/server.js'
   - Call startServer() with .catch() for fatal error handling
   - Keep re-exports of storage API for library usage: export * from './storage/index.js'

IMPORTANT: Tool handlers are async (required by MCP SDK) but internally use sync better-sqlite3 calls. This is correct and intentional -- no Promise wrapping needed for db operations.
  </action>
  <verify>
    Run `npm run check` (TypeScript compilation succeeds with MCP SDK types).
    Run `npm test` (all tests still pass).
    Run `npx tsx src/index.ts` and verify it starts without error (will wait for MCP protocol input on stdin -- kill after 2 seconds to confirm startup). Check stderr for any debug output, confirm stdout has no stray output.
    Verify save_memory tool is registered by checking the server creation code path.
  </verify>
  <done>
    MCP server starts via stdio transport with no stdout pollution.
    save_memory tool is registered with registerTool() accepting text, optional title, and source.
    Auto-title generation produces a title from content when none provided.
    src/index.ts is the entry point that starts the MCP server.
    Database is opened and repositories are available to tool handlers.
  </done>
</task>

</tasks>

<verification>
- `npm run check` passes with no type errors
- `npm test` passes (all existing tests + no regressions from migration 005)
- `npx tsx src/index.ts` starts MCP server process (exits cleanly on SIGINT)
- No console.log calls anywhere in src/mcp/ (grep check)
- Migration 005 exists and title column is present in schema
</verification>

<success_criteria>
- MCP server scaffold exists and starts via stdio
- save_memory tool is registered and callable (creates observation with title)
- Migration 005 adds title column and rebuilds FTS5 for title+content indexing
- Token budget utility ready for Plan 02 consumption
- All 78+ existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-mcp-interface-and-search/02-01-SUMMARY.md`
</output>
