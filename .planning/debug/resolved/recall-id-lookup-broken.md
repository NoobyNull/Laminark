---
status: resolved
trigger: "recall id and ids parameters do not resolve observation IDs returned by search results"
created: 2026-02-17T00:00:00Z
updated: 2026-02-17T00:10:00Z
---

## Current Focus

hypothesis: CONFIRMED - 8-char display IDs were never matched against full 32-char stored IDs.
test: Added prefix-match resolution in ObservationRepository, all 28 repo tests pass.
expecting: N/A - fix applied and verified.
next_action: archive

## Symptoms

expected: recall(action="purge", id="d79fb218") finds and purges the observation with that ID prefix.
actual: Returns "No memories found matching 'd79fb218'. Try broader search terms or check the ID."
errors: Error message treats id parameter as a search query - because no exact match found.
reproduction: 1) Run recall search to get IDs shown as 8-char hex. 2) Use those IDs with id= or ids= parameter. 3) All fail.
started: Unclear - may never have worked correctly.

## Eliminated

- hypothesis: Wrong project_hash scoping
  evidence: The repo is correctly scoped with projectHash. Issue is ID length mismatch, not scope.
  timestamp: 2026-02-17T00:03:00Z

## Evidence

- timestamp: 2026-02-17T00:01:00Z
  checked: /data/Laminark/src/mcp/tools/recall.ts
  found: shortId() function returns `id.slice(0, 8)` - only first 8 chars displayed to user
  implication: Users see and copy 8-char IDs but full IDs are 32 chars

- timestamp: 2026-02-17T00:02:00Z
  checked: /data/Laminark/src/storage/observations.ts
  found: stmtGetById uses `WHERE id = ?` - exact match only
  implication: 8-char prefix passed as id will never match a 32-char stored ID

- timestamp: 2026-02-17T00:02:30Z
  checked: /data/Laminark/src/storage/migrations.ts
  found: ID column is `TEXT NOT NULL UNIQUE DEFAULT (lower(hex(randomblob(16))))` - 32 chars
  found2: TS code generates IDs via `randomBytes(16).toString('hex')` - also 32 chars
  implication: Confirms full IDs are 32 hex chars; 8-char prefix is display-only shorthand

- timestamp: 2026-02-17T00:08:00Z
  checked: TypeScript compilation after fix
  found: No new errors introduced (2 pre-existing errors unrelated to this change)
  implication: Fix is type-safe

- timestamp: 2026-02-17T00:09:00Z
  checked: vitest run on repositories.test.ts
  found: All 28 tests pass
  implication: Fix doesn't break existing behavior

## Resolution

root_cause: The `shortId()` helper in recall.ts truncates observation IDs to 8 characters for display purposes (e.g. "d79fb218"), but all four repository methods used for ID-based lookups (`getById`, `getByIdIncludingDeleted`, `softDelete`, `restore`) used exact `WHERE id = ?` SQL matching. Observation IDs are 32-char hex strings generated by `randomBytes(16).toString('hex')`. When users copied an 8-char display ID and passed it back via `id=` or `ids=` parameters, the exact match found nothing, causing the "No memories found" error every time.

fix: Added a private `resolveId(id: string): string | null` method to ObservationRepository that:
  1. Returns the ID unchanged if it's already 32 chars (full ID, fast path)
  2. For shorter inputs, runs a LIKE prefix query: `WHERE id LIKE 'prefix%'`
  3. Returns the unique match, or null if ambiguous or not found
  Updated getById, softDelete, and restore to call resolveId() before the prepared statement.
  Updated getByIdIncludingDeleted with equivalent inline prefix logic (needed to search across deleted items too).

verification: TypeScript type check passes (no new errors). All 28 existing repository tests pass. Code path traced manually - 8-char prefix "d79fb218" now resolves to the full 32-char ID before any SQL lookup.

files_changed:
  - /data/Laminark/src/storage/observations.ts
